<%@ LANGUAGE=VBScript %>
<%'Copyright 1998-2001 CambridgeSoft Corporation All Rights Reserved
'DO NOT EDIT THIS FILE
'-------------------------------------------------------------------------------
' 'the action page contains the actions for security features for oracle based applications
'-------------------------------------------------------------------------------%>

<!--#INCLUDE FILE = "../../source/app_vbs.asp"-->
<!--#INCLUDE FILE = "../../cs_security/admin_utils_vbs.asp"-->
<!--#INCLUDE FILE = "../../cs_security/admin_utils_js.js"-->
<!--#INCLUDE VIRTUAL = "/cfserverasp/source/cows_func_vbs.asp" -->
<%'on error resume next
strDataAction = LCase(Request.QueryString("dataaction"))
dbkey = request("dbname")
formgroup = Request("formgroup")
formgroupflag= GetFormGroupVal(dbkey, formgroup, kFormGroupFlag)

'------------------
' action handler
'------------------
Select Case strDataAction
	Case "add_role"
		Response.Write "Adding role..."
		SetSessionVars dbkey, formgroup, "add_record"
		'GetSearchData dbkey, formgroup
		table_names=Request("Add_Order")
		AddType = "CASCADE"
		field_names= "Security_Roles.Privilege_Table_Int_ID" & "," &  Request("RelationalSearchFields")
		'SYAN changed on 2/6/2002
		if request("roleExisting") <> "true" then 'only create role when it is not an existing role
			isOK=DoProcessRole(dbkey, formgroup,field_names, "", "", "ADD")
		end if
		if isOK = "" then
			isOK=DoAddRoleRecord(dbkey, formgroup, table_names, field_names, AddType)	
			if isOK <> "" then
				theReturn=Session("errors_found" & dbkey & formgroup)
			else
				theReturn="Role added"
			end if
		else
			theReturn=Session("errors_found" & dbkey & formgroup)
		end if
		if inStr(theReturn, "error")> 0 then
			showmessagedialog(theReturn)
		else
			Response.Write "<br>" & theReturn
		end if
		ReturnEditResults dbkey, formgroup, "ADD_RECORD", dbkey 
	Case "add_existing_role"
		Response.Write "Adding role to cs_security..."
		SetSessionVars dbkey, formgroup, "add_record"
		role_name = request("role_name")
		role_name = UCase(role_name)
		
		if Len(role_name)> 0  then
			isOK=DoAddRoleRecord(dbkey, formgroup, "", "", "")	
		else
			isOK="No role name was entered"
		end if
		if isOK <> "" then
			theReturn=isOK
		end if
		theCaller = request("thecaller")
		
		if Not isOK <> "" then
			if theCaller = "NEW_USER" then
				%>
				<script language="javascript">
					var w = ""
					if (w.name == null){
						w = window.open("/<%=Application("Appkey")%>/cs_security/manage_security/add_existing_role.asp?dbname=<%=dbkey%>","add_role", "toolbar=0,status=0,menubar=0,scrollbars=0,resizable=0,width=400,height=100")
						var theopener = w.opener
						
						w.focus()
					}else{
						var theopener = w.opener
						w.focus()
					}
					
					theopener.AddItemToList("user_manager", "<%=role_name%>")
					w.close()
				</script>
			<%else
			%>
				<script language="javascript">
					var w = ""
					if (w.name == null){
						w = window.open("/<%=Application("Appkey")%>/cs_security/manage_security/add_existing_role.asp?dbname=<%=dbkey%>","add_role", "toolbar=0,status=0,menubar=0,scrollbars=0,resizable=0,width=400,height=100")
						var theopener = w.opener
						
						w.focus()
					}else{
						var theopener = w.opener
						w.focus()
					}
					
					theopener.w_avail_list=theopener.addToList("<%=role_name%>", theopener.w_avail_list)
					theopener.fill_lists()
					w.close()
				</script>
			<%end if%>
		
		<%else
		showMessageDialog(theReturn)%>
			<script language="javascript">
					var w = ""
					if (w.name == null){
						w = window.open("/<%=Application("Appkey")%>/cs_security/manage_security/add_existing_role.asp?dbname=<%=dbkey%>","add_role", "toolbar=0,status=0,menubar=0,scrollbars=0,resizable=0,width=400,height=100")
						w.focus()
					}else{
						w.focus()
					}
					w.close()
				</script>
		
		<%end if
		
	Case "delete_role"
		Response.Write "Deleting Role..."
		SetSessionVars dbkey, formgroup, "add_record"	
		temp_str = Request("ROW_ID_TABLE_NAMES")
		delete_order = Request("table_delete_order")
		isOK = DoProcessRole(dbkey, formgroup,"", "", "", "DELETE")	
		isOK = DoDeleteRecordMaster(dbkey, formgroup, delete_order, delete_order)
		if Session("errors_found" & dbkey & formgroup) <> "" then
			theReturn=Session("errors_found" & dbkey & formgroup)
		else			
			theReturn="Role " & request("role_name") & " Deleted"
		end if
		showmessagedialog(theReturn)
		ReturnEditResults dbkey, formgroup, "DELETE_RECORD", dbkey 
	Case "update_role"
		PrivTable = Application("PRIV_TABLE_NAME")
		Response.Write "Updating role..."
		SetSessionVars dbkey, formgroup, "update_record"
		RelFields = Request("RelationalSearchFields")
		
		temp = Request("ROW_ID_TABLE_NAMES")
		table_name_array = split(temp, ",", -1)
			for i = 0 to UBound(table_name_array)
		
				table_name = table_name_array(i)	
				tables_row_IDs = request(table_name & "_ROW_IDS")
				tables_row_IDs_array = split(tables_row_IDs, ",", -1)
				for j = 0 to UBound(tables_row_IDs_array)
					row_ID = tables_row_IDs_array(j)
					'get all submitted data fields for this table and row_ID
					if UCase(table_name) = UCase(PrivTable) then
						'update Oracle user tables
						isOK = DoProcessRole(dbkey, formgroup,RelFields, table_name, row_ID, "UPDATE")
					end if
					'update cs_security.chem_reg_privileges (or whatever it is called for the app)
					isOK = DoUpdateRecord(dbkey, formgroup, "",RelFields, table_name, row_ID)
					if isOK = False then
						theReturn=Session("errors_found"  & dbkey & formgroup)
					else
						theReturn="Record updated"
					end if
				next 'row_ID j for table i
			next 'table i
	if inStr(theReturn, "error")> 0 then
		showmessagedialog(theReturn)
	else
		Response.Write "<br>" & theReturn
	end if	
	ReturnEditResults dbkey, formgroup, "UPDATE_RECORD", dbkey 
End Select%>



	
