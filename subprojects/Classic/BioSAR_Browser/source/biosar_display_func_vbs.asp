<%' Copyright 1999-2003 CambridgeSoft Corporation. All rights reserved
'DO NOT EDIT THIS FILE%>

<% 
'***************************************************
'START GLOBALS
'*****************************************************
Dim TimerValue 
TimerValue = Timer()
Dim bCanMakeReport
Dim bTrace
bTrace=false
Dim bDebugReportSQL
bDebugReportSQl = false
Dim DebugBioSAR
DebugBioSAR = true ' Do not set to false
Dim debug
Dim BioSarDataConn
Dim shapeConn
Dim userConn
Dim logReportInfo
logReportInfo = false

formgroup = request("formgroup")
dbkey = request("dbname")

'LJB 2_17_2004 variables for decided whether to inline structures. If the request is XML then always inline
dim bInLine
	'if excel integration is turned on for the form group all structurs must be in the recrordst so disable the inLine=false feature.
	if  Session("result_display_type") = "XML" or  Application("FORMGROUP_EXCEL_INTEGRATION"& request("formgroup")) = 1 then
		bInLine = true
		Session("StrucDisplay"& dbkey & formgroup) = "INLINE"
	else
		pluginVer = request.Cookies("installedPlugin")
		if Not pluginVer = "8" then
			bInLine = true 
			Session("StrucDisplay"& dbkey & formgroup) = "INLINE"
		else
			dim INLINE_STRUC_HIT_TO_PAGE_RATIO
			Dim overrideTEMPCHANGE
			INLINE_STRUC_HIT_TO_PAGE_RATIO = Application("INLINE_STRUC_HIT_TO_PAGE_RATIO")
			if INLINE_STRUC_HIT_TO_PAGE_RATIO = 0 or INLINE_STRUC_HIT_TO_PAGE_RATIO = "" or isNull(INLINE_STRUC_HIT_TO_PAGE_RATIO) then
				bInLine = true
				Session("StrucDisplay"& dbkey & formgroup) = "INLINE"
			else
				
				numListView = Session("UserNumListView" & dbkey)
				if Session("TooManyHitsToDisplay" & dbkey & formgroup)=true then
					record_count = Application("TOO_MANY_HITS_MAXIMUM_RETRIEVABLE")
				else
					record_count = Session("hitlistrecordcount" & dbkey & formgroup)
				end if
				Session("Lasthitlistrecordcount" & dbkey & formgroup)=record_count
				if record_count = 0 or record_count = "" or isNull(record_count) then record_count = 1
				current_ratio = (CLng(numListView)/CLng(record_count))* 100

				if current_ratio < CLng(INLINE_STRUC_HIT_TO_PAGE_RATIO)then
					bInLine = false
					Session("StrucDisplay" & dbkey & formgroup) = "SINGLE"
				else
					bInLine = true
					Session("StrucDisplay"& dbkey & formgroup) = "INLINE"
				end if
			end if
		end if
	end if
	'if restore last hitlsit was chosen, wipe out the RS
	if request("dataaction") = "restore_hitlist" then
		Session("LIST_RS_SORTED")=""
		Session("LIST_RS") = ""
		Session("DETAIL_RS") = ""
		Session("DETAIL_RS_FULL") = ""
		session("child_last_sort")=""
		session("overrideStrucTemplateChanges")=""
		Session("allInnerSorts")=""
		Session("LastAllInnerSorts")=""
		Session("allOuterSorts")=""
		Session("InnerSort")=""
		Session("OuterSort")=""
		Session("lastInnerSort")=""
		Session("lastOuterSort")=""
	end if

	' if the incoming data is from a new hitlist then initialize RS
	if Session("BSLastHitlistID" & dbkey & formgroup) = "" then Session("BSLastHitlistID" & dbkey & formgroup)  = 0
	if Session("hitlistID" & dbkey & formgroup) = "" then Session("hitlistID" & dbkey & formgroup)=0
	
	'JHS 4/23/2007
	'CSBR-77525 and CSBR-77733 fix
	'The variables are showing up as vartype 14 for some reason and giving a type mismatch
	'I wonder why this is happening all of a sudden
	'I don't know how big they get so I am using Clng instead of cint
	'if Not (Session("hitlistID" & dbkey & formgroup) = Session("BSLastHitlistID" & dbkey & formgroup)) then
	if Not (CLng(Session("hitlistID" & dbkey & formgroup)) = CLng(Session("BSLastHitlistID" & dbkey & formgroup))) then
		Session("LIST_RS") = ""
		Session("DETAIL_RS") = ""
		Session("DETAIL_RS_FULL") = ""
		Session("LIST_RS_SORTED")=""
		session("child_last_sort")=""
		session("overrideStrucTemplateChanges")=""
		Session("allInnerSorts")=""
		Session("LastAllInnerSorts")=""
		Session("allOuterSorts")=""
		Session("InnerSort")=""
		Session("OuterSort")=""
		Session("lastInnerSort")=""
		Session("lastOuterSort")=""
		'set the BSLastHitlistID and last struc display
		Session("BSLastHitlistID" & dbkey & formgroup) = Session("hitlistID" & dbkey & formgroup)
		Session("LastStrucDisplay"& dbkey & formgroup)  = Session("StrucDisplay"& dbkey & formgroup)
	else 'same search but possibly ratio of hits/num_list_view changed becasue of a setting change. If so we don't want to rework the structure part of the template since if we did
		'the recordset would have to be re-retrieved
		if Not ((Session("StrucDisplay"& dbkey & formgroup) = Session("LastStrucDisplay"& dbkey & formgroup))) and isObject(Session("LIST_RS")) then
			'in the special case where the recordcount changed because of a cartisian product lookup from a sort of a child field in query display - we don't want to rework how the template is done
			if session("overrideStrucTemplateChanges") = false  then
				overrideStrucTemplateChanges = false
			else
				overrideStrucTemplateChanges = true
			end if
		else
			overrideStrucTemplateChanges = false
		end if
	end if

'end variable for inline structure changes




Dim MyRSArray 
if Not isArray(MyRSArray) then
	MyRSArray = Session("Base_RS" & dbkey & formgroup)
end if

Dim CHILD_DATA_DISPLAY
CHILD_DATA_DISPLAY = request("CHILD_DATA_DISPLAY")
if CHILD_DATA_DISPLAY <> "" then 'this means the toggle was clicked
	Session("LIST_RS") = ""
	Session("DISPLAY_RS") = ""
end if
if not CHILD_DATA_DISPLAY <> "" then
	CHILD_DATA_DISPLAY =  Session("add_childtable_criteria" & dbkey & formgroup)
else
	Session("add_childtable_criteria" & dbkey & formgroup)= CHILD_DATA_DISPLAY
end if


If Not Application("DEFAULT_COLUMN_LAYOUT") <> "" then
	Application.Lock
		if (Application("DEFAULT_COLUMN_LAYOUT")="INIEmpty" or Application("DEFAULT_COLUMN_LAYOUT") = "NULL" or Application("DEFAULT_COLUMN_LAYOUT") = "") then
			Application("DEFAULT_COLUMN_LAYOUT")="FIELDS_ACROSS"
		end if
	Application.UnLock
end if

Dim column_layout
column_layout = request("COLUMN_LAYOUT")
if column_layout = "" then
	column_layout =  Session("DEFAULT_COLUMN_LAYOUT")
	if column_layout = "" then
		column_layout =  Application("DEFAULT_COLUMN_LAYOUT")
	end if
end if
Session("DEFAULT_COLUMN_LAYOUT") = column_layout
'if not isArray(Session("base_connection")) then
	'Session("base_connection") = Application("base_connection" & "biosar_browser")
'end if
'***************************************************
'END GLOBALS
'*****************************************************


'***************************************************
'START MASTER - ALL FORM DISPLAY
'*****************************************************

Function GetItems(formgroup, dbkey,  display_view, output_type)
	Trace "In:GetItems" & showErrorIfAny, 25
	if CDD_TIMER = true then
		t0 = timer
	end if
	Session("Form_Save_And_Restore")=""
	Session("LEFT" & display_view &  dbkey  & formgroup)=""
	Session("UserFormgroupsExist") = UserFormgroupsExist(dbkey, formgroup) 
	if UCase(formgroup) = "BASE_FORM_GROUP" then%>
		
		<script language="javascript">
				DoRedirect dbkey, "/biosar_browser/biosar_browser/mainpage.asp?formgroup=base_form_group&dbname=biosar_browser" 
		</script>
			<%
	else
		true_view_type = request("output_type")
		if true_view_type = "" then 
			true_view_type = output_type
		end if
		if output_type = "" then output_type = "FRAMES"
		if (UCase(output_type) = "FRAMES") OR (UCase(output_type) = "FRAMES_CHECK_TABLES") then
			Session("LEFT" & display_view & dbkey  & formgroup) =  getDisplayItems(formgroup, dbkey,  display_view, output_type, "LEFT")
			Session("RIGHT" & display_view & dbkey  & formgroup) =  getDisplayItems(formgroup, dbkey,  display_view, output_type, "RIGHT")
		elseif  (UCase(output_type) = "FRAMETAB") then
				Session("LEFT" & display_view & dbkey  & formgroup) =  getDisplayItems(formgroup, dbkey,  display_view, output_type, "LEFT")
				Session("RIGHT" & display_view & dbkey  & formgroup) =  getDisplayItems(formgroup, dbkey,  display_view, output_type, "RIGHT")
		else
			Session("LEFT" & display_view &  dbkey  & formgroup) =  getDisplayItems(formgroup, dbkey,  display_view, output_type, "")
		end if
	end if
	if CDD_TIMER = true then
		logaction("Loading the " & display_view & " form took: " & timer-t0 & " seconds")
	end if
	Trace "Out:GetItems" & showErrorIfAny, 25
End Function

Function getIsFormGroupPublic(formgroup, dbkey)
	Trace "In:getIsFormGroupPublic" & showErrorIfAny, 25
	
	Set userConn = GetUserConn
	Session("bypass_ini" & dbkey & formgroup) = true
	set cmd = Server.CreateObject("adodb.command")
	cmd.ActiveConnection =  userConn
	cmd.CommandType = adCmdText
	sql = "Select FORMGROUP_NAME,DESCRIPTION from BIOSARDB.db_formgroup where formgroup_id =?" 
	cmd.CommandText = sql
	cmd.Parameters.Append cmd.CreateParameter("pFormgroupID", 5, 1, 0, formgroup) 
		
	Set RS = cmd.Execute
	If Not (RS.BOF and RS.EOF) then
		bCanMakeReport = true
		Application("formgroup_full_name" & dbkey & formgroup)=Replace(RS("FORMGROUP_NAME"), " ", "")
		Application("formgroup_description" & dbkey & formgroup) =RS("DESCRIPTION")
	else
		bCanMakeReport = false
	end if%>
		<script language = "javascript">
			bCanMakeReport = "<%=bCanMakeReport%>"
		</script>
	<%CloseRS(RS)
	
	Trace "Out:GetItems" & showErrorIfAny, 25
	getIsFormGroupPublic = bCanMakeReport
End Function



'Main display function where the type of form is looked and and the appropriate functions called.
Function getDisplayItems(formgroup, dbkey,  display_view, view_type, output_target)
	Trace "In:GetDisplayItems" & showErrorIfAny, 25
	Session("BaseTable" & dbkey & formgroup) = Replace(getBaseTable(dbkey, formgroup, "basetable"), ".", "_")
	'Session("DETAIL_RS") = ""
	Session("display_view")=display_view
	Session("dbkey")=dbkey
	Session("formgroup") = formgroup
	Session("CurrentLocation" & dbkey & formgroup) = request.servervariables("path_info") & "?"  & request.servervariables("query_string")
	dim theReturn
	Session("ShowSlidderControls")=false
	Select Case UCase(display_view)	
		Case "QUERY"
			Select Case UCase(view_type)
				Case "REPORT"
					
					theReturn = theReturn & getQueryItems(formgroup, dbkey,  display_view)
				Case "SHOW_ONLY_BASE"
					basetable = getBaseTable(dbkey, formgroup, "basetable")
				
					theReturn = theReturn & getQueryItemsHidden(formgroup, dbkey,  display_view,basetable)
				Case "QUERYBUILDER"
					theReturn = theReturn & getQueryBuilderFields(formgroup, dbkey,  display_view) & "<br><br>"
					theReturn = theReturn & getQueryItemsAllHidden(formgroup, dbkey,  display_view)
				
			End Select
		
		Case "LIST"
			'Select Case UCase(view_type)
				Session("ShowSlidderControls")=true
				if CHILD_DATA_DISPLAY = "LIMIT" then
					view_type="CHECK_TABLES"
				
				end if 
				Select Case UCase(view_type)
				Case "REPORT"
					if CDD_TIMER = true then
						t0 = timer
					end if
					GenerateReportVariables dbkey, formgroup, ""
					if CDD_TIMER = true then
						logaction("Loading the GenerateReportVariables variables took: " & timer-t0 & " seconds")
					end if
					if CDD_TIMER = true then
						t0 = timer
					end if
					theReturn = theReturn &  getListFields(formgroup, dbkey,  display_view)
					if CDD_TIMER = true then
						logaction("Loading the loading getListFields variables took: " & timer-t0 & " seconds")
					end if
				Case "CHECK_TABLES"
					basetable = getBaseTable(dbkey, formgroup, "basetable")
					
					if Session("strWhereSubforms" & dbkey & formgroup) <> "" then
						table_list = basetable & "," & Session("strWhereSubforms" & dbkey & formgroup)
						theReturn = theReturn & getListFieldsCheckTables(formgroup, dbkey,  display_view,table_list)
					
					else
						theReturn = theReturn & getListFields(formgroup, dbkey,  display_view)
					end if
					if formgroup = "1" then 'this is the adhoc form 
						table_group_array = Session("TABLE_GROUP" & dbkey & formgroup)
						table_list = table_group_array(2)
					else
						table_list = ""
					end if
					GenerateReportVariables dbkey, formgroup, table_list
					
				End Select
			'get list view items
			
	
		Case "DETAIL"
			if not isArray(Session("base_rs" & dbkey & formgroup)) then
				Response.Write "<BR><Br>Your hitlist has expired do to<BR> a prolonged time of inactivity.<BR> You will need to repeat your query <BR>in order to display the results."
				Response.Write "<BR><BR>"
			end if
			current_rec = Session("base_rs" & dbkey & formgroup)(0, current_index -1)
			
			last_id = session("last_detail_baseid")
			bNewRS = false
			if last_id = "" then 
				bNewRS = true
				Session("LEFT" & display_view & dbkey  & formgroup) = ""
				Session("RIGHT" & display_view & dbkey  & formgroup) = ""
			else
				if Not (CLng(current_rec)=CLng(last_id)) then 
					bNewRS = true
					Session("LEFT" & display_view & dbkey  & formgroup) = ""
					Session("RIGHT" & display_view & dbkey  & formgroup) = ""
				end if
			end if
			if bNewRS=true then
				Session("DETAIL_RS") = ""
			end if
			if CHILD_DATA_DISPLAY = "LIMIT" then
				Select Case UCase(view_type)
					case "TAB"
						view_type="TAB_CHECK_TABLES"
					case "REPORT"
						view_type = "REPORT_CHECK_TABLES"
					case "FRAMES"
						view_type = "FRAMES_CHECK_TABLES"
				end select
			end if 
			output_type = request("output_type")
			detail_result_page_path=getFormPath(dbkey, formgroup, "DETAIL_SHORT")
			noframe_result_path =getFormPath(dbkey, formgroup, "NO_FRAME_SHORT")
			'view_type = "REPORT"
			list_result_page_path=getFormPath(dbkey, formgroup, "LIST")
			buttonTD = "<td bgcolor=""#CCCCCC"" nowrap >"
			
			Select Case UCase(view_type)
				Case "EDIT_FORM"

			
				Case "TAB"
					'GenerateReportVariables dbkey, formgroup, ""
					theReturn = theReturn &  "<tr><table width = ""300""><tr><td>"
					theReturn = theReturn & getJscriptButtons(Session("BASE_RS" & dbkey & formgroup)(0,current_index-1))
					theReturn = theReturn &  "</td>"
					theReturn = theReturn & buttonTD &  "<a class=""ButtonBar"" HREF=""" & noframe_result_path &  "?output_type=REPORT&dbname=biosar_browser&formgroup=" & formgroup & "&formmode=edit"">Report View</B></A></td>"
					theReturn = theReturn & buttonTD &  "<a  class=""ButtonBar""  HREF=""" & detail_result_page_path &  "?output_type=FRAMES&dbname=biosar_browser&formgroup=" & formgroup & "&formmode=edit"">Frame View</B></A></td>"
					theReturn = theReturn & buttonTD &  "<a  class=""ButtonBar""  HREF=""" & detail_result_page_path &  "?output_type=FRAMETAB&dbname=biosar_browser&formgroup=" & formgroup & "&formmode=edit"">Frame/Tab View</B></A></td>"
					theReturn = theReturn & addToggles(dbkey, formgroup,false,false,false,true,true,false,true) 
					theReturn = theReturn & "</tr></table>"
					theReturn = theReturn & getDetailFieldsTab(formgroup, dbkey,  display_view, "ALL")
					theReturn = theReturn
				Case "REPORT"
					'GenerateReportVariables dbkey, formgroup, ""
					theReturn = theReturn &  "<tr><table width = ""300""><tr><td>"
					
					theReturn = theReturn & getJscriptButtons(Session("BASE_RS" & dbkey & formgroup)(0,current_index-1))
					theReturn = theReturn &  "</td>"
					theReturn = theReturn & buttonTD &  "<a class=""ButtonBar""HREF=""" & detail_result_page_path &  "?output_type=FRAMES&dbname=biosar_browser&formgroup=" & formgroup & "&formmode=edit"">Frame View</B></A></td>"
					theReturn = theReturn & buttonTD &  "<a  class=""ButtonBar"" HREF=""" & noframe_result_path &  "?output_type=TAB&dbname=biosar_browser&formgroup=" & formgroup & "&formmode=edit"">Tab View</B></A></td>"
					theReturn = theReturn & buttonTD &  "<a  class=""ButtonBar""  HREF=""" & detail_result_page_path &  "?output_type=FRAMETAB&dbname=biosar_browser&formgroup=" & formgroup & "&formmode=edit"" target=""mainFrame"">Frame/Tab View</B></A></td>"
					theReturn = theReturn & addToggles(dbkey, formgroup,false,false,false,true,true,false,true) 
					theReturn = theReturn & "</tr></table>"
					theReturn = theReturn & getDetailFields(formgroup, dbkey,  display_view, "ALL")
				Case "FRAMES"
					'GenerateReportVariables dbkey, formgroup, ""
					Select Case UCase(output_target)
						Case "LEFT"
							theReturn = theReturn &  "<tr><table width = ""300""><tr><td>"
							theReturn = theReturn & getJscriptButtons(Session("BASE_RS" & dbkey & formgroup)(0,current_index-1))
							theReturn = theReturn &  "</td>"
							
							'Because now we call the FRAMES case from the REPORT screen we need to
							'know whidh button output.  We base this on the current page
							'
							if InStr(1,Request.ServerVariables("SCRIPT_NAME"),"noframe") > 0 then
								'We are in the report page, show the Frame link
								theReturn = theReturn & buttonTD &  "<a class=""ButtonBar""HREF=""" & detail_result_page_path &  "?output_type=FRAMES&dbname=biosar_browser&formgroup=" & formgroup & "&formmode=edit"">Frame View</B></A></td>"
							Else
								'We must be in frames, show the Report link
								theReturn = theReturn & buttonTD &  "<a class=""ButtonBar"" HREF=""" & noframe_result_path &  "?output_type=REPORT&dbname=biosar_browser&formgroup=" & formgroup & "&formmode=edit"" target=""main"">Report View</B></A></td>"
							end if
							theReturn = theReturn & buttonTD &  "<a class=""ButtonBar""  HREF=""" & noframe_result_path &  "?output_type=TAB&dbname=biosar_browser&formgroup=" & formgroup & "&formmode=edit"">Tab View</B></A></td>"
							theReturn = theReturn & buttonTD &  "<a class=""ButtonBar""  HREF=""" & detail_result_page_path &  "?output_type=FRAMETAB&dbname=biosar_browser&formgroup=" & formgroup & "&formmode=edit"" target=""main"">Frame/Tab View</B></A></td>"							
							theReturn = theReturn & addToggles(dbkey, formgroup,false,false,false,true,true,false,true) 
							theReturn = theReturn & "</tr></table>"
							theReturn = theReturn & getDetailFields(formgroup, dbkey,  display_view, "BASETABLE")
						Case "RIGHT"
							
							theReturn = theReturn & getDetailFields(formgroup, dbkey,  display_view, "NO_BASETABLE")
					end select

				Case "FRAMETAB"
					'GenerateReportVariables dbkey, formgroup, ""
					Select Case UCase(output_target)
						Case "LEFT"
							theReturn = theReturn &  "<tr><table width = ""300""><tr><td>"
							theReturn = theReturn & getJscriptButtons(Session("BASE_RS" & dbkey & formgroup)(0,current_index-1))
							theReturn = theReturn &  "</td>"
							

							theReturn = theReturn & buttonTD &  "<a class=""ButtonBar""HREF=""" & detail_result_page_path &  "?output_type=FRAMES&dbname=biosar_browser&formgroup=" & formgroup & "&formmode=edit"" target=""main"">Frame View</B></A></td>"
							theReturn = theReturn & buttonTD &  "<a class=""ButtonBar"" HREF=""" & noframe_result_path &  "?output_type=REPORT&dbname=biosar_browser&formgroup=" & formgroup & "&formmode=edit"" target=""main"">Report View</B></A></td>"
							theReturn = theReturn & buttonTD &  "<a class=""ButtonBar""  HREF=""" & noframe_result_path &  "?output_type=TAB&dbname=biosar_browser&formgroup=" & formgroup & "&formmode=edit"" target=""main"">Tab View</B></A></td>"
							theReturn = theReturn & addToggles(dbkey, formgroup,false,false,false,true,true,false,true) 
							theReturn = theReturn & "</tr></table>"
							theReturn = theReturn & getDetailFields(formgroup, dbkey,  display_view, "BASETABLE")
							
						Case "RIGHT"
							
							theReturn = theReturn & getDetailFrameTab(formgroup, dbkey,  display_view, "NO_BASETABLE")
							theReturn = theReturn
					end select
					
				Case "TAB_CHECK_TABLES"
				
					basetable = getBaseTable(dbkey, formgroup, "basetable")
					if Session("strWhereSubforms" & dbkey & formgroup) <> "" then
						table_list = basetable & "," & Session("strWhereSubforms" & dbkey & formgroup)
						'GenerateReportVariables dbkey, formgroup, table_list
					else
						'GenerateReportVariables dbkey, formgroup, ""
					end if
					theReturn = theReturn &  "<tr><table width = ""300""><tr><td>"
					theReturn = theReturn & getJscriptButtons(Session("BASE_RS" & dbkey & formgroup)(0,current_index-1))
					theReturn = theReturn &  "</td>"
					'theReturn = theReturn & "<td><A  HREF=""" & noframe_result_path &  "?output_type=REPORT_CHECK_TABLES&dbname=biosar_browser&formgroup=" & formgroup & "&formmode=edit"">Report View</B></A></td>"
					'theReturn = theReturn & "<td><A  HREF=""" & noframe_result_path &  "?output_type=FRAMES_CHECK_TABLES&dbname=biosar_browser&formgroup=" & formgroup & "&formmode=edit"">Frame View</B></A></td>"
					theReturn = theReturn & buttonTD &  "<a class=""ButtonBar"" HREF=""" & noframe_result_path &  "?output_type=REPORT&dbname=biosar_browser&formgroup=" & formgroup & "&formmode=edit"">Report View</B></A></td>"
					theReturn = theReturn & buttonTD &  "<a class=""ButtonBar"" HREF=""" & noframe_result_path &  "?output_type=FRAMES_CHECK_TABLES&dbname=biosar_browser&formgroup=" & formgroup & "&formmode=edit"">Frame View</B></A></td>"
					theReturn = theReturn & addToggles(dbkey, formgroup,false,false,false,true,true,false,true) 
					theReturn = theReturn & "</tr></table>"
					theReturn = theReturn & getDetailFieldsTab(formgroup, dbkey,  display_view, "CHECK_TABLES")
					theReturn = theReturn
				Case "REPORT_CHECK_TABLES"
					basetable = getBaseTable(dbkey, formgroup, "basetable")
					if Session("strWhereSubforms" & dbkey & formgroup) <> "" then
						table_list = basetable & "," & Session("strWhereSubforms" & dbkey & formgroup)
						'GenerateReportVariables dbkey, formgroup, table_list
					else
						'GenerateReportVariables dbkey, formgroup, ""
					end if
					theReturn = theReturn &  "<tr><table width = ""300""><tr><td>"
					theReturn = theReturn & getJscriptButtons(Session("BASE_RS" & dbkey & formgroup)(0,current_index-1))
					theReturn = theReturn &  "</td>"
					'theReturn = theReturn & "<td><A  HREF=""" & detail_result_page_path &  "?output_type=FRAMES_CHECK_TABLES&dbname=biosar_browser&formgroup=" & formgroup & "&formmode=edit"">Frame View</B></A></td>"
					'theReturn = theReturn & "<td><A  HREF=""" & noframe_result_path &  "?output_type=TAB_CHECK_TABLES&dbname=biosar_browser&formgroup=" & formgroup & "&formmode=edit"">Tab View</B></A></td>"
					theReturn = theReturn & buttonTD &  "<a class=""ButtonBar"" HREF=""" & detail_result_page_path &  "?output_type=FRAMES_CHECK_TABLES&dbname=biosar_browser&formgroup=" & formgroup & "&formmode=edit"">Frame View</B></A></td>"
					theReturn = theReturn & buttonTD &  "<a class=""ButtonBar"" HREF=""" & noframe_result_path &  "?output_type=TAB&dbname=biosar_browser&formgroup=" & formgroup & "&formmode=edit"">Tab View</B></A></td>"
					theReturn = theReturn & addToggles(dbkey, formgroup,false,false,false,true,true,false,true) 
					theReturn = theReturn & "</tr></table>"
					theReturn = theReturn & getDetailFields(formgroup, dbkey,  display_view, "CHECK_TABLES")
				Case "FRAMES_CHECK_TABLES"
					basetable = getBaseTable(dbkey, formgroup, "basetable")
					if Session("strWhereSubforms" & dbkey & formgroup) <> "" then
						table_list = basetable & "," & Session("strWhereSubforms" & dbkey & formgroup)
						'GenerateReportVariables dbkey, formgroup, table_list
					else
						'GenerateReportVariables dbkey, formgroup, ""
					end if
					Select Case UCase(output_target)
						Case "LEFT"
							theReturn = theReturn &  "<tr><table width = ""300""><tr><td>"
							theReturn = theReturn & getJscriptButtons(Session("BASE_RS" & dbkey & formgroup)(0,current_index-1))
							theReturn = theReturn &  "</td>"
							'theReturn = theReturn & "<td><A  HREF=""" & noframe_result_path &  "?output_type=REPORT_CHECK_TABLES&dbname=biosar_browser&formgroup=" & formgroup & "&formmode=edit"" target=""main"">Report View</B></A></td>"
							'theReturn = theReturn & "<td><A  HREF=""" & noframe_result_path &  "?output_type=TAB_CHECK_TABLES&dbname=biosar_browser&formgroup=" & formgroup & "&formmode=edit"">Tab View</B></A></td>"
							theReturn = theReturn & buttonTD &  "<a class=""ButtonBar""  HREF=""" & noframe_result_path &  "?output_type=REPORT&dbname=biosar_browser&formgroup=" & formgroup & "&formmode=edit"" target=""main"">Report View</B></A></td>"
							theReturn = theReturn & buttonTD &  "<a class=""ButtonBar""  HREF=""" & noframe_result_path &  "?output_type=TAB&dbname=biosar_browser&formgroup=" & formgroup & "&formmode=edit"">Tab View</B></A></td>"
							theReturn = theReturn & addToggles(dbkey, formgroup,false,false,false,true,true,false,true) 
							theReturn = theReturn & "</tr></table>"
							theReturn = theReturn & getDetailFields(formgroup, dbkey,  display_view, "BASETABLE")
						Case "RIGHT"
							
							theReturn = theReturn & getDetailFields(formgroup, dbkey,  display_view, "CHECK_TABLES_NO_BASE")
					end select
				
			End Select
			
			theReturn = theReturn &  "</tr>"
		
	End Select
	Trace "Out:GetDisplayItems" & showErrorIfAny, 25
	getDisplayItems=theReturn
End Function

'***************************************************
'END MASTER - ALL FORM DISPLAY
'*****************************************************


'******************************************
'START LIST FORM GENERATION
'******************************************

'display list view 
Function getListFields(formgroup, dbkey,  display_view)
	Trace "In:getListFields" & showErrorIfAny, 25
	
	myItems = Split(Application("RS_DEFS" & display_view & dbkey & formgroup), ":CS_ITEM:", -1)
	if UBound(myItems) > 0 then
		hasChildren = true
	else
		hasChildren = false
	end if
	Session("BaseTable" & dbkey & formgroup) = Replace(getBaseTable(dbkey, formgroup, "basetable"), ".", "_")

	if Session("TooManyHitsToDisplay" & dbkey & formgroup)=true then
		Session("Base_RSRecordCount" & dbkey & formgroup)= Application("TooManyHitsMaximumRetrievable")
		if Not Session("dialogShown" & dbkey & formgroup)=true then
			showmessagedialog("Your search found " & Session("hitlistrecordcount" & dbkey & formgroup) & " hits. \n Only the first " & Application("TooManyHitsMaximumRetrievable") & " hits of your search will be displayed.\n Your search returned more than the maximum allowable set by your administrator. \n You can refine your search over the full hitlist by clicking the refine button.\n You can also export the entire hitlist or save the hitlist.\n Mark all is not available but you can mark individual hits.")
			Session("dialogShown" & dbkey & formgroup)=true
		end if
		resetAtEnd dbkey, formgroup, Application("TooManyHitsMaximumRetrievable")
		
	end if
	Session("dbkey")= dbkey
	Session("formgroup") = formgroup
	Session("display_view") = display_view
	on error resume next
	dim i, output
	theIndex = current_index - 1
	
	
	
	if Session("result_display_type") = "XML" then
		display_view_temp = request("display_view")
		if not trim(display_view_temp) <> "" then
			display_view = "LIST"
		else
			if UCase(trim(display_view_temp)) = "DETAIL" then
				display_view = "DETAIL"
			else
				display_view = "LIST"
			end if
		end if
		Set Session("LIST_RS") = buildShapeRS(Session("LIST_RS"), dbkey, formgroup, display_view, true)
		if  Session("table_errors")<> "" then
			output=""
			exit function
		end if
		Response.Clear
		Response.ContentType = "text/xml"
		Session("LIST_RS").save Response, adPersistXML
		Session("LIST_RS").close
		Set Session("LIST_RS") = nothing
		Session("result_display_type")=""
		Response.end
	else
		'get shape statement for recordset. Only build is sesison("basers") is not an object
		Set Session("LIST_RS") = buildShapeRS(Session("LIST_RS"), dbkey, formgroup, display_view, true)
		MyRSArray = Session("Base_RS" & dbkey & formgroup)
		if  Session("table_errors")<> "" then
			output=""
			exit function
		end if
		
		if Session("LastStartingIndex" & dbkey & formgroup)  = 1 or (Session("LastStartingIndex" & dbkey & formgroup) = current_index) then
			output = output & "<table><tr><td>"
			output = output & addToggles(dbkey, formgroup,true, true, true, true,true, hasChildren,false)
		
			output = output &  "<table>"
			output = output & slideScript()
		end if
		if CDD_TIMER = true then
			t0 = timer
		end if
	
	end if
		
			if CDD_TIMER = true then
				logaction("Building the List View Recordset took: " & timer-t0 & " seconds")
			end if
			'get template definition from dictionary
			if CDD_TIMER = true then
				t0 = timer
			end if
			if UCase(column_layout)="FIELDS_ACROSS" then
				template_definition = getXMLTemplate(dbkey, formgroup, LIST_COLUMN_ACROSS)
			else
				template_definition = getXMLTemplate(dbkey, formgroup,LIST_COLUMN_DOWN)
			end if
		
			if CDD_TIMER = true then
				logaction("Getting the XML Templates took: " & timer-t0 & " seconds")
			end if
			if CDD_TIMER = true then
				t0 = timer
			end if
			'create DOM and load template
			if Not isObject(Session("TemplateDom")) then 'if it is an object then don't recreate. Only wiped when edittin formgroup or creteing  new search
				Set Session("TemplateDom") = Server.CreateObject("MSXML2.FreeThreadedDOMDocument.4.0")
			end if	
	
		if Application("BIOVIZ_INTEGRATION")=1 and Application("FORMGROUP_BIOVIZ_INTEGRATION"& request("formgroup")) = 1 then
			replace_sql = Session("SQL" & Session("hitlistid" & dbkey & formgroup))
			Session("chemfinderTemplate") = Replace(template_definition, "</DOCUMENT>", replace_sql & chr(10)& "</DOCUMENT>")
		end if
		if Application("EXCEL_INTEGRATION") = 1 and Application("FORMGROUP_EXCEL_INTEGRATION"& request("formgroup")) = 1 then
			session("template_definition_list" & formgroup) = getXMLTemplate(dbkey, formgroup, LIST_COLUMN_ACROSS)
		end if
		Set displayDom = Session("TemplateDom")	
		displayDom.loadXML(template_definition)	
			Set displayDom = SetSubTableBorderDisplay(displayDom)
			Set displayDom = SetHeaderRepeat(displayDom)
			Set displayDom = StructureGetMethod(displayDom)
			
			baseid = "IndexCounter"
			if Session("hitlistRecordCount" & dbkey & formgroup)<2 then
				tPageSize=2
			end if
			
			if Not request("sortFields") <> "" then
				temp_sort = split(Session("order_by" & dbkey & formgroup), ".", -1)
				order_by = temp_sort(2)& " " &  Session("sort_direction" & dbkey & formgroup)
				
			else
				order_by = request("sortFields")
			end if  
			
		
			if isObject(Session("LIST_RS")) then
				output= output & RS2HTML(Session("LIST_RS"),displayDom,tPageSize,NULL,theIndex,theIndex,order_by,MyRSArray,baseid)
			end if
			if instr(1, output, "Error in RS2HTML:") > 0 then
				TraceAndDisplayError "Error while converting RS to HTML in getListFields()" ,err.Source, err.number, err.Description & "<BR>" & Session("LIST_RS").source & "<BR> HitlistID:" & Session("hitlistid" & dbkey & formgroup) 
			end if 
			if CDD_TIMER = true then
				logaction("Getting the XML output took: " & timer-t0 & " seconds")
			end if
  		Session("Base_RS" & dbkey & formgroup)=MyRSArray
	
		Session("result_display_type") = ""
	Trace "Out:getListFields" & showErrorIfAny, 25
	getListFields = output
End Function

Function getBaseID(dbkey, formgroup)
	Trace "In:getBaseID" & showErrorIfAny, 25
	
	basetable = GetBaseTable(dbkey, formgroup, "basetable")
	baseid = GetTableVal(dbkey, basetable, kPrimaryKey)
	Trace "Out:getBaseID" & showErrorIfAny, 25
	getBaseID = baseid
End Function 

'display list view while limiting tables to original query
Function getListFieldsCheckTables(formgroup, dbkey,  display_view, table_list)
	Trace "In:getListFieldsCheckTables" & showErrorIfAny, 25
	myItems = Split(Application("RS_DEFS" & display_view & dbkey & formgroup), ":CS_ITEM:", -1)
	if UBound(myItems) > 0 then
		hasChildren = true
	else
		hasChildren = false
	end if
	
	if Session("TooManyHitsToDisplay" & dbkey & formgroup)=true then
		Session("Base_RSRecordCount" & dbkey & formgroup)= Application("TooManyHitsMaximumRetrievable")
		if Not Session("dialogShown" & dbkey & formgroup)=true then
			showmessagedialog("Your search found " & Session("hitlistrecordcount" & dbkey & formgroup) & " hits. \n Only the first " & Application("TooManyHitsMaximumRetrievable") & " hits of your search will be displayed.\n Your search returned more than the maximum allowable set by your administrator. \n You can refine your search over the full hitlist by clicking the refine button.")
			Session("dialogShown" & dbkey & formgroup)=true
		end if
		resetAtEnd dbkey, formgroup, Application("TooManyHitsMaximumRetrievable")
	end if
	Session("dbkey")= dbkey
	Session("formgroup") = formgroup
	Session("display_view") = display_view
	on error resume next
	dim i, output
	
	theIndex = current_index - 1
	
	Set Session("LIST_RS") = buildShapeRS(Session("LIST_RS"), dbkey, formgroup, display_view,true)
	MyRSArray = Session("Base_RS" & dbkey & formgroup)
	if Session("table_errors")<> "" then
			output=""
			exit function
	end if
	if Session("LastStartingIndex" & dbkey & formgroup)  = 1 or (Session("LastStartingIndex" & dbkey & formgroup) = current_index) then
		output = output & "<table><tr><td>"
		output = output & addToggles(dbkey, formgroup,true, true, true, true, true,hasChildren,false)
			
		output = output &  "<table>"
		output = output & slideScript()
	end if
	


	if Session("result_display_type") = "XML" then
		Response.Clear
		Response.ContentType = "text/xml"
		Session("LIST_RS").save Response, adPersistXML
		Session("LIST_RS").close
		Set Session("LIST_RS") = nothing
		Session("result_display_type")=""
		Response.end

	else
	'get template definition from dictionary
	if UCase(column_layout)="FIELDS_ACROSS" then
		template_definition = getXMLTemplate(dbkey, formgroup, LIST_COLUMN_ACROSS)
	else
		template_definition = getXMLTemplate(dbkey, formgroup,LIST_COLUMN_DOWN)
	end if
	
	'create DOM and load template
	if Not isObject(Session("TemplateDom")) then 'if it is an object then don't recreate. Only wiped when edittin formgroup or creteing  new search
		Set Session("TemplateDom") = Server.CreateObject("MSXML2.FreeThreadedDOMDocument.4.0")
	end if		
	if Application("BIOVIZ_INTEGRATION")=1 and Application("FORMGROUP_BIOVIZ_INTEGRATION"& request("formgroup")) = 1 then
			replace_sql = Session("SQL" & Session("hitlistid" & dbkey & formgroup))
			Session("chemfinderTemplate") = Replace(template_definition, "</DOCUMENT>", replace_sql & chr(10)& "</DOCUMENT>")
	end if
	if Application("EXCEL_INTEGRATION") = 1 and Application("FORMGROUP_EXCEL_INTEGRATION"& request("formgroup")) = 1 then
		template_definitionXL = getXMLTemplate(dbkey, formgroup, LIST_COLUMN_ACROSS)
		'DGB CSBR-61865 Need to modify the template to eliminate tables that don't match the query
		if Not isObject(Session("TemplateDomXL")) then 'if it is an object then don't recreate. Only wiped when edittin formgroup or creteing  new search
			Set Session("TemplateDomXL") = Server.CreateObject("MSXML2.FreeThreadedDOMDocument.4.0")
		end if
		Set displayDomXL = Session("TemplateDomXL")
		displayDomXL.loadXML(template_definitionXL)
		if table_list <> "" then
			Set displayDomXL = TablesToShow(displayDomXL,table_list)
		end if
		session("template_definition_list" & formgroup)= displayDomXL.xml
		'DGB end CSBR-61865  
	end if
	Set displayDom = Session("TemplateDom")
	displayDom.loadXML(template_definition)
	'modify template if necessary to show only tables in original query
	Set displayDom = SetSubTableBorderDisplay(displayDom)
	Set displayDom = SetHeaderRepeat(displayDom)
	Set displayDom = StructureGetMethod(displayDom)
	if HideJS = true then
		Set displayDom = HideJSColumn(displayDom)
	end if
	if table_list <> "" then
		Set displayDom = TablesToShow(displayDom,table_list)
	end if
	baseid = "indexCounter"
	if Not request("sortFields") <> "" then
		temp_sort = split(Session("order_by" & dbkey & formgroup), ".", -1)
		order_by = temp_sort(2)& " " &  Session("sort_direction" & dbkey & formgroup)
		
	else
		order_by = request("sortFields")
	end if  
	if (theIndex = 0 and  Not order_by <> "") or (theIndex = 0 and Session("hitlistrecordcount" & dbkey & formgroup)=1) then 
		theIndex2=null
	else
		theIndex2 = theIndex
	end if
	
	if isObject(Session("LIST_RS")) then
		output= output &  RS2HTML(Session("LIST_RS"),displayDom,tPageSize,NULL,theIndex,theIndex2,order_by,MyRSArray,baseid)
	end if
	if instr(1, output, "Error in RS2HTML:") > 0 then
		TraceAndDisplayError "Error while converting RS to HTML in getListFieldsCheckTables()" ,err.Source, err.number, err.Description & "<BR>" & Session("LIST_RS").source & "<BR> HitlistID:" & Session("hitlistid" & dbkey & formgroup) 	
	end if 
	Session("Base_RS" & dbkey & formgroup) = MYRSArray
	end if
	Trace "Out:getListFieldsCheckTables" & showErrorIfAny, 25
	getListFieldsCheckTables = output
	
End Function
'******************************************
'END LIST FORM GENERATION
'******************************************


'******************************************
'START DETAIL FORM GENERATION
'******************************************
'master function to set variables for calling detial form generation depending on query fields and display format chosen
Function getDetailFields(formgroup, dbkey,  display_view, output_type)
			Trace "In:getDetailFields" & showErrorIfAny, 25
			
			basetable = GetBaseTable(dbkey, formgroup, "basetable")
			Select Case(output_type)
				Case "ALL"
					output = output & parseDetailTables(dbkey, formgroup,display_view, "", false,false)
				Case "NO_BASETABLE"
				
					table_list =   getAllTablesList(dbkey, formgroup,display_view)
					
					output = output & parseDetailTables(dbkey, formgroup,display_view, table_list, true, true)
				Case "BASETABLE"
						basetable = getbasetable(dbkey, formgroup, "basetable")
						table_list = basetable
						output = output  &  parseDetailTables(dbkey, formgroup,display_view, table_list, false, false)
				Case "CHECK_TABLES"
					if Session("strWhereSubforms" & dbkey & formgroup) <> "" then
						table_list = basetable & "," & Session("strWhereSubforms" & dbkey & formgroup)
						output = output  &  parseDetailTables(dbkey, formgroup,display_view, table_list, true,false)
					else
						output = output  &  parseDetailTables(dbkey, formgroup,display_view, table_list, true,false)
					end if
				Case "CHECK_TABLES_NO_BASE"
					if Session("strWhereSubforms" & dbkey & formgroup) <> "" then
						table_list = Session("strWhereSubforms" & dbkey & formgroup)
						output = output  &  parseDetailTables(dbkey, formgroup,display_view, table_list, true, true)
					end if
			End select
			Trace "Out:getDetailFields" & showErrorIfAny, 25
	getDetailFields = output
End Function

'parse and return the detail view using xml template and shaped recordset
Function parseDetailTables(dbkey, formgroup,display_view,table_list, hideJS, bNoBase)
	Trace "In:parseDetailTables" & showErrorIfAny, 25
	
	Session("dbkey")= dbkey
	Session("formgroup") = formgroup
	Session("display_view") = display_view
	myItems = Split(Application("RS_DEFS" & display_view & dbkey & formgroup), ":CS_ITEM:", -1)
	if UBound(myItems) > 0 then
		hasChildren = true
	else
		hasChildren = false
	end if
	on error resume next
	dim i, output
	basetable = getbasetable(dbkey, formgroup, "basetable")
	baseid_name =  GetTableVal(dbkey, basetable, kPrimaryKey)
	if Session("TooManyHitsToDisplay" & dbkey & formgroup)=true then
		Session("Base_RSRecordCount" & dbkey & formgroup)= Application("TooManyHitsMaximumRetrievable")
		if Not Session("dialogShown" & dbkey & formgroup)=true then
			showmessagedialog("Your search found " & Session("hitlistrecordcount" & dbkey & formgroup) & " hits. \n Only the first " & Application("TooManyHitsMaximumRetrievable") & " hits of your search will be displayed.\n Your search returned more than the maximum allowable set by your administrator. \n You can refine your search over the full hitlist by clicking the refine button.")
			Session("dialogShown" & dbkey & formgroup)=true
		end if
		resetAtEnd dbkey, formgroup, Application("TooManyHitsMaximumRetrievable")
	end if
	'get shape statement for recordset. Only build is sesison("basers") is not an object
	Set Session("DETAIL_RS") = buildShapeRS(Session("DETAIL_RS"), dbkey, formgroup, display_view, false)

	
	
	if Application("EXCEL_INTEGRATION") = 1 and Application("FORMGROUP_EXCEL_INTEGRATION"& request("formgroup")) = 1 then
		if Not isObject(Session("DETAIL_RS_FULL")) then
			Set Session("DETAIL_RS_FULL") = buildShapeRS(Session("DETAIL_RS_FULL"), dbkey, formgroup, "detail_full", false)
		end if
	end if
	if Session("TooManyHitsToDisplay" & dbkey & formgroup)=true then
		if Not isObject(Session("LIST_RS")) then
			Set Session("LIST_RS") = buildShapeRS(Session("LIST_RS"), dbkey, formgroup, "list", true)
			MyRSArray = Session("Base_RS" & dbkey & formgroup)
		end if
	end if

	'get template definition from dictionary
	if bNoBase then
		template_definition = getXMLTemplate(dbkey, formgroup, DETAIL_CHILD)
	else
		template_definition = getXMLTemplate(dbkey, formgroup, DETAIL)
	end if
	'response.Write template_definition
	'response.end
	'create DOM and load template
	if Not isObject(Session("TemplateDom")) then 'if it is an object then don't recreate. Only wiped when edittin formgroup or creteing  new search
		Set Session("TemplateDom") = Server.CreateObject("MSXML2.FreeThreadedDOMDocument.4.0")
	end if
	if Application("BIOVIZ_INTEGRATION")=1 and Application("FORMGROUP_BIOVIZ_INTEGRATION"& request("formgroup")) = 1 then
		replace_sql = Session("SQL" & Session("hitlistid" & dbkey & formgroup))
		Session("chemfinderTemplate") = Replace(template_definition, "</DOCUMENT>", replace_sql & chr(10)& "</DOCUMENT>")
	end if
	if Application("EXCEL_INTEGRATION") = 1 and Application("FORMGROUP_EXCEL_INTEGRATION"& request("formgroup")) = 1 then
		session("template_definition_detail" & formgroup) = getXMLTemplate(dbkey, formgroup, DETAIL)
	end if
	
	
	Set displayDom =Session("TemplateDom")
	'response.Write template_definition
	
	displayDom.loadXML(template_definition)
	'modify template if necessary
	Set displayDom = SetSubTableBorderDisplay(displayDom)
	Set displayDom = SetHeaderRepeat(displayDom)
	if not bNoBase  then
		Set displayDom = StructureGetMethod(displayDom)
	end if
	if table_list <> "" then
		Set displayDom = TablesToShow(displayDom,table_list)
	end if
	
	if HideJS = true then
		Set displayDom = HideJSColumn(displayDom)
	end if
	order_by = ""
	'only reget definition if sortFields are present else set it to the current definition.
	if bNoBase = true then
		if hasChildren=true then
		
			set session("child_display_dom")=displayDom
			'check to see if child template is blank
			on error resume next
			
			if Not  displayDom.xml <> "" then
				output = ""
			else
				'just set the display temp and let the right from do the RS2HTML output so sorting can be picked up.
				order_by=request("sortFields")
				
				if isObject(Session("DETAIL_RS")) then
					output= output & RS2HTML(Session("DETAIL_RS"),displayDom,NULL,NULL,theIndex,theIndex,order_by,"","")
					output = replace(output, "_form_left.asp?", "_form_right.asp?")
					Session("RIGHT" & display_view & dbkey  & formgroup)=output
				else
					output="<BR>There are no fields in detail view. Please edit this form and add fields to this view."
				end if
				if instr(1, output, "Error in RS2HTML:") > 0 then
					TraceAndDisplayError "Error while converting RS to HTML in parseDetailTables()" ,err.Source, err.number, err.Description & "<BR>" & Session("DETAIL_RS").source & "<BR> HitlistID:" & Session("hitlistid" & dbkey & formgroup) 
				end if 
			end if
		end if
	else
		'set session("child_display_dom") = Nothing
		'session("child_display_dom")=""
		if Trim(Session("LEFT" & display_view & dbkey  & formgroup))= "" then
			'only put the order in if his is a report view otherwise the right frames sort gets wiped out when coming from list view
			if table_list <> "" then
				order_by=request("sortFields")
			else
				order_by =request("sortFields")
			end if
			

			if isObject(Session("DETAIL_RS")) then
				output= output & RS2HTML(Session("DETAIL_RS"),displayDom,NULL,NULL,theIndex,theIndex,order_by,"","")
			else
				output="<BR>There are no fields in detail view. Please edit this form and add fields to this view."
			end if
			if instr(1, output, "Error in RS2HTML:") > 0 then
				TraceAndDisplayError "Error while converting RS to HTML in parseDetailTables()" ,err.Source, err.number, err.Description & "<BR>" & Session("DETAIL_RS").source & "<BR> HitlistID:" & Session("hitlistid" & dbkey & formgroup) 
			end if 
		else
			output= output &  Session("LEFT" & display_view & dbkey  & formgroup)
		end if
	end if
	
	Trace "Out:parseDetailTables" & showErrorIfAny, 25
	parseDetailTables = output
End function

'build items for use in displaying tabs in the detail view
'called by <-getDisplayItems<-GetItems<-WriteDisplayItems

Function getDetailFieldsTab(formgroup, dbkey,  display_view, table_option)
		Trace "In:getDetailFieldsTab" & showErrorIfAny, 25

		Session("dbkey")= dbkey
		Session("formgroup") = formgroup
		Session("display_view") = display_view
		on error resume next
		dim i, output
		basetable = getbasetable(dbkey, formgroup, "basetable")
		baseid_name =  GetTableVal(dbkey, basetable, kPrimaryKey)
		'get shape statement for recordset. Only build is sesison("basers") is not an object
		Set Session("DETAIL_RS") = buildShapeRS(Session("DETAIL_RS"), dbkey, formgroup, display_view, false)
		if Application("EXCEL_INTEGRATION") = 1 and Application("FORMGROUP_EXCEL_INTEGRATION"& request("formgroup")) = 1 then
			if Not isObject(Session("DETAIL_RS_FULL")) then
				Set Session("DETAIL_RS_FULL") = buildShapeRS(Session("DETAIL_RS_FULL"), dbkey, formgroup, "detail_full", false)
			end if
		end if
		if Session("TooManyHitsToDisplay" & dbkey & formgroup)=true then
			if Not isObject(Session("LIST_RS")) then
				Set Session("LIST_RS") = buildShapeRS(Session("LIST_RS"), dbkey, formgroup, "list", true)
				MyRSArray = Session("Base_RS" & dbkey & formgroup)
			end if
		end if
		'get template definition from dictionary
		
		if Not isObject(Session("TemplateDom")) then 'if it is an object then don't recreate. Only wiped when edittin formgroup or creteing  new search
			Set Session("TemplateDom") = Server.CreateObject("MSXML2.FreeThreadedDOMDocument.4.0")
		end if
		Set displayDom = Session("TemplateDom") 
	
		on error resume next
		myItems = Split(Application("RS_DEFS" & display_view & dbkey & formgroup), ":CS_ITEM:", -1)
		if Session("TooManyHitsToDisplay" & dbkey & formgroup)=true then
		Session("Base_RSRecordCount" & dbkey & formgroup)= Application("TooManyHitsMaximumRetrievable")
		if Not Session("dialogShown" & dbkey & formgroup)=true then
			showmessagedialog("Your search found " & Session("hitlistrecordcount" & dbkey & formgroup) & " hits. \n Only the first " & Application("TooManyHitsMaximumRetrievable") & " hits of your search will be displayed.\n Your search returned more than the maximum allowable set by your administrator. \n You can refine your search over the full hitlist by clicking the refine button.")
			Session("dialogShown" & dbkey & formgroup)=true
		end if
		resetAtEnd dbkey, formgroup, Application("TooManyHitsMaximumRetrievable")
		end if

		if Session("sTab") = "" then Session("sTab") = "0"
		If sTab = "" Then sTab = Session("sTab") 
		Session("sTab") = request("TB")
		
		set TabView = Server.CreateObject("VASPTB.ASPTabView")

		TabView.Class = "TabView"
		TabView.ImagePath = "../graphics/images/tabview"
		TabView.BackColor = "#d3d3d3"
		TabView.SelectedBackColor = "#adadad"
		TabView.SelectedForeColor = ""
		TabView.SelectedBold = True
		TabView.BodyBackground = "#cococo"
		TabView.TabWidth = 0
		TabView.StartTab = "0"
		TabView.QueryString = "output_type=tab&dbname=" & dbkey & "&formgroup=" & formgroup & "&formmode=" & "edit"
		TabView.LicenseKey = "7993-3E51-698B"
		
		'output tab names
			
		for i = 0 to UBound(myItems)
			temp = split(myItems(i), ":CS_SUB_ITEM:", -1)
			TABLE_NAME =temp(0)
			
			if UCase(tables_option) = "CHECK_TABLES" and Session("strWhereSubforms" & dbkey & formgroup)<> "" then
				basetable = GetBaseTable(dbkey, formgroup, "basetable")
				table_list = basetable & "," & Session("strWhereSubforms" & dbkey & formgroup)
				
				Dim m
				Dim bShowTable 
				bShowTable= false
				table_array = Split(table_list, ",", -1)
			
				for m = 0 to UBound(table_array)
					if UCase(table_array(m)) = UCase(TABLE_NAME) then
						bShowTable = True
					end if
				next
			else
				bShowTable = true
			end if
			if bShowTable = true then
					DISPLAY_SQL_INF0 = temp(1)
					display_array = Split(DISPLAY_SQL_INF0, ":::", -1)
					TABLE_DISPLAY_NAME = Trim(display_array(0))
					if TABLE_DISPLAY_NAME <> "" then
						Set Tabx = TabView.Tabs.Add(i,TABLE_DISPLAY_NAME,"","",TABLE_DISPLAY_NAME)
						Tabx.Image = ""
						Tabx.SelectedImage = ""
					end if
			end if
		Next
		
		if bShowTable = true then
			output = output & TabView.ViewSource
			Set TabView = Nothing
			tab_name = Session("sTab") 
		
			Select Case UCase(tab_name)
				Case Session("sTab") 
					temp = split(myItems(Session("sTab")), ":CS_SUB_ITEM:", -1)
					TABLE_NAME =temp(0)
					if TABLE_NAME = basetable then
						template_definition = getXMLTemplate(dbkey, formgroup, DETAIL)
					else
						template_definition = getXMLTemplate(dbkey, formgroup, DETAIL_CHILD)
					end if
					if Application("BIOVIZ_INTEGRATION")=1 and Application("FORMGROUP_BIOVIZ_INTEGRATION"& request("formgroup")) = 1 then
						replace_sql = Session("SQL" & Session("hitlistid" & dbkey & formgroup))
						Session("chemfinderTemplate") = Replace(template_definition, "</DOCUMENT>", replace_sql & chr(10)& "</DOCUMENT>")
					end if
					if Application("EXCEL_INTEGRATION") = 1 and Application("FORMGROUP_EXCEL_INTEGRATION"& request("formgroup")) = 1 then
						session("template_definition_detail" & formgroup) = getXMLTemplate(dbkey, formgroup, DETAIL)
					end if
					displayDom.loadXML(template_definition)
					Set displayDom = HideCaptions(displayDom)
					Set displayDom = SetSubTableBorderDisplay(displayDom)
					Set displayDom = SetHeaderRepeat(displayDom)
					Set displayDom = TablesToShow(displayDom,TABLE_NAME)
					if TABLE_NAME = basetable then
						Set displayDom = StructureGetMethod(displayDom)
					end if
			End Select
		end if
		
		order_by = request("sortFields")
		if TABLE_NAME = basetable then
			order_by = ""
		end if
		

		if isObject(Session("DETAIL_RS")) then
			output= output & RS2HTML(Session("DETAIL_RS"),displayDom,NULL,NULL,theIndex,theIndex,order_by,"","")
		else
			output="<BR>There are no fields in detail view. Please edit this form and add fields to this view."
		end if
		if instr(1, output, "Error in RS2HTML:") > 0 then
			TraceAndDisplayError "Error while converting RS to HTML in getDetailFieldsTab()" ,err.Source, err.number, err.Description & "<BR>" & Session("DETAIL_RS").source & "<BR> HitlistID:" & Session("hitlistid" & dbkey & formgroup) 
		end if 
		Trace "Out:getDetailFieldsTab" & showErrorIfAny, 25
		getDetailFieldsTab = output
End Function

Function getDetailFrameTab(formgroup, dbkey,  display_view, table_option)
		Trace "In:getDetailFrameTab" & showErrorIfAny, 25
		
		Session("dbkey")= dbkey
		Session("formgroup") = formgroup
		Session("display_view") = display_view

		on error resume next
		dim i, output
		basetable = getbasetable(dbkey, formgroup, "basetable")
		baseid_name =  GetTableVal(dbkey, basetable, kPrimaryKey)
		'get shape statement for recordset. Only build is sesison("basers") is not an object
		Set Session("DETAIL_RS") = buildShapeRS(Session("DETAIL_RS"), dbkey, formgroup, display_view, false)
		if Application("EXCEL_INTEGRATION") = 1 and Application("FORMGROUP_EXCEL_INTEGRATION"& request("formgroup")) = 1 then
			if Not isObject(Session("DETAIL_RS_FULL")) then
				Set Session("DETAIL_RS_FULL") = buildShapeRS(Session("DETAIL_RS_FULL"), dbkey, formgroup, "detail_full", false)
			end if
		end if
		if Session("TooManyHitsToDisplay" & dbkey & formgroup)=true then
			if Not isObject(Session("LIST_RS")) then
				Set Session("LIST_RS") = buildShapeRS(Session("LIST_RS"), dbkey, formgroup, "list", true)
				MyRSArray = Session("Base_RS" & dbkey & formgroup)
			end if
		end if
		'get template definition from dictionary
		
		if Not isObject(Session("TemplateDom")) then 'if it is an object then don't recreate. Only wiped when edittin formgroup or creteing  new search
			Set Session("TemplateDom") = Server.CreateObject("MSXML2.FreeThreadedDOMDocument.4.0")
		end if
		Set displayDom = Session("TemplateDom") 
	
		on error resume next
		myItems = Split(Application("RS_DEFS" & display_view & dbkey & formgroup), ":CS_ITEM:", -1)
		
		if Session("TooManyHitsToDisplay" & dbkey & formgroup)=true then
		Session("Base_RSRecordCount" & dbkey & formgroup)= Application("TooManyHitsMaximumRetrievable")
		if Not Session("dialogShown" & dbkey & formgroup)=true then
			showmessagedialog("You search found " & Session("hitlistrecordcount" & dbkey & formgroup) & " hits. \n Only the first " & Application("TooManyHitsMaximumRetrievable") & " hits of your search will be displayed.\n Your search returned more than the maximum allowable set by your administrator. \n You can refine your search over the full hitlist by clicking the refine button.")
			Session("dialogShown" & dbkey & formgroup)=true
		end if
		resetAtEnd dbkey, formgroup, Application("TooManyHitsMaximumRetrievable")
		end if
		'stop
		if Session("sTab") = "" then Session("sTab") = "1"
		If sTab = "" Then sTab = Session("sTab") 
		if request("TB") <> "" then
			Session("sTab") = request("TB")
		end if
			
		set TabView = Server.CreateObject("VASPTB.ASPTabView")

		TabView.Class = "TabView"
		TabView.ImagePath = "../graphics/images/tabview"
		TabView.BackColor = "#d3d3d3"
		TabView.SelectedBackColor = "#adadad"
		TabView.SelectedForeColor = ""
		TabView.SelectedBold = True
		TabView.BodyBackground = "#cococo"
		TabView.TabWidth = 0
		TabView.StartTab = Session("sTab")
		'TabView.StartTab = "0"
		TabView.QueryString = "output_type=FRAMETAB&dbname=" & dbkey & "&formgroup=" & formgroup & "&formmode=" & "edit"
		TabView.LicenseKey = "7993-3E51-698B"
		
		'output tab names
			
		for i = 0 to UBound(myItems)
			temp = split(myItems(i), ":CS_SUB_ITEM:", -1)
			TABLE_NAME =temp(0)
			
			if UCase(tables_option) = "CHECK_TABLES" and Session("strWhereSubforms" & dbkey & formgroup)<> "" then
				basetable = GetBaseTable(dbkey, formgroup, "basetable")
				table_list = basetable & "," & Session("strWhereSubforms" & dbkey & formgroup)
				
				Dim m
				Dim bShowTable 
				bShowTable= false
				table_array = Split(table_list, ",", -1)
			
				for m = 0 to UBound(table_array)
					if UCase(table_array(m)) = UCase(TABLE_NAME) then
						bShowTable = True
					end if
				next
			else
				if table_option = "NO_BASETABLE" then
					'TABLE_NAME = temp(i)
					basetable = GetBaseTable(dbkey, formgroup, "basetable")
					if TABLE_NAME = basetable then
						bShowTable = false
					else
						bShowTable = true
					end if
				else
					bShowTable = true
				end if
			end if
			if bShowTable = true then
					'stop
					DISPLAY_SQL_INF0 = temp(1)
					display_array = Split(DISPLAY_SQL_INF0, ":::", -1)
					TABLE_DISPLAY_NAME = Trim(display_array(0))
					if TABLE_DISPLAY_NAME <> "" then
						Set Tabx = TabView.Tabs.Add(i,TABLE_DISPLAY_NAME,"","",TABLE_DISPLAY_NAME)
						Tabx.Image = ""
						Tabx.SelectedImage = ""
					end if
			end if
		Next
		
		if bShowTable = true then
			output = output & TabView.ViewSource
			Set TabView = Nothing
			tab_name = Session("sTab") 
		
			Select Case UCase(tab_name)
				Case Session("sTab") 
					temp = split(myItems(Session("sTab")), ":CS_SUB_ITEM:", -1)
					TABLE_NAME =temp(0)
					if TABLE_NAME = basetable then
						template_definition = getXMLTemplate(dbkey, formgroup, DETAIL)
					else
						template_definition = getXMLTemplate(dbkey, formgroup, DETAIL_CHILD)
					end if
					if Application("BIOVIZ_INTEGRATION")=1 and Application("FORMGROUP_BIOVIZ_INTEGRATION"& request("formgroup")) = 1 then
						replace_sql = Session("SQL" & Session("hitlistid" & dbkey & formgroup))
						Session("chemfinderTemplate") = Replace(template_definition, "</DOCUMENT>", replace_sql & chr(10)& "</DOCUMENT>")
					end if
					if Application("EXCEL_INTEGRATION") = 1 and Application("FORMGROUP_EXCEL_INTEGRATION"& request("formgroup")) = 1 then
						session("template_definition_detail" & formgroup) = getXMLTemplate(dbkey, formgroup, DETAIL)
					end if
					displayDom.loadXML(template_definition)
					Set displayDom = HideCaptions(displayDom)
					Set displayDom = SetSubTableBorderDisplay(displayDom)
					Set displayDom = SetHeaderRepeat(displayDom)
					Set displayDom = TablesToShow(displayDom,TABLE_NAME)
					if TABLE_NAME = basetable then
						Set displayDom = StructureGetMethod(displayDom)
					end if
			End Select
		end if
		
		order_by = request("sortFields")
		if TABLE_NAME = basetable then
			order_by = ""
		end if
		
		'JHS 12/27/2007 - if there were no detail fields selected an error was thrown
		if displayDom.xml <> "" then
			if isObject(Session("DETAIL_RS")) then
				output= output & RS2HTML(Session("DETAIL_RS"),displayDom,NULL,NULL,theIndex,theIndex,order_by,"","")
			else
				output="<BR>There are no fields in detail view. Please edit this form and add fields to this view."
			end if
		else
			output=""
		end if
		
		
		if instr(1, output, "Error in RS2HTML:") > 0 then
			TraceAndDisplayError "Error while converting RS to HTML in getDetailFieldsTab()" ,err.Source, err.number, err.Description & "<BR>" & Session("DETAIL_RS").source & "<BR> HitlistID:" & Session("hitlistid" & dbkey & formgroup) 
		end if 
		Trace "Out:getDetailFrameTab" & showErrorIfAny, 25
		getDetailFrameTab = output
End Function

'******************************************
'END DETAIL FORM GENERATION
'******************************************


'*************************
'START QUERY FORM GENERATION CODE
'*************************

'build items for display in input/query form
Function getQueryItems(formgroup, dbkey,  display_view)
	Trace "In:GetQueryItems" & showErrorIfAny, 25
	Session("LIST_RS") = ""
	Session("DISPLAY_RS") = ""
	Session("TooManyHitsToDisplay" & dbkey & formgroup) =false
	Session("show_child_data_toggles"& dbkey & formgroup)=""
	Session("dialogShown" & dbkey & formgroup)=""
	on error resume next
	myItems = Split(Application("RS_DEFS" & display_view & dbkey & formgroup), ":CS_ITEM:", -1)
	if UBound(myItems) > 0 then
		hasChildren = true
	else
		hasChildren = false
	end if
	Dim i
	Dim theList
	theList = Application("QUERY_ALL_FIELD_NAMES" & dbkey & formgroup)
	output = addSortBy(dbkey, formgroup)
	if hasChildren = true then
		output = output & ShowChildTableDataButtons(dbkey, formgroup)
	end if
	for i = 0 to UBound(myItems)
		Dim temp
		temp = split(myItems(i), ":CS_SUB_ITEM:", -1)
		TABLE_NAME=temp(0)
		DISPLAY_SQL_INF0 =temp(1)
		
		display_array = Split(DISPLAY_SQL_INF0, ":::", -1)
		
		TABLE_DISPLAY_NAME = display_array(0)
		on error resume next
		if NOT Application("FIELD_DEFS" & TABLE_NAME & display_view & dbkey & formgroup) = "NULL" then
			temp = Split(Application("FIELD_DEFS" & TABLE_NAME & display_view & dbkey & formgroup), ":CS_ITEM:", -1)
			output = output &  "<table class=""query_main_table"" width=""600"">"
			
			''jhs - implement collapse stuff
			useCollapse = Application("USE_COLLAPSE_INPUT_FORM")
			if useCollapse then
			
			    '******************************************************************
                'Code changes start here
                '******************************************************************
			    idi = Sessoin("FieldIdent") 'This variable will be used to give table rows unique IDs
    			
			    if not idi>0 then 'Increment variable every time, new child table is added to a search form
			    idi = 1
			    else
			    idi = idi+1
			    Session("FieldIdent") = idi
			    end if
    			
			    output = output &  "<br><tr><td class=""query_table_cell_header""></tr>"
    			
                'two buttons added to a table header. When clicked  they call javascript functions that collapse or expand rows .
				output = output &  " <tr><td class=""query_table_cell_header""><input type='button' id='button"& idi &"' style='width: 20px' value='+' onclick='togglenode("& idi & ")'/>" & server.HTMLEncode(TABLE_DISPLAY_NAME) & "</td></tr>"
    			
			    'due to the logic of page generation, the header row of the compound_molecule table with buttons is formed at the very beginning,
                'and the other part of the table if created at the end, so IDs of the buttons and table row do not match. 
                'so the compound_molecule table rows id is set to 100. Rows are formed collapsed.(display:none).
			    if  idi = 1 then
				output = output &  "<tr id='node100' style=""display:''""><td><table  width = ""80%"">"
			    else
			    output = output &  "<tr id='node" &Session("FieldIdent")&"' style=""display:none""><td><table  width = ""80%"">"
			    end if
			
			else
			    output = output &  " <tr><td class=""query_table_cell_header"">" & server.HTMLEncode(TABLE_DISPLAY_NAME) & "</td></tr>"
			    output = output &  "<tr><td><table  width = ""80%"">"
			end if
			
			
			
			Dim k
		
			for k=0 to UBound(temp)				
			
				temp2 = Split(temp(K), ":CS_SUB_ITEM:", -1)
				field_item = temp2(1)
				temp_array = split(field_item, ";;;", -1)
				displayname = temp_array(0)
				
				if isEmpty(temp_array(0)) and (instr(UCase(temp_array(1)), ".STRUCTURE") > 0 or instr(UCase(temp_array(1)), ".BASE64") > 0) then
					output = output &  "<td  width = ""40%"" align=""right"">&nbsp;</td>"
					output = output &  "<td class=""query_table_cell_header""><table ><tr><td>" & ParseAndReturnQueryFormFields(temp_array(1),"") & "</td></tr></table></td>"
				else
					output = output &  "<td class=""query_table_cell_name""  width = ""40%"" align=""right"">" & server.HTMLEncode(displayname) & "</td>"
					output = output &  "<td class=""query_table_cell_header"">" & ParseAndReturnQueryFormFields(temp_array(1),"") & "</td>"
				end if
				output = output &   "</tr>"
			next
		
			output = output &  "</td></tr></table>"
			
			'jhs add Collapse stuff
			
			if useCollapse then
			'After the table is formed the function is called to expand the node with the structure search field 
            'as it is probably the most commonly used
			output = output &  "</td></tr></table><script type=""text/javascript"">togglenode(1)</script>"
            '******************************************************************
            'Code changes end here
            '***************************************** *************************
			else
			    output = output &  "</td></tr></table>"	
			end if
			'end jhs
			
		end if
	next
	getQueryItems = output
	Trace "Out:GetQueryItems" & showErrorIfAny, 25	
End Function

Function getQueryBuilderFields(formgroup, dbkey,  display_view)
Trace "In:getQueryBuilderFields" & showErrorIfAny, 25
	output = ""

	output = output & getAvailableQueryBuilderFields(formgroup, dbkey,  display_view)
	output = output & "<select name=""theoperatortouse"">"
		output = output & "<option value=""="">=</option>"
		output = output & "<option value=""<>""><></option>"
		output = output & "<option value="">"">></option>"
		output = output & "<option value=""<""><</option>"
		output = output & "<option value=""CONTAINS"">CONTAINS</option>"
		output = output & "<option value=""STARTS WITH"">STARTS WITH</option>"
		output = output & "<option value=""ENDS WITH"">ENDS WITH</option>"
	output = output & "</select>"
	output = output & "<input type=""text"" name=""thesearchvalue"" />"
	output = output & "<a href=""javascript:void(0);"" onclick=""javascript:doQueryBuilder();return false;"">Add Parameter</a>"
	
	getQueryBuilderFields = output
Trace "Out:getQueryBuilderFields" & showErrorIfAny, 25	
End Function
'build items as hidden jhs display in input/query form
Function getAvailableQueryBuilderFields(formgroup, dbkey,  display_view)
	Trace "In:getAvailableQueryBuilderFields" & showErrorIfAny, 25
	Session("LIST_RS") = ""
	Session("DISPLAY_RS") = ""
	Session("TooManyHitsToDisplay" & dbkey & formgroup) =false
	Session("show_child_data_toggles"& dbkey & formgroup)=""
	Session("dialogShown" & dbkey & formgroup)=""
	on error resume next
	myItems = Split(Application("RS_DEFS" & display_view & dbkey & formgroup), ":CS_ITEM:", -1)
	if UBound(myItems) > 0 then
		hasChildren = true
	else
		hasChildren = false
	end if
	Dim i
	Dim theList
	theList = Application("QUERY_ALL_FIELD_NAMES" & dbkey & formgroup)
	output = ""
	output = addSortBy(dbkey, formgroup)
	if hasChildren = true then
		output = output & ShowChildTableDataButtons(dbkey, formgroup)
	end if
	output = output & "<br><br>"
	output = output & "<select name=""thefieldtosearch"">"
	for i = 0 to UBound(myItems)
		Dim temp
		temp = split(myItems(i), ":CS_SUB_ITEM:", -1)
		TABLE_NAME=temp(0)
		DISPLAY_SQL_INF0 =temp(1)
		
		display_array = Split(DISPLAY_SQL_INF0, ":::", -1)
		
		TABLE_DISPLAY_NAME = display_array(0)
		on error resume next
		if NOT Application("FIELD_DEFS" & TABLE_NAME & display_view & dbkey & formgroup) = "NULL" then
			temp = Split(Application("FIELD_DEFS" & TABLE_NAME & display_view & dbkey & formgroup), ":CS_ITEM:", -1)
			
			
			Dim k
		
			for k=0 to UBound(temp)				
			
				temp2 = Split(temp(K), ":CS_SUB_ITEM:", -1)
				field_item = temp2(1)
				temp_array = split(field_item, ";;;", -1)
				displayname = temp_array(0)
				
				if isEmpty(temp_array(0)) and (instr(UCase(temp_array(1)), ".STRUCTURE") > 0 or instr(UCase(temp_array(1)), ".BASE64") > 0) then
					'output = output &  "<td  width = ""40%"" align=""right"">&nbsp;</td>"
					'output = output &  "<td class=""query_table_cell_header""><table ><tr><td>" & ParseAndReturnQueryFormFields(temp_array(1),"") & "</td></tr></table></td>"
					'output = output & ParseAndReturnQueryFormFields(temp_array(1),"")
				else
					'output = output &  "<td class=""query_table_cell_name""  width = ""40%"" align=""right"">" & server.HTMLEncode(displayname) & "</td>"
					'output = output &  "<td class=""query_table_cell_header"">" & ParseAndReturnQueryFormFields(temp_array(1),"") & "</td>"
					output = output & getQueryBuilderOption(temp_array(1),"",TABLE_DISPLAY_NAME,displayname)
				end if
				'output = output &   "</tr>"
			next
		
			'output = output &  "</td></tr></table>"
			'output = output &  "</td></tr></table>"
		end if
	next
	output = output & "</select>"
	getAvailableQueryBuilderFields = output
	Trace "Out:getAvailableQueryBuilderFields" & showErrorIfAny, 25	
End Function
'Format and return cows formatted fields for result output
'called by getQueryItems<-getDisplayItems<-GetItems<-WriteDisplayItems
Function getQueryBuilderOption(inputstr, ByRef RS,tabledisplayname, displayname)
	Trace "In:getQueryBuilderOption" & showErrorIfAny, 25
	thearray = Split(inputstr, ":;:", -1)
	output_type = thearray(0)
	the_output_str = thearray(1)
	oArray = split(the_output_str, ",", -1)
	dbkey = oArray(0)
	formgroup = oArray(1)
	Select Case UCase(output_type)
	
		Case "SHOWINPUTFIELD"
			
			array_length = 4
			'theReturn=getShowInputField(oArray(0), oArray(1),oArray(2),oArray(3),oArray(4))
			
			if UCase(request("special")) = "EDIT_QUERY" then
				'fieldvalue = Session("SearchData" & oArray(2) &  dbkey & formgroup)
			
				'theReturn = "<input type = ""hidden"" value = """ & fieldvalue & """ name =""" & oArray(2) & """>"
				'jhs10/29/ - edit_query was not showing any options.....
				theReturn = "<option value=""" &  oArray(2) & """>" & tabledisplayname &  ": " & displayname & "</option>"
			
			else
				'theReturn = "<option value=""" &  oArray(2) & """>" & oArray(2) & "</option>"
				theReturn = "<option value=""" &  oArray(2) & """>" & tabledisplayname &  ": " & displayname & "</option>"

				'theReturn = "<input type = ""hidden"" value = """" name =""" & oArray(2) & """>"
			end if
		
		'jhs 10/29/2007 - First got rid of commented out code for this case
		'then commented out the entire case statement
		'Case "SHOWSELECTLIST"
		'	on error resume next
		'	
		'	theTemp = Split(oArray(4), ":*:", -1)
		'	table_name= theTemp(0)
		'	column_name = theTemp(1)
		'	if UCase(request("special")) = "EDIT_QUERY" then
		'		theReturn = "<option value=""" &  oArray(2) & """>" & displayname & "</option>"
		'	else
		'		theReturn = "<option value=""" &  oArray(2) & """>" & displayname & "</option>"
		'	end if
		'end commenting	
			
			
			
		'Case "SHOWSTRUCINPUTFIELD"
			'array_length = 7
			
			'ShowStrucInputField dbkey, formgroup,"MolTable.Structure","5","340","180", "AllOptions", "SelectList"
			'theReturn=getShowStrucInputField(oArray(0), oArray(1),oArray(2),oArray(3),oArray(4),oArray(5),oArray(6),oArray(7))
		End Select
	getQueryBuilderOption = theReturn
	Trace "Out:getQueryBuilderOption" & showErrorIfAny, 25
End Function
'build items as hidden jhs display in input/query form
Function getQueryItemsAllHidden(formgroup, dbkey,  display_view)
	Trace "In:getQueryItemsAllHidden" & showErrorIfAny, 25
	Session("LIST_RS") = ""
	Session("DISPLAY_RS") = ""
	Session("TooManyHitsToDisplay" & dbkey & formgroup) =false
	Session("show_child_data_toggles"& dbkey & formgroup)=""
	Session("dialogShown" & dbkey & formgroup)=""
	on error resume next
	myItems = Split(Application("RS_DEFS" & display_view & dbkey & formgroup), ":CS_ITEM:", -1)
	if UBound(myItems) > 0 then
		hasChildren = true
	else
		hasChildren = false
	end if
	Dim i
	Dim theList
	theList = Application("QUERY_ALL_FIELD_NAMES" & dbkey & formgroup)
	'output = addSortBy(dbkey, formgroup)
	if hasChildren = true then
		'output = output & ShowChildTableDataButtons(dbkey, formgroup)
	end if
	for i = 0 to UBound(myItems)
		Dim temp
		temp = split(myItems(i), ":CS_SUB_ITEM:", -1)
		TABLE_NAME=temp(0)
		DISPLAY_SQL_INF0 =temp(1)
		
		display_array = Split(DISPLAY_SQL_INF0, ":::", -1)
		
		TABLE_DISPLAY_NAME = display_array(0)
		on error resume next
		if NOT Application("FIELD_DEFS" & TABLE_NAME & display_view & dbkey & formgroup) = "NULL" then
			temp = Split(Application("FIELD_DEFS" & TABLE_NAME & display_view & dbkey & formgroup), ":CS_ITEM:", -1)
			'output = output &  "<table class=""query_main_table"" width=""600"">"
			'output = output &  " <tr><td class=""query_table_cell_header"">" & server.HTMLEncode(TABLE_DISPLAY_NAME) & "</td></tr>"
			'output = output &  "<tr><td><table  width = ""80%"">"
			Dim k
		
			for k=0 to UBound(temp)				
			
				temp2 = Split(temp(K), ":CS_SUB_ITEM:", -1)
				field_item = temp2(1)
				temp_array = split(field_item, ";;;", -1)
				displayname = temp_array(0)
				
				if isEmpty(temp_array(0)) and (instr(UCase(temp_array(1)), ".STRUCTURE") > 0 or instr(UCase(temp_array(1)), ".BASE64") > 0) then
					'output = output &  "<td  width = ""40%"" align=""right"">&nbsp;</td>"
					'output = output &  "<td class=""query_table_cell_header""><table ><tr><td>" & ParseAndReturnQueryFormFields(temp_array(1),"") & "</td></tr></table></td>"
					output = output & ParseAndReturnQueryFormFields(temp_array(1),"")
				else
					'output = output &  "<td class=""query_table_cell_name""  width = ""40%"" align=""right"">" & server.HTMLEncode(displayname) & "</td>"
					'output = output &  "<td class=""query_table_cell_header"">" & ParseAndReturnQueryFormFields(temp_array(1),"") & "</td>"
					output = output & ParseAndReturnHiddenFormFields(temp_array(1),"")
				end if
				'output = output &   "</tr>"
			next
		
			'output = output &  "</td></tr></table>"
			'output = output &  "</td></tr></table>"
		end if
	next
	getQueryItemsAllHidden = output
	Trace "Out:getQueryItemsAllHidden" & showErrorIfAny, 25	
End Function
Function getQueryItemsHidden(formgroup, dbkey,  display_view,show_table_list)
	Trace "In:getQueryItemsHidden" & showErrorIfAny, 25
	on error resume next
	show_table_array = split(show_table_list, ",", -1)
	Dim myItems
	Dim i
	Session("LIST_RS") = ""
	Session("DISPLAY_RS") = ""
	Session("TooManyHitsToDisplay" & dbkey & formgroup)=false
	Session("dialogShown" & dbkey & formgroup)=""
	myItems = Split(Application("RS_DEFS" & display_view & dbkey & formgroup), ":CS_ITEM:", -1)
		
	for i = 0 to UBound(myItems)
		Dim temp
		Dim myItems2
		temp = split(myItems(i), ":CS_SUB_ITEM:", -1)
		TABLE_NAME =temp(0)
		bShowTable = false
		for j = 0 to UBound(show_table_array)	
			if TABLE_NAME = UCase(show_table_array(j)) then
				bShowTable = true
			end if
		next
		DISPLAY_SQL_INF0 = temp(1)
		display_array = Split(DISPLAY_SQL_INF0, ":::", -1)
		TABLE_DISPLAY_NAME = display_array(0)
		
		output = addSortBy(dbkey, formgroup)
		output = output & ShowChildTableDataButtons(dbkey, formgroup)
		on error resume next
		if NOT Application("FIELD_DEFS" & TABLE_NAME & display_view & dbkey & formgroup) = "NULL" then
			temp = Split(Application("FIELD_DEFS" & TABLE_NAME & display_view & dbkey & formgroup), ":CS_ITEM:", -1)
			
			Dim k
			if bShowTable = true then
				output = output &  "<table class=""query_main_table"" width=""600"">"
				output = output &  "<tr><td  ><table  width = ""80%"">"
				
				for k=0 to UBound(temp)	
					temp2 = Split(temp(K), ":CS_SUB_ITEM:", -1)
					field_item = temp2(1)
				
					temp_array = split(field_item, ";;;", -1)
					displayname = temp_array(0)
				
					if isEmpty(temp_array(0)) and (instr(UCase(temp_array(1)), ".STRUCTURE") > 0 or instr(UCase(temp_array(1)), ".BASE64") > 0) then
						output = output &  "<td width = ""40%""  class=""query_table_cell_name"">&nbsp;</td>"
						output = output &  "<td class=""query_table_cell_value""><table border = ""1"" class=""query_main_table""><tr><td>" & ParseAndReturnQueryFormFields(temp_array(1),"") & "</td></tr></table></td>"

						'output = output &  "<td "  & " colspan = ""2""><table border = ""1""><tr><td>" & ParseAndReturnQueryFormFields(temp_array(1),"") & "</td></tr></table></td>"
					else
						output = output &  "<td class=""query_table_cell_name"" width = ""40%"">" & server.HTMLEncode(temp_array(0)) & "</td>"
						output = output &  "<td class=""query_table_cell_value""  >" & ParseAndReturnQueryFormFields(temp_array(1),"") & "</td>"
					end if
					output = output &   "</tr>"
				next
				output = output &  "</td></tr></table>"
				output = output &  "</td></tr></table>"
			else 'hide all the fields for this table
					for k=0 to UBound(temp)	
						temp2 = Split(temp(K), ":CS_SUB_ITEM:", -1)
						field_item = temp2(1)
						
						temp_array = split(field_item, ";;;", -1)
						displayname = temp_array(0)
						if isEmpty(temp_array(0)) and (instr(UCase(temp_array(1)), ".STRUCTURE") > 0 or instr(UCase(temp_array(1)), ".BASE64") > 0) then
						else
							output = output &   ParseAndReturnHiddenFormFields(temp_array(1),"") 
						end if
					next
			end if
		end if
	next
	getQueryItemsHidden = output
	Trace "Out:getQueryItemsHidden" & showErrorIfAny, 25
End Function

function getListButtonCode(fieldname)
	Trace "In:getListButtonCode" & showErrorIfAny, 25
	Dim theReturn
	
	theReturn = "<script language=""javascript"">"
	theReturn = theReturn & "getOpenFileButton('" & fieldname & "')"
	theReturn = theReturn & "</script>"
	getListButtonCode = theReturn
	Trace "Out:getListButtonCode" & showErrorIfAny, 25
End function


'query form show child table radio buttons
function ShowChildTableDataButtons(dbkey, formgroup)
	Trace "In:ShowChildTableDataButtons" & showErrorIfAny, 25
	if UCase(request("Special")) = "EDIT_QUERY" then
		selected_value = Session("add_childtable_criteria" & dbkey & formgroup)
		if UCase(Trim(selected_value)) = "LIMIT" then
			output = "<table><tr><td class=""query_table_cell_name"" nowrap>Show All Child Data<input type = ""radio"" name = ""add_childtable_criteria"" value=""SHOW_ALL"" >&nbsp;&nbsp;&nbsp;&nbsp;Show Only Child Data Matching Entered Criteria<input type = ""radio"" name = ""add_childtable_criteria"" value=""LIMIT"" checked></td></tr></table>"

		else
			output = "<table><tr><td class=""query_table_cell_name"" nowrap>Show All Child Data<input type = ""radio"" name = ""add_childtable_criteria"" value=""SHOW_ALL"" checked>&nbsp;&nbsp;&nbsp;&nbsp;Show Only Child Data Matching Entered Criteria<input type = ""radio"" name = ""add_childtable_criteria"" value=""LIMIT""></td></tr></table>"
		end if
		Session("add_childtable_criteria" & dbkey & formgroup)=""
	else
		if Application("SHOW_ONLY_CHILD_DATA_AS_DEFAULT") = 0 then
			Session("add_childtable_criteria" & dbkey & formgroup)=""
			output = "<table><tr><td class=""query_table_cell_name"" nowrap>Show All Child Data<input type = ""radio"" name = ""add_childtable_criteria"" value=""SHOW_ALL"" checked>&nbsp;&nbsp;&nbsp;&nbsp;Show Only Child Data Matching Entered Criteria<input type = ""radio"" name = ""add_childtable_criteria"" value=""LIMIT""></td></tr></table>"
		else
			Session("add_childtable_criteria" & dbkey & formgroup)=""
			output = "<table><tr><td class=""query_table_cell_name"" nowrap>Show All Child Data<input type = ""radio"" name = ""add_childtable_criteria"" value=""SHOW_ALL"" >&nbsp;&nbsp;&nbsp;&nbsp;Show Only Child Data Matching Entered Criteria<input type = ""radio"" name = ""add_childtable_criteria"" value=""LIMIT"" checked></td></tr></table>"
		end if
	end if
	ShowChildTableDataButtons = output
	Trace "Out:ShowChildTableDataButtons" & showErrorIfAny, 25
End function

'query form sort by drop down list
Function addSortBy(dbkey, formgroup)
	Trace "In:addSortBy" & showErrorIfAny, 25
	Dim theList
	theList = Application("QUERY_ALL_FIELD_NAMES" & dbkey & formgroup)

	basetable=getbasetable(dbkey, formgroup, "basetable")
	primaryKey = getTableVal(dbkey, basetable, kPrimaryKey)
	default_sort = basetable & "." & primarykey

	output =  "<table ><tr><td class=""query_table_cell_name"" nowrap>Sort Search By: " & BuildOrderByListBioSAR(dbkey, formgroup, theList,"", 0, "Select One...",default_sort)  
	output =  output &  BuildSortDirectionList(dbkey, formgroup) & "</td></tr><table>"
	addSortBy = output
	Trace "Out:addSortBy" & showErrorIfAny, 25
end function



Function BuildOrderByListBioSAR(dbkey, formgroup,inputstr, list_type,size, drop_down_label,default_sort)
	Trace "In:BuildOrderByListBioSAR" & showErrorIfAny, 25
	dim str
	if UCase(request("Special")) = "EDIT_QUERY" then
		selected_value = Session("Order_by" & dbkey & formgroup)
	else
		selected_value=""
	end if
	
	if instr(selected_value, ",")>0 then
		select_value_array = split(selected_value, ",")
		
		select_array = Split(inputstr, ",", -1)
		str = "<SELECT " & list_type & " size = """ & size & """ name=""ORDER_BY"">"
		if Not UCase(list_type) = "MULTIPLE" then
			str = str & "<OPTION  selected value=""" & default_sort & """>" & drop_down_label &   "</option>"
		end if
		for i = 0 to UBound(select_array)
			item_string = select_array(i)
			item_array = split(select_array(i), ":", -1)
			option_value =item_array(0)
			display_value =item_array(1)
			display_value=unprotectCommas(display_value)
			bItemFound = false
			for m=0 to UBound(select_value_array)
				if UCase(option_value) = UCase(select_value_array(m)) then
					bItemFound = true
				end if
			next
			if bItemFound = true then
				str = str & "<OPTION selected"  & " value=""" & option_value & """ id=""" &  server.HTMLEncode(display_value)  &  """>" & display_value & "</option>"
			else
				str = str & "<OPTION "  & " value=""" & option_value & """ id=""" &  server.HTMLEncode(display_value)  &  """>" & display_value & "</option>"
			end if
		next
		str = str & "</SELECT>"
	else
		select_array = Split(inputstr, ",", -1)
		str = "<SELECT " & list_type & " size = """ & size & """ name=""ORDER_BY"">"
		if Not UCase(list_type) = "MULTIPLE" then
			str = str & "<OPTION  selected value =""" & default_sort & """>" & drop_down_label &   "</option>"
		end if
		for i = 0 to UBound(select_array)
			item_string = select_array(i)
			item_array = split(select_array(i), ":", -1)
			option_value =item_array(0)
			display_value =item_array(1)
			display_value=unprotectCommas(display_value)
			if UCase(option_value) = UCase(selected_value) then
				str = str & "<OPTION selected"  & " value=""" & option_value & """ id=""" & display_value &  """>" & server.HTMLEncode(display_value) & "</option>"
			else
				str = str & "<OPTION "  & " value=""" & option_value & """ id=""" & display_value &  """>" & server.HTMLEncode(display_value)& "</option>"
			end if
		next
		str = str & "</SELECT>"
	end if
	BuildOrderByListBioSAR = str
	Trace "Out:BuildOrderByListBioSAR" & showErrorIfAny, 25
End function			
'Format and return cows formatted fields for result output
'called by getQueryItems<-getDisplayItems<-GetItems<-WriteDisplayItems


Function ParseAndReturnQueryFormFields(inputstr, ByRef RS)
	Trace "In:ParseAndReturnQueryFormFields" & showErrorIfAny, 25
	thearray = Split(inputstr, ":;:", -1)
	output_type = thearray(0)
	the_output_str = thearray(1)
	oArray = split(the_output_str, ",", -1)

	Select Case UCase(output_type)

		Case "SHOWINPUTFIELD"
			
			
			array_length = 4
			bAppendListCode = false
			if inStr(UCase(oArray(3)), "TEXTBOXALLOWLIST")>0 then
				oArray(3)="TEXTAREA:0"
				bAppendListCode = true
			end if
			theReturn=getShowInputField(oArray(0), oArray(1),oArray(2),oArray(3),oArray(4))
			if bAppendListCode = true then
				theReturn = theReturn & getListButtonCode(oArray(2))
			end if
	
		Case "SHOWSELECTLIST"
			'ShowLookUpList dbkey, formgroup,BaseRS,"Batches.Project_ID", Projects_List, Projects_Val,Projects_Text,0,true,"value","0" 
			on error resume next
			
			theTemp = Split(oArray(4), ":*:", -1)
			table_name= theTemp(0)
			column_name = theTemp(1)
			column_display_name = theTemp(2)
			sort_direction =  theTemp(3)
			'limit list to no more then 300 items
			sql = "Select " & table_name & "." & column_name & "," & table_name & "." & column_display_name & " from " & table_name  & " where rownum <1001 order by " &  column_display_name  & " " &  sort_direction
			
			Set userConn = getUserConn()
			Set cmd = server.CreateObject("ADODB.command")
			Set RS2 = server.CreateObject("ADODB.recordset")
			cmd.ActiveConnection =  userConn
			cmd.CommandType = adCmdText
			cmd.CommandText = sql
			RS2.Open cmd
			lookup_list = GetLookupList(RS2, column_name,column_display_name)
			
			RS2.Close
			array_length = 10
			
			if isObject(RS)then
				on error resume next
				list_val = RS(oArray(3))
				
				if err.number <> 0 and  isEmpty(list_val) then
					err.clear
					
					temp = split(oArray(3), ".", -1)
					fieldname = temp(Ubound(temp))
					list_val =  RS(fieldname)
				end if
				
				sql = "Select " & column_display_name & " from " & table_name & " where " & column_name & "= " &  list_val
			on error resume next
				
				Set RS2 = userConn.Execute(sql)
				list_text = RS2(column_display_name).value
			
				theReturn= getShowLookUpList(oArray(0), oArray(1),RS,oArray(3),lookup_list,list_val,list_text,oArray(7),oArray(8),oArray(9),oArray(10))
			else
				list_val=""
				list_text= ""
				theReturn= getShowLookUpList(oArray(0), oArray(1),"",oArray(3),lookup_list,list_val,list_text,oArray(7),oArray(8),oArray(9),oArray(10))
			end if
			CloseRS(RS2)
		
			
		Case "SHOWSTRUCINPUTFIELD"
			array_length = 7
			'Application("ENABLE_SEARCH_SDFILE")=1
			'if Application("ENABLE_SEARCH_SDFILE") = 1 then
			'end if'ShowStrucInputField dbkey, formgroup,"MolTable.Structure","5","340","180", "AllOptions", "SelectList"
		
			theReturn= getShowStrucInputField(oArray(0), oArray(1),oArray(2),oArray(3),oArray(4),oArray(5),oArray(6),oArray(7))
			
		End Select
	Trace "Out:ParseAndReturnQueryFormFields" & showErrorIfAny, 25
	ParseAndReturnQueryFormFields = theReturn
	
End Function


'Format and return cows formatted fields for result output
'called by getQueryItems<-getDisplayItems<-GetItems<-WriteDisplayItems
Function ParseAndReturnHiddenFormFields(inputstr, ByRef RS)
	Trace "In:ParseAndReturnHiddenFormFields" & showErrorIfAny, 25
	
	thearray = Split(inputstr, ":;:", -1)
	output_type = thearray(0)
	the_output_str = thearray(1)
	oArray = split(the_output_str, ",", -1)
	dbkey = oArray(0)
	formgroup = oArray(1)
	Select Case UCase(output_type)
	
		Case "SHOWINPUTFIELD"
			
			array_length = 4
			'theReturn=getShowInputField(oArray(0), oArray(1),oArray(2),oArray(3),oArray(4))
			
			if UCase(request("special")) = "EDIT_QUERY" then
				fieldvalue = Session("SearchData" & oArray(2) &  dbkey & formgroup)
			
				theReturn = "<input type = ""hidden"" value = """ & fieldvalue & """ name =""" & oArray(2) & """>"
			else
				theReturn = "<input type = ""hidden"" value = """" name =""" & oArray(2) & """>"
			end if
		
		Case "SHOWSELECTLIST"
			'ShowLookUpList dbkey, formgroup,BaseRS,"Batches.Project_ID", Projects_List, Projects_Val,Projects_Text,0,true,"value","0" 
			on error resume next
			
			theTemp = Split(oArray(4), ":*:", -1)
			table_name= theTemp(0)
			column_name = theTemp(1)
			if UCase(request("special")) = "EDIT_QUERY" then
				fieldvalue = Session("SearchData" & oArray(3) &  dbkey & formgroup)
				theReturn = "<input type = ""hidden"" value = """ & fieldvalue & """ name =""" & oArray(3) & """>"
			else
				theReturn = "<input type = ""hidden"" value = """" name =""" & oArray(3) & """>"
			end if
			
		Case "SHOWSTRUCINPUTFIELD"
			array_length = 7
			
			'ShowStrucInputField dbkey, formgroup,"MolTable.Structure","5","340","180", "AllOptions", "SelectList"
			theReturn=getShowStrucInputField(oArray(0), oArray(1),oArray(2),oArray(3),oArray(4),oArray(5),oArray(6),oArray(7))

		End Select

	ParseAndReturnHiddenFormFields = theReturn
	Trace "Out:ParseAndReturnHiddenFormFields" & showErrorIfAny, 25
End Function

'*************************
'END QUERY FORM GENERATION CODE
'*************************

'*************************************
'START ALL FORM UTILITIES
'*************************************
Function getAllTablesList(dbkey, formgroup, display_view)
		Trace "In:getAllTablesList" & showErrorIfAny, 25
		if Not Session("table_list" & dbkey & formgroup & display_view) <> "" then
			myItems = Split(Application("RS_DEFS" & display_view & dbkey & formgroup), ":CS_ITEM:", -1)
			for i = 0 to  UBound(myItems)
				temp = split(myItems(i), ":CS_SUB_ITEM:", -1)
				TABLE_NAME=temp(0)
				theList = addto_string(theList, TABLE_NAME, ",")
			next
			Session("table_list" & dbkey & formgroup & display_view) = theList
		end if
		getAllTablesList=Session("table_list" & dbkey & formgroup & display_view)
		Trace "Out:getAllTablesList" & showErrorIfAny, 25
end function

function getFormPath(dbkey, formgroup, formtype)
	Trace "In:getFormPath" & showErrorIfAny, 25

	select Case UCase(formtype)
		case "LIST"
			result_page = getFormgroupVal(dbkey, formgroup, kResultFormPath)
			if inStr(result_page, ";")> 0 then
				result_page_array = split(result_page, ";", -1)
				theReturn = result_page_array(0)
			else
				theReturn  = result_page
			end if
		case "QUERY"
			result_page = getFormgroupVal(dbkey, formgroup, kInputFormPath)
			
			theReturn  = result_page
			
		case "DETAIL"
			result_page = getFormgroupVal(dbkey, formgroup, kResultFormPath)
			if inStr(result_page, ";")> 0 then
				result_page_array = split(result_page, ";", -1)
				theReturn = result_page_array(1)
			else
				theReturn  = result_page
			end if
		Case "NO_FRAME"
			result_page = getFormgroupVal(dbkey, formgroup, kResultFormPath)
			if inStr(result_page, ";")> 0 then
				result_page_array = split(result_page, ";", -1)
				temp = result_page_array(1)
			else
				temp  = result_page
			end if
			theReturn = replace(temp, "form.asp", "form_noframe.asp")
		case "DETAIL_SHORT"
			result_page = getFormgroupVal(dbkey, formgroup, kResultFormPath)
			if inStr(result_page, ";")> 0 then
				result_page_array = split(result_page, ";", -1)
				temp = result_page_array(1)
			else
				temp  = result_page
			end if
			
			if Instr(temp, "/")> 0 then
				temp2 = split(temp, "/", -1)
				theReturn = temp2(Ubound(temp2))
			else
				theReturn = temp
			end if
		Case "NO_FRAME_SHORT"
			result_page = getFormgroupVal(dbkey, formgroup, kResultFormPath)
			if inStr(result_page, ";")> 0 then
				result_page_array = split(result_page, ";", -1)
				temp = result_page_array(1)
			else
				temp  = result_page
			end if
			temp = replace(temp, "form.asp", "form_noframe.asp")
			if Instr(temp, "/")> 0 then
				temp2 = split(temp, "/", -1)
				theReturn = temp2(Ubound(temp2))
			else
				theReturn = temp
			end if
		case "LIST_SHORT"
			result_page = getFormgroupVal(dbkey, formgroup, kResultFormPath)
			if inStr(result_page, ";")> 0 then
				result_page_array = split(result_page, ";", -1)
				temp = result_page_array(0)
			else
				temp  = result_page
			end if
			if Instr(temp, "/")> 0 then
				temp2 = split(temp, "/", -1)
				theReturn = temp2(Ubound(temp2))
			else
				theReturn = temp
			end if
		case "QUERY_SHORT"
			result_page = getFormgroupVal(dbkey, formgroup, kInputFormPath)
			temp  = result_page
			if Instr(temp, "/")> 0 then
				temp2 = split(temp, "/", -1)
				theReturn = temp2(Ubound(temp2))
			else
				theReturn = temp
			end if
	end select
	getFormPath = theReturn
	Trace "Out:getFormPath" & showErrorIfAny, 25
end function

'simple function to format mark and records count in list and detail form view.
'called by several
'getDetailFields<-getDisplayItems<-GetItems<-WriteDisplayItems for detail  view
'getListFields<-getDisplayItems<-GetItems<-WriteDisplayItems for list view

Function getJScriptButtons(unique_id)
	Trace "In:getJScriptButtons" & showErrorIfAny, 25

	Dim output
	output =""
	display_view = session("display_view")
	formgroup  = session("formgroup")
	dbkey  = session("dbkey")
	basetable = getbasetable(dbkey, formgroup, "basetable")
	
	totalrecords = Session("Base_RSRecordCount" & dbkey & formgroup)
	'baseid =  "#" & UCase(GetTableVal(dbkey, basetable, kPrimaryKey)) & "#"
	
	indexValue = getIndexValue(unique_id, dbkey, formgroup)
	'Response.Write indexValue
	record_number = indexValue + 1
	
	Select Case UCase(display_view)
		Case "DETAIL"
			'output = output & "Record:<br>" & record_number & " of "  & totalRecords
			output = output & "&nbsp;<script language=""JavaScript"">"
			output = output & "getMarkBtn(" & unique_id & ");"
			output = output & "</script>"
		Case "LIST"
			
			if request("sortFields") <> "" then
				addSort = quotedString("&sortFields=" & request("sortFields"))
			else
				addSort = "null"
			end if
			blankentry = "null"
			result_page_path=getFormPath(dbkey, formgroup, "DETAIL")
			output = output & "&nbsp;&nbsp;Record:<br>&nbsp;&nbsp;" & record_number & " of "  & totalrecords
			output = output & "<br><br>&nbsp;<script language=""JavaScript"">"
			output = output & "getMarkBtn(" & unique_id & ");"
			output = output & "</script>"
			output = output & "<br>&nbsp;<script language=""JavaScript"">"
			
			output = output & "getFormViewBtn(""show_details_btn.gif""," & quotedString(result_page_path) & "," & record_number & "," & blankentry & "," & blankentry & "," & blankentry & "," & addSort & ")"
			output = output & "</script>"
	end Select
	getJScriptButtons= output
	Trace "Out:getJScriptButtons" & showErrorIfAny, 25
End Function


Function ShowBlobColumn(url, displayOption, isNullBlob)
	Trace "In:ShowBlobColumn" & showErrorIfAny, 25

	Dim sOut
	helpText = ""
	disabledText = " "
	
	
	select case Ucase(displayOption)
		case "IN_LINE"
			if Cbool(isNullBlob) then
				helpText = "Image not available"
				url = "/cfserverasp/source/graphics/noimage.gif"
			end if	
			sOut = sOut  & "<img  src=""" & url & """ alt=""" & helpText & """>"
		case "NEW_WINDOW"
			helpText = "Click to view image"
			if Cbool(isNullBlob) then
				helpText = "Image not available"
				url="#"
				disabledText = " disabled "
				disabledLink = " onclick=""return false;"" "
			end if	
			sOut = sOut  & "<a href=""" & url & """ target=""_new""" & disabledText & disabledLink &  " Title=""" & helpText & """>image link</a>"
	End select
		
	ShowBlobColumn = sOut
	Trace "Out:ShowBlobColumn" & showErrorIfAny, 25
end Function


Function ShowAsHyperlink(url)
	Trace "In:ShowAsHyperlink" & showErrorIfAny, 25
	
	Dim sOut
	helpText = "Click to view content"
	disabledText = " "
	
	if url = "" then
		helpText = "Link not available.  This database value is blank"
		disabledText = " disabled "
		disabledLink = " onclick=""return false;"" "
	end if

	sOut = "<a href=""" & url & """ target=""_new""" & disabledText & disabledLink &  " Title=""" & helpText & """>link</a>"
		
	ShowAsHyperlink = sOut
	Trace "Out:ShowAsHyperlink" & showErrorIfAny, 25
end Function



Function getIndexValue(unique_id, dbkey, formgroup)
	Trace "In:getIndexValue" & showErrorIfAny, 25
	
	on error resume next
	for i = 0 to UBound(MyRSArray,2)
		if Cstr(MyRSArray(0,i)) = Cstr(unique_id) then
			indexValue = i
			exit for
		end if
	next
	err.Clear()
	getIndexValue = indexValue
	Trace "Out:getIndexValue" & showErrorIfAny, 25
End Function

Sub ShowRSIndexValues(byRef theArray)
	Trace "In:ShowRSIndexValues" & showErrorIfAny, 25
	
	Response.Write "ShowRSIndexValues" & "<br>"
	for i = 0 to UBound(theArray,2)
		response.write i & ":" & theArray(0,i) & "<br>"
	next
	Trace "Out:ShowRSIndexValues" & showErrorIfAny, 25
End Sub

'toggle buttons
function addToggles(dbkey, formgroup, Layout, ChildData, WordDoc, Spreadsheet,bioViz, hasChildren,noTableTag)
	Trace "In:addToggles" & showErrorIfAny, 25
	
	if detectIE5 = true then 
		
		buttonTD = "<td bgcolor=""#CCCCCC"" nowrap >"
		if noTableTag = false then
			output = "<table border = ""0""><tr>"
		end if
		if Layout = true then
			output = output & buttonTD & "<input type = ""hidden"" name=""COLUMN_LAYOUT"" value = """ & column_layout & """>"
			output = output & "<a href=""#"" onClick=""toggleColumnLayout();return false"">Toggle Layout&nbsp;&nbsp;</a></td>"
		end if
		if hasChildren = true then
			if Session("show_child_data_toggles"& dbkey & formgroup) = true then
				if ChildData = true then
					output = output & buttonTD & "<input type = ""hidden"" name=""CHILD_DATA_DISPLAY"" value = """ & CHILD_DATA_DISPLAY & """>"
					output = output & "<a href=""#""  onClick=""toggleDataDisplay();return false"">Toggle Child Data</a></td>"
				end if
			end if
		end if
		'if wordDoc = true then
				'output = output  & buttonTD &  "<a href='#' onclick= 'MainWindow.doShowWordDoc(&quot;" & current_index & "&quot;,&quot;" & tPageSize & "&quot;,&quot;" & request("sortFields") & "&quot;)'>Show as Document</a></td>"
		'end if
		
		if Application("EXCEL_INTEGRATION")=1 and Application("FORMGROUP_EXCEL_INTEGRATION"& request("formgroup")) = 1 then
			if spreadSheet = true then
					output = output  & buttonTD &  "<a href='#' onclick= 'MainWindow.doShowSpreadsheet(&quot;" & current_index & "&quot;,&quot;" & tPageSize & "&quot;,&quot;" & request("sortFields") & "&quot;)'>Display In Excel</a></td>"
			end if
		end if
		if Application("BIOVIZ_INTEGRATION")=1 and Application("FORMGROUP_BIOVIZ_INTEGRATION"& request("formgroup")) = 1 then
			if bioviz = true then
					output = output  & buttonTD &  "<a href='#' onclick= 'MainWindow.doShowBioViz(&quot;" & current_index & "&quot;,&quot;" & tPageSize & "&quot;,&quot;" & request("sortFields") & "&quot;)'>Display In BioViz</a></td>"
			end if
		end if
		if Application("SHOW_SUBTABLE_HEADERS_ONCE") AND Session("ShowSlidderControls") then
			output = output & "<td class=""query_table_cell_name"" nowrap>&nbsp;&nbsp;&nbsp;Sliding Table Header: On<input type =""radio"" name=""disableSlider"" onclick=""saveSliderDefault(document.cows_input_form.disableSlider)"" value=""false"">&nbsp;Off<input type =""radio"" name =""disableSlider"" onclick=""saveSliderDefault(document.cows_input_form.disableSlider)"" value=""false""><script>setSliderDefault(document.cows_input_form.disableSlider)</script></td>"
			output = output & "<td class=""query_table_cell_name"" nowrap>&nbsp;&nbsp;&nbsp;Sliding First Column: On<input type =""radio"" name=""disableColSlider"" onclick=""saveSliderDefault(document.cows_input_form.disableColSlider)"" value=""false"">&nbsp;Off<input type =""radio"" name =""disableColSlider"" onclick=""saveSliderDefault(document.cows_input_form.disableColSlider)"" value=""false""><script>setSliderDefault(document.cows_input_form.disableColSlider)</script></td>"
		end if
		if noTableTag = false then
			output = output & "</tr></table></td>"
		end if 
	
	else
		
	
	
		buttonTD = "<td bgcolor=""#CCCCCC"" nowrap style="" border-width:0px; padding-top:4;padding-bottom:4;padding-left:4;padding-right:4;"">"
		if noTableTag = false then
			output = "<table border = ""0""><tr>"
		end if
		if Layout = true then
			output = output & buttonTD & "<input type = ""hidden"" name=""COLUMN_LAYOUT"" value = """ & column_layout & """>"
			output = output & "<a href=""#"" class=""ButtonBar"" onClick=""toggleColumnLayout();return false"">Toggle Layout&nbsp;&nbsp;</a></td>"
		end if
		if hasChildren = true then
			if Session("show_child_data_toggles"& dbkey & formgroup) = true then
				if ChildData = true then
					output = output & buttonTD & "<input type = ""hidden"" name=""CHILD_DATA_DISPLAY"" value = """ & CHILD_DATA_DISPLAY & """>"
					output = output & "<a href=""#"" class=""ButtonBar""  onClick=""toggleDataDisplay();return false"">Toggle Child Data</a></td>"
				end if
			end if
		end if
		'if wordDoc = true then
				'output = output  & buttonTD &  "<a href='#'  class=""ButtonBar"" onclick= 'MainWindow.doShowWordDoc(&quot;" & current_index & "&quot;,&quot;" & tPageSize & "&quot;,&quot;" & request("sortFields") & "&quot;)'>Show as Document</a></td>"
		'end if
		if Application("EXCEL_INTEGRATION")=1 and Application("FORMGROUP_EXCEL_INTEGRATION"& request("formgroup")) = 1 then
			if spreadSheet = true then
				output = output  & buttonTD &  "<a href='#'  class=""ButtonBar"" onclick= 'MainWindow.doShowSpreadsheet(&quot;" & current_index & "&quot;,&quot;" & tPageSize & "&quot;,&quot;" & request("sortFields") & "&quot;);return false'>Display In Excel</a></td>"
			end if
		end if 
		
		if Application("BIOVIZ_INTEGRATION")=1 and Application("FORMGROUP_BIOVIZ_INTEGRATION"& request("formgroup")) = 1 then
				if bioviz = true then
						output = output  & buttonTD &  "<a href='#' class=""ButtonBar""  onclick= 'MainWindow.doShowBioViz(&quot;" & current_index & "&quot;,&quot;" & tPageSize & "&quot;,&quot;" & request("sortFields") & "&quot;);return false'>Display In BioViz</a></td>"
				end if
		end if
		if Application("SHOW_SUBTABLE_HEADERS_ONCE") AND Session("ShowSlidderControls") then
			output = output & "<td class=""query_table_cell_name"" nowrap>&nbsp;&nbsp;&nbsp;Sliding Table Header: On<input type =""radio"" name=""disableSlider"" onclick=""saveSliderDefault(document.cows_input_form.disableSlider)"" value=""false"">&nbsp;Off<input type =""radio"" name =""disableSlider"" onclick=""saveSliderDefault(document.cows_input_form.disableSlider)"" value=""false""><script>setSliderDefault(document.cows_input_form.disableSlider)</script></td>"
			output = output & "<td class=""query_table_cell_name"" nowrap>&nbsp;&nbsp;&nbsp;Sliding First Column: On<input type =""radio"" name=""disableColSlider"" onclick=""saveSliderDefault(document.cows_input_form.disableColSlider)"" value=""false"">&nbsp;Off<input type =""radio"" name =""disableColSlider"" onclick=""saveSliderDefault(document.cows_input_form.disableColSlider)"" value=""false""><script>setSliderDefault(document.cows_input_form.disableColSlider)</script></td>"
		end if
		if noTableTag = false then
			output = output & "</tr></table></td>"
		end if
	end if
	addToggles = output
	Trace "Out:addToggles" & showErrorIfAny, 25
end function
'*************************************
'END ALL FORM UTILITIES
'*************************************

'**************************************
'START RS GENERATION CODE
'**************************************

Function buildShapeRS(byRef RS, dbkey, formgroup, display_view,repop_basers)
	
	Trace "In:buildShapeRS" & showErrorIfAny, 25

	if Session("hitlistid" & dbkey & formgroup) ="" or Session("hitlistid" & dbkey & formgroup) ="0" then
		Trace "Session(""hitlistid"" & dbkey & formgroup)=" & Session("hitlistid" & dbkey & formgroup), 25
		Response.Write "<BR><Br>Your hitlist has expired do to a prolonged time of inactivity.<BR> You will need to repeat your query in order to display the results."
		Response.Write "<BR><BR>"
		
		Response.End
	End if

	'response.Write struc_fields
	Session("table_errors") = ""
	'DGB changed isEmpty for isObject test.  Because isEmpty could not handle RS.
	if not isObject(RS) then
		'open dictionary stored sql
		dim myItems
		if display_view = "detail_full" then
			overridedetailSQL = true
			display_view = "detail"
		else
			overridedetailSQL = false
		end if
			myItems = Split(Application("RS_DEFS" & display_view & dbkey & formgroup), ":CS_ITEM:", -1)
		
		dim cmd
		dim shapeconn
		on error resume next
		'create nes connection using datashapper]
		Set shapeConn = getShapeConn()
		
		Set cmd = CreateObject("ADODB.Command")
		cmd.ActiveConnection =  shapeConn
		cmd.CommandType = adCmdText
		if bTrace = true then
			sql = "ALTER SESSION SET SQL_TRACE=TRUE"
			cmd.commandtext = sql
			cmd.execute 
		end if  
		on error resume next
			'begin looping through dictionary to pull table sql definitions and build shape
		'logaction("display_start" & Time())
		Dim ChildShape
		Dim ShapeStatement
		if bInLine = false then
			struc_fields_list = getStrucFieldList(dbkey, formgroup)
			if struc_fields_list <> "" then
				struc_field_array = split(struc_fields_list, ",", -1)
			end if
		else	
			struc_fields_list=""
		end if
		
		for i = 0 to  UBound(myItems)
			if CDD_TIMER = true or DebugBioSAR = true then
				t0 = timer()
			end if
			temp = split(myItems(i), ":CS_SUB_ITEM:", -1)
			TABLE_NAME =temp(0)
			temp_TABLE_NAME_SHORT= split(TABLE_NAME, ".", -1)
			TABLE_NAME_SHORT = temp_TABLE_NAME_SHORT(UBound(temp_TABLE_NAME_SHORT))
			DISPLAY_SQL_INF0 =temp(1)
			
			if i = 0 then
				basetable = b(0)
			end if
			display_array = Split(DISPLAY_SQL_INF0, ":::", -1)
			DISPLAY_NAME = display_array(0)
			'RS_NAME = replace(display_array(1), ".", "_")
			RS_NAME = replace(replace(display_array(1), ".", "_"),"$","_D_")
			DISPLAY_SQL = getRSDisplaySQL(display_array(2),display_view )
			if struc_fields_list <> "" then
				DISPLAY_SQL=removeStrucFromSelect(DISPLAY_SQL, struc_field_array)
			end if
		
			CHILD_LINKS = getRSChildLinks(display_array(2), display_view)
			PARENT_LINKS = getRSParentLinks(display_array(2), display_view)
			
			sql = ""
			Shapestr0 = ""
			sql = DISPLAY_SQL
			if overridedetailSQL = true then
				'format sql to pull all the hits rather then 1. This is for excel integration
				sql = trim(ParseRSString2(dbkey, formgroup, sql,"detail_full"))
			else
				sql = trim(ParseRSString2(dbkey, formgroup, sql,display_view))
			end if
			
			if sql <> "" then
			
				if i = 0 then 'the base table
					baseRS = RS_NAME
					if display_view = "DETAIL" then
						baseSQL = replaceBaseTablePlaceholders(dbkey, formgroup,"", sql)
					else
						baseSQL = replaceBaseTablePlaceholders(dbkey, formgroup,session("order_by" & dbkey & formgroup), sql)
					end if
					ShapeStatement =  " SHAPE {" & baseSQL & "}"
					temp = split(shapeConn.ConnectionString, ";", -1)
					for l = 0 to UBound(temp)
						if inStr(UCase(temp(l)), "DATA SOURCE")> 0 then
							temp2=split(temp(l), "=", -1)
							sServer = temp2(1)
						end if
					next
					
					sUser = Session("UserName" & dbkey)
					'sPwd = Session("UserID" & dbkey)
					'encryt password
					
					if Application("STORE_ENCRYPTED_PWD_IN_BIOVIZ_XML") then
						sPwd =  DoBSEncryptDecryptCommand("ENCRYPT",Session("UserID" & dbkey), UCase(trim("BIOSARDB")))
					else
						sPwd = ""
					end if
					
					if UCase(Display_view) = "LIST" then
						view_display_tag = "_L"
					end if
					if UCase(Display_view) = "DETAIL" then
						view_display_tag = "_D"
					end if
					
					ViewName = "BIOSARDB." & TruncateViewName(TABLE_NAME_SHORT,i,"_" & formgroup & view_display_tag, 26)
					Session("SQL" & Session("hitlistid" & dbkey & formgroup)) = "<CONNECT SERVER=""" & sServer & """ USER=""" & sUser & """ PASSWORD=""" & sPwd & """>" & chr(10) & "</CONNECT>" & chr(10) & "<FORMGROUP_INFO FORMGROUP_ID=""" & formgroup & """  NAME=""" & Server.HTMLEncode(Application("formgroup_full_name" & dbkey & formgroup)) & """ DESCRIPTION=""" & Server.HTMLEncode(Application("formgroup_description" & dbkey & formgroup)) & """ >" & chr(10) & "</FORMGROUP_INFO>" & chr(10) & "<HITLISTID_INFO HITLISTID=""" & Session("hitlistid" & dbkey & formgroup) & """>" & chr(10) & "</HITLISTID_INFO>" & chr(10) & "<SQL_INFO>" & chr(10) & "<TABLE NAME=""" & TABLE_NAME & """  VIEW_NAME=""" & ViewName & """ DISPLAY_NAME=""" & DISPLAY_NAME & """  />"
				else
					
					if CHILD_DATA_DISPLAY = "LIMIT" then
					
						'logaction("before_modify" & sql)
						sql = AddChildTableCriteria( dbkey, formgroup, TABLE_NAME, sql)
						sql = modifySql(sql)
						'logaction("modify" & sql)
					end if 
					'aliasName = replace(RS_NAME, ".", "_") & "pre"
					aliasName = replace(replace(RS_NAME, ".", "_"),"$","_D_") & "pre"
					if overridedetailSQL = true then
						aliasName = aliasName & "2"
					end if
					
					on error resume next
					'sql = replace(sql, "?", Session("hitlistid" & dbkey & formgroup))
					if session("allInnerSorts") <> "" then
						childSort = GetLastWidgetChildTableSort(TABLE_NAME)
						if childSort <> "" then
							sql = sql & " ORDER BY " & childSort
						end if
		        '-- CSBR ID: 127416
		        '-- Change Done by : Manoj Unnikrishnan
		        '-- Purpose: Deliberate set to use child table order by in case of sort all fields being set
		        '-- Date: 25/10/2010
					else
						if Application("ALLOW_SORT_ALL_FIELDS") = 1 AND session("order_by" & dbkey & formgroup) <> "" then
                    		sql= sql & " order by " & session("order_by" & dbkey & formgroup) & " " &  Session("sort_direction" & dbkey & formgroup)
                    	end if
        		'-- End of Change #127416#
					end if
					Shapestr0 = " SHAPE {" & sql & "}" & " as " & aliasName
					cmd.commandtext = Shapestr0
					
					cmd.Parameters.Append cmd.CreateParameter("hitlistid", 131, 1, 0, Session("hitlistid" & dbkey & formgroup))
					'create parameterized RS for subtables and then pass in as a reference for reshaping. Avoids recursive calls to data source to retrieve base table data 
					'The following needed to be done to explicity create a recordset with a different object identifier. Creating names like:
					'rsname = "rsname" & i simply did not work.  The following allows for 29 child tables. I can't imagine any situation were more would be needed
					'if they are then simply add addition cases
						on error resume next
					'Response.Write 	Shapestr0
					'Response.end
					select case i
						case 1
							dim rs_name1
							set rs_name1 =cmd.execute
							
						case 2
							dim rs_name2
							Set rs_name2 =cmd.execute
						case 3
							dim rs_name3
							Set rs_name3 =cmd.execute
						case 4
							dim rs_name4
							Set rs_name4 =cmd.execute
						case 5
							dim rs_name5
							Set rs_name5 =cmd.execute
						case 6
							dim rs_name6
							Set rs_name6 =cmd.execute
						case 7
							dim rs_name7
							Set rs_name7 =cmd.execute
						case 8
							dim rs_name8
							Set rs_name8=cmd.execute
						case 9
							dim rs_name9
							Set rs_name9=cmd.execute
						case 10
							dim rs_name10
							Set rs_name10=cmd.execute
						case 11
							dim rs_name11
							Set rs_name11=cmd.execute
						case 12
							dim rs_name12
							Set rs_name12=cmd.execute
						case 13
							dim rs_name13
							Set rs_name13=cmd.execute
						case 14
							dim rs_name14
							Set rs_name14=cmd.execute
						case 15
							dim rs_name15
							Set rs_name15=cmd.execute
						case 16
							dim rs_name16
							Set rs_name16=cmd.execute
						case 17
							dim rs_name17
							Set rs_name17=cmd.execute
						case 18
							dim rs_name18
							Set rs_name18=cmd.execute
						case 19
							dim rs_name19
							Set rs_name19=cmd.execute
						case 20
							dim rs_name20
							Set rs_name20=cmd.execute
						case 21
							dim rs_name21
							Set rs_name21=cmd.execute
						case 22
							dim rs_name22
							Set rs_name22=cmd.execute
						case 23
							dim rs_name23
							Set rs_name23=cmd.execute
						case 24
							dim rs_name24
							Set rs_name24=cmd.execute
						case 25
							dim rs_name25
							Set rs_name25=cmd.execute
						case 26
							dim rs_name26
							Set rs_name26=cmd.execute
						case 27
							dim rs_name27
							Set rs_name27=cmd.execute
						case 28
							dim rs_name28
							Set rs_name28=cmd.execute
						case 29
							dim rs_name29
							Set rs_name29=cmd.execute
						case 30
							dim rs_name30
							Set rs_name30=cmd.execute
						case 31
							dim rs_name31
							Set rs_name31=cmd.execute
						case 32
							dim rs_name32
							Set rs_name32=cmd.execute
						case 33
							dim rs_name33
							Set rs_name33=cmd.execute
						case 34
							dim rs_name34
							Set rs_name34=cmd.execute
						case 35
							dim rs_name35
							Set rs_name35=cmd.execute
						case 36
							dim rs_name36
							Set rs_name36=cmd.execute
						case 37
							dim rs_name37
							Set rs_name37=cmd.execute
						case 38
							dim rs_name38
							Set rs_name38=cmd.execute
						case 39
							dim rs_name39
							Set rs_name39=cmd.execute
						case 40
							dim rs_name40
							Set rs_name40=cmd.execute
						case 41
							dim rs_name41
							Set rs_name41=cmd.execute
						case 42
							dim rs_name42
							Set rs_name42=cmd.execute
						case 43
							dim rs_name43
							Set rs_name43=cmd.execute
						case 44
							dim rs_name44
							Set rs_name44=cmd.execute
						case 45
							dim rs_name45
							Set rs_name45=cmd.execute
						case 46
							dim rs_name46
							Set rs_name46=cmd.execute
						case 47
							dim rs_name47
							Set rs_name47=cmd.execute
						case 48
							dim rs_name48
							Set rs_name48=cmd.execute
						case 49
							dim rs_name49
							Set rs_name49=cmd.execute
						case 50
							dim rs_name50
							Set rs_name50=cmd.execute	
					end select
					if err then
						TraceError "Error opening child table " & replace(RS_NAME, ".", "_") & " SQL=" & cmd.commandtext & "(hitlist=" & Session("hitlistid" & dbkey & formgroup) & ")", Err.Source, Err.number,Err.Description
					end if
					
					cmd.parameters.delete "hitlistid"
					
					Dim Relate_List
					Dim c
					if instr(PARENT_LINKS, ",")>0 then
						'need to use expanded RELATE STATEMENT
						temp_PARENT_LINKS= split(PARENT_LINKS, ",", -1)
						temp_CHILD_LINKS = split(CHILD_LINKS, ",", -1)
						for c = 0 to UBound(temp_PARENT_LINKS)
							if Relate_list <> "" then
								Relate_List = Relate_List & ", " & temp_PARENT_LINKS(c) & " TO " & temp_CHILD_LINKS(c)
							else
								Relate_List = temp_PARENT_LINKS(c) & " TO " & temp_CHILD_LINKS(c)
							end if
						next
					else
						Relate_list = PARENT_LINKS & " TO " & CHILD_LINKS

					end if

					if ChildShape <> "" then

						ChildShape = ChildShape & "," &_
						" ( " & aliasName  &_
						" RELATE  " & Relate_list  & ") AS "  &  replace(replace(RS_NAME, ".", "_"),"$","_D_") 
					else
						ChildShape = " APPEND " &_
						" ( " & aliasName &_
						" RELATE  " & Relate_list  & ") AS "  &  replace(replace(RS_NAME, ".", "_"),"$","_D_") 
					end if
					
					if UCase(Display_view) = "LIST" then
						view_display_tag = "_L"
					end if
					if UCase(Display_view) = "DETAIL" then
						view_display_tag = "_D"
					end if
					ViewName = "BIOSARDB." & TruncateViewName(TABLE_NAME_SHORT,i,"_" & formgroup & view_display_tag, 26)
					Session("SQL" & Session("hitlistid" & dbkey & formgroup))  =Session("SQL" & Session("hitlistid" & dbkey & formgroup)) & chr(10)& "<TABLE NAME=""" & TABLE_NAME & """  VIEW_NAME=""" & ViewName & """ DISPLAY_NAME=""" & DISPLAY_NAME & """  PARENT_LINK=""" & PARENT_LINKS & """ CHILD_LINK=""" & CHILD_LINKS & """ />"
						if inStr(UCase(err.description), "DOES NOT EXIST") then
							if tablePrivErrors <> "" then
								tablePrivErrors = tablePrivErrors & ", " & table_name
							else
								tablePrivErrors = table_name
							end if
						end if
					
					
					trace "Child Table: " & replace(RS_NAME, ".", "_") & " sql:" & Shapestr0 & " (hitlistID=" & Session("hitlistid" & dbkey & formgroup) & ")(time to build:" & timer()-t0 & ")", 10
				end if
			end if
			
			
		Next
		
		Session("SQL" & Session("hitlistid" & dbkey & formgroup)) =Session("SQL" & Session("hitlistid" & dbkey & formgroup)) & chr(10) & "</SQL_INFO>"
		ShapeStatement = ShapeStatement & ChildShape
		
		on error resume next	
		'create shaped recordset
		cmd.CommandText = ShapeStatement
		
		cmd.Parameters.Append cmd.CreateParameter("hitlistid", 131, 1, 0, Session("hitlistid" & dbkey & formgroup)) 
		
		Dim RS2
		Set RS2 = Server.CreateObject("adodb.recordset")
		'RS2.CursorLocation = adUseServer
		RS2.LockType= 3
		RS2.CursorType = 3 
	
		t0 = timer 
		RS2.Open cmd
			
		if err.number <> 0 then
			if tablePrivErrors <> "" then
				Session("table_errors")=tablePrivErrors
				if inStr(tablePrivErrors, ",")>0 then
					Response.Write "<br>"
					Response.Write "<br>"
					Response.Write "You no longer have select privileges on the following tables: " & tablePrivErrors & "<br>"
					Response.Write "Please edit your form and remove these tables. <br>"
					Response.write "Once this is done you will be able to use this form for searching."
				else
					Response.Write "<br>"
					Response.Write "You no longer have select privileges on the following the table: " &  tablePrivErrors & "<br>"
					Response.Write "Please edit your form and remove this table.<br>"
					Response.write "Once this is done you will be able to use this form for searching."
				end if
			else
				if ShapeStatement <> "" then
					Response.Write "<br>"
					Response.Write "<br>"
					Response.Write "Display recordset could not be created.<br>"
					
					if inStr(1, err.Description, "ORA-01481") > 0 then
						Response.Write "Invalid Format Mask for one or more of the display fields.<br>"
						Response.Write "Check the Format Masks in the field display options for this form.<br>"
					end if
					if inStr(1, err.Description, "ORA-01821") > 0then
						Response.Write "Invalid Format Mask for one or more of the date fields.<br>"
						Response.Write "Check the Format Masks for all date fields in the field options for this form.<br>"
					end if	 
					'Response.write "Error Number: " & err.number & "<br>" 
					Response.write "Error Description: " & err.description & "<br>" 
					'Response.write "Full sql statement: " & shapestatement & "<br>" 
					Response.Write "For details see application <b><a target=""_new"" href=""/biosar_browser/logfiles/biosar_browser_trace.html"">log file</a></b>"

				else
					if display_view = "LIST" then
						Response.Write "<br>"
						Response.Write "<br>"
						Response.Write "There are no fields defined for list view. Please edit this form and add fields to this view.<br>" 
					else
						' This message is already displayed by parseDetailTable function.
						'Response.Write "There are no fields defined for detail view. Please edit this form and add fields to this view.<br>" 
					end if
				end if
				TraceError "Error while executing shaped recordset: " & shapestatement, err.Source, err.number, err.Description
				Session("table_errors")= err.number
				LogAction(err.number & err.description & ": " & shapestatement)
			end if
			

			set RS2 = Nothing
			
		end if
		trace "Shaped RS Sql: " & ShapeStatement & " (hitlistID=" & Session("hitlistid" & dbkey & formgroup) & ")(time to build:" & timer()-t0 & ")", 10

		if repop_basers = true then
		
			dim bNumRecords
			dbkey =  session("dbkey")
			formgroup = session("formgroup")
			baseid = "IndexCounter"
			Session("Base_RS" & dbkey & formgroup) = RS2.GetRows(,,baseid)
			bNumRecords =UBound(Session("Base_RS" & dbkey & formgroup),2) + 1
			'when a search is done with a sort field in a child table, the cartesian product is produced here so the original incoming recordcounts will be 
			'different and need to be reset. Further, the template for structure display have to be maintained otherwises structure dissapear.
			if bNumRecords > Session("hitlistrecordcount" & dbkey & formgroup) then
				session("overrideStrucTemplateChanges")=false
			end if
			Session("hitlistrecordcount" & dbkey & formgroup) =bNumRecords
			Session("Base_RSRecordCount" & dbkey & formgroup) = bNumRecords
		end if
    	if Not RS2.Source <> "" then
			Set RS2 = nothing
			RS2=""
		end if
		Set buildShapeRS = RS2 ' Return the newly created RS
	else
		Set buildShapeRS = RS2 ' Return the RS as passed in
	end if 'end if isObject(RS)	
	 Trace "Out:buildShapeRS" & showErrorIfAny, 25
end function



'called by called by several:
'getListFields<-getDisplayItems<-GetItems<-WriteDisplayItems for list view
'getDetailFieldsTab<-getDisplayItems<-GetItems<-WriteDisplayItems for detail tab view
'getDetailFields<-getDisplayItems<-GetItems<-WriteDisplayItems for detail  view

function ParseRSString2(dbkey,formgroup, rs_sql, display_view)
		Trace "In:ParseRSString2" & showErrorIfAny, 25
		
		if display_view = "DETAIL" then
			baseid_name= GetTableVal(dbkey, basetable, kPrimaryKey)
			base_id = Session("base_rs" & dbkey & formgroup)(0, current_index -1)
			session("last_detail_baseid")=base_id
			replaceTxt = "." & baseid_name & "=" & base_id  
			theReturn = replace(rs_sql, ".rowid#=ROWID#", replaceTxt )
		else
			if Session("TooManyHitsToDisplay" & dbkey & formgroup) = true then
				replaceTxt = " IN(select BIOSARDB.csdohitlist.ID from BIOSARDB.csdohitlist where BIOSARDB.csdohitlist.hitlistid =" & "?"  & " AND  ROWNUM < " & Application("TooManyHitsMaximumRetrievable")  + 1 & ")" 
			else
				replaceTxt = " IN(select BIOSARDB.csdohitlist.ID from BIOSARDB.csdohitlist where BIOSARDB.csdohitlist.hitlistid =" & "?" & ")"
			end if
			theReturn = replace(rs_sql, "#=ROWID#", replaceTxt )
		end if
		ParseRSString2=theReturn
		Trace "Out:ParseRSString2" & showErrorIfAny, 25
End function

function ParseRSString(dbkey,formgroup, rs_sql)
		Trace "In:ParseRSString" & showErrorIfAny, 25
		
		if display_view = "DETAIL" then
			base_id = Session("base_rs" & dbkey & formgroup)(0, current_index)
			baseid_name= GetTableVal(dbkey, basetable, kPrimaryKey)
			replaceTxt = "." & baseid_name & "=" & base_id
			theReturn = replace(rs_sql, ".rowid#=ROWID#", replaceTxt )
		else
			replaceTxt = " IN(select BIOSARDB.csdohitlist.ID from BIOSARDB.csdohitlist where BIOSARDB.csdohitlist.hitlistid =" & "?" & ")"
			theReturn = replace(rs_sql, "=$ROWID", replaceTxt )
		end if
		ParseRSString=theReturn
		Trace "Out:ParseRSString" & showErrorIfAny, 25
End function

Function getRSDisplaySQL(unparsed_sql, display_type)
	Trace "In:getRSDisplaySQL" & showErrorIfAny, 25
	
	display_sql_array = Split(unparsed_sql, "|:|", -1)
	Select Case UCase(display_type)
		CASE "ALL"
			returnSQL = display_sql_array(0)
		Case "LIST"
			temp = split(display_sql_array(1), ";;;", -1)
			returnSQL = temp(Ubound(temp))
			
			
		Case  "DETAIL"
			temp = split(display_sql_array(2), ";;;", -1)
			returnSQL = temp(Ubound(temp))
	End Select
	getRSDisplaySQL = returnSQL
	Trace "Out:getRSDisplaySQL" & showErrorIfAny, 25
End Function

Function getRSChildLinks(unparsed_sql, display_type)
	Trace "In:getRSChildLinks" & showErrorIfAny, 25
	
	display_sql_array = Split(unparsed_sql, "|:|", -1)
	Select Case UCase(display_type)
		
		Case "LIST"
			temp = split(display_sql_array(1), ";;;", -1)
			returnSQL = temp(2)
		Case  "DETAIL"
			temp = split(display_sql_array(2), ";;;", -1)
			returnSQL = temp(2)
	End Select
	getRSChildLinks = returnSQL
	Trace "Out:getRSChildLinks" & showErrorIfAny, 25
End Function
Function getRSParentLinks(unparsed_sql, display_type)
	Trace "In:getRSParentLinks" & showErrorIfAny, 25
	
	display_sql_array = Split(unparsed_sql, "|:|", -1)
	Select Case UCase(display_type)
		
		Case "LIST"
			temp = split(display_sql_array(1), ";;;", -1)
			returnSQL = temp(3)
		Case  "DETAIL"
			temp = split(display_sql_array(2), ";;;", -1)
			returnSQL = temp(3)
	End Select
	getRSParentLinks = returnSQL
	Trace "Out:getRSParentLinks" & showErrorIfAny, 25
End Function

Function getRSFieldAliases(unparsed_sql, display_type)
	Trace "In:getRSFieldAliases" & showErrorIfAny, 25
	
	display_sql_array = Split(unparsed_sql, "|:|", -1)
	Select Case UCase(display_type)
		
		Case "LIST"
			temp = split(display_sql_array(1), ";;;", -1)
			returnSQL = temp(4)
		Case  "DETAIL"
			temp = split(display_sql_array(2), ";;;", -1)
			returnSQL = temp(4)
	End Select
	getRSFieldAliases = returnSQL
	Trace "Out:getRSFieldAliases" & showErrorIfAny, 25
End Function
'**************************************
'START RS GENERATION CODE
'**************************************



'*************************
'START XML Template Modification Code
'*************************


Function getXMLTemplate(dbkey, formgroup, Template_ID)
	Trace "In:getXMLTemplate" & showErrorIfAny, 25
	
	'remove once all other templates are done
	
	on error resume next
	templateDef =Application("XML_DEFS"  & dbkey & formgroup & Template_ID)
	getXMLTemplate = templateDef
	Trace "Out:getXMLTemplate" & showErrorIfAny, 25
End Function



Function TablesToShow(byRef oData, node_list)
	Trace "In:TablesToShow" & showErrorIfAny, 25
	on error resume next
	Set oReplaceNodes = oData.getElementsByTagName("TABLE_ELEMENT")
	For i = 0 to oReplaceNodes.Length-1
		theName = oReplaceNodes.Item(i).getAttribute("NAME")
		if  checkExistInList(node_list, theName) = true or theName = "NO_HIDE" then
			 oReplaceNodes.Item(i).setAttribute "SHOW","1"
		else
			oReplaceNodes.Item(i).setAttribute "SHOW","0"
		end if
	Next
	Set TablesToShow = oData
	Trace "Out:TablesToShow" & showErrorIfAny, 25
End function

Function HideJSColumn(byRef oData)
	Trace "In:HideJSColumn" & showErrorIfAny, 25
	on error resume next
	Set oReplaceNodes = oData.getElementsByTagName("FIELD")
	For i = 0 to oReplaceNodes.Length-1
		theName = oReplaceNodes.Item(i).getAttribute("VALUE_COLUMNS")
		if  UCase(theName) = "PAGEROWNUM" then
			oReplaceNodes.Item(i).setAttribute "SHOW","0"
		end if
	Next
	Set HideJSColumn = oData
	Trace "Out:HideJSColumn" & showErrorIfAny, 25
End function

Function SetSubTableBorderDisplay(byRef oData)
	Trace "In:SetSubTableBorderDisplay" & showErrorIfAny, 25
	if Application("SHOW_SUBTABLE_BORDERS")<> "" then 
		bBorders = CBool(Application("SHOW_SUBTABLE_BORDERS"))
	else
		bBorders = false
	end if
	if bBorders = true then
		border_spec = "1"
	else
		border_spec = "0"
	end if
	on error resume next
	Set oReplaceNodes = oData.getElementsByTagName("TABLE_ELEMENT")
	For i = 0 to oReplaceNodes.Length-1
		oReplaceNodes.Item(i).setAttribute "BORDERS",border_spec
	Next
	Set SetSubTableBorderDisplay = oData
	Trace "Out:SetSubTableBorderDisplay" & showErrorIfAny, 25
End Function

	
Function SetHeaderRepeat(byRef oData)
	Trace "In:SetHeaderRepeat" & showErrorIfAny, 25
	if Application("SHOW_SUBTABLE_HEADERS_ONCE")<> "" then
		bHeaderOnce = CBool(Application("SHOW_SUBTABLE_HEADERS_ONCE"))
	else
		bHeaderOnce = false
	end if
	if bHeaderOnce then
		bRepeatHeader = "false"
	else
		bRepeatHeader = "true"
	end if
	on error resume next
	Set oReplaceNodes = oData.getElementsByTagName("TABLE_ELEMENT")
	For i = 0 to oReplaceNodes.Length-1
		oReplaceNodes.Item(i).setAttribute "REPEAT_HEADER",bRepeatHeader
	Next
	Set SetHeaderRepeat = oData
	Trace "Out:SetHeaderRepeat" & showErrorIfAny, 25
End Function

Function HideCaptions(byRef oData)
	Trace "In:HideCaptions" & showErrorIfAny, 25
	on error resume next
	Set oReplaceNodes = oData.getElementsByTagName("CAPTION_ELEMENT")
	For i = 0 to oReplaceNodes.Length-1
		oReplaceNodes.Item(i).setAttribute "SHOW",0
	Next
	Set HideCaptions = oData
	Trace "Out:HideCaptions" & showErrorIfAny, 25
End Function

Function StructureGetMethod(byRef oData)
	Trace "In:StructureGetMethod" & showErrorIfAny, 25
	if overrideStrucTemplateChanges = true then exit function
	if bINLINE =true then
		Set oReplaceNodes = oData.getElementsByTagName("FIELD")
		For i = 0 to oReplaceNodes.Length-1
			isStructure = oReplaceNodes.Item(i).getAttribute("IS_STRUCTURE")
			dataLocation = oReplaceNodes.Item(i).getAttribute("DATA_LOCATION")
			if  isStructure = "1" and UCase(dataLocation)="RECORDSET" then
			
				oReplaceNodes.Item(i).setAttribute "SHOW","1"
			else
				if  isStructure = "1" and UCase(dataLocation)="TABLE" then
					oReplaceNodes.Item(i).setAttribute "SHOW","0"
				end if
			end if
		Next
	else
		Set oReplaceNodes = oData.getElementsByTagName("FIELD")
		For i = 0 to oReplaceNodes.Length-1
			isStructure = oReplaceNodes.Item(i).getAttribute("IS_STRUCTURE")
			dataLocation = oReplaceNodes.Item(i).getAttribute("DATA_LOCATION")
			if  isStructure = "1" and UCase(dataLocation)="TABLE" then
				oReplaceNodes.Item(i).setAttribute "SHOW","1"
			else
				if  isStructure = "1" and UCase(dataLocation)="RECORDSET" then
					oReplaceNodes.Item(i).setAttribute "SHOW","0"
				end if
			end if
		Next
	end if
	Set StructureGetMethod = oData
	Trace "Out:StructureGetMethod" & showErrorIfAny, 25
End function

'*************************
'END XML Template Modification Code
'*************************


'**********************************************
'START ACCESS REPORT CODE
'**********************************************

Sub clearReportVariables(dbkey, formgroup, display_view)
	Session("FullSingleRS_SQL" & display_view & dbkey & formgroup)=""
	Session("fg_fields_QueryNames" & dbkey & formgroup & display_view)=""
	Session("all_fields_reportSQL" & dbkey & formgroup& display_view) = ""
	Session("fg_fields_reportSQL" & dbkey & formgroup & display_view)= ""
	Session("fg_fields_reportSQL_New" & dbkey & formgroup & display_view)=""
	Session("ReportHitListMessage" & dbkey & formgroup)=""
End sub
Sub GenerateReportVarsByDisplayType(dbkey, formgroup, table_list, display_view)
	Session("ReportTables")=""
	on error resume next
	Dim myItems
	clearReportVariables dbkey, formgroup, display_view
	myItems = Split(Application("RS_DEFS" & display_view & dbkey & formgroup), ":CS_ITEM:", -1)
	
	for i = 0 to  UBound(myItems)
			dim temp
			temp = split(myItems(i), ":CS_SUB_ITEM:", -1)
			TABLE_NAME =temp(0)
			if i = 0 then
				BaseTable = TABLE_NAME
			end if
			if table_list <> "" then
			table_array = split(table_list, ",", -1)
			bShowTable = false
				for q = 0 to UBound(table_array)
				
						if UCase(table_array(q)) = UCase(TABLE_NAME)  then
							bShowTable = true
						end if
						
				next
			else
				bShowTable  = true
			end if
			
			
					myItems = Split(Application("RS_DEFS" & display_view & dbkey & formgroup), ":CS_ITEM:", -1)

		
	
			on error resume next
			if bShowTable = true  then
				
				if i = 0 then
					base_order_by = "#" & BaseTable & "ORDER_BY#"
					
					if NOT Application("FIELD_DEFS" & TABLE_NAME & display_view & dbkey & formgroup) = "NULL" then ' if there are not fields for display bypass all this
						if  Session("ReportTables") <> "" then
							Session("ReportTables") = Session("ReportTables") & "," & BaseTable
						else
							Session("ReportTables") =  BaseTable
						end if
						DISPLAY_SQL_INF0 = temp(1)
						
						display_array = Split(DISPLAY_SQL_INF0, ":::", -1)
						'add sql to report session variable only for the first time an full record for the list is generated
						
						BASETABLE_SQL = getRSReportDisplaySQL(display_array(2),display_view)
						BASETABLE_SQL = replaceBaseTablePlaceholders(dbkey, formgroup,"", BASETABLE_SQL)
					end if
				end if
				if i > 0 then
					order_by = "#" & TABLE_NAME & "ORDER_BY#"
					if NOT Application("FIELD_DEFS" & TABLE_NAME & display_view & dbkey & formgroup) = "NULL" then ' if there are not fields for display bypass all this
						if  Session("ReportTables") <> "" then
							Session("ReportTables") = Session("ReportTables") & "," & TABLE_NAME
						else
							Session("ReportTables") =  TABLE_NAME
						end if
						DISPLAY_SQL_INF0 = temp(1)
						
						display_array = Split(DISPLAY_SQL_INF0, ":::", -1)
						'add sql to report session variable only for the first time an full record for the list is generated
						
						REPORT_DISPLAY_SQL = getRSReportDisplaySQL(display_array(2),display_view)
						thereturn = Split(getTableVal(dbkey, TABLE_NAME, kSelectJoin), "=", -1)
						temp = split(theReturn(1), ".", -1)
						temp2 = split(theReturn(0), ".", -1)
						childLinkID = temp(UBound(temp))
						baseLinkID =  temp2(UBound(temp2))
						temp3 = split(REPORT_DISPLAY_SQL, " FROM ", -1)
						if Not inStr(temp3(0), theReturn(0))> 0 then
							REPORT_DISPLAY_SQL = replace (REPORT_DISPLAY_SQL, "SELECT ", "SELECT " & theReturn(0) & "," )
						end if
						temp4 = split(BASETABLE_SQL, " FROM ", -1)
						if Not inStr(temp4(0), theReturn(1))> 0 then
							BASETABLE_SQL = replace (BASETABLE_SQL, "SELECT ", "SELECT " & theReturn(1) & "," )
						end if
						
						basetable = getbasetable(dbkey, formgroup, "basetable")
						
						if CHILD_DATA_DISPLAY = "LIMIT" then
							REPORT_DISPLAY_SQL = AddChildTableCriteria( dbkey, formgroup, TABLE_NAME, REPORT_DISPLAY_SQL)
							REPORT_DISPLAY_SQL = modifySql(REPORT_DISPLAY_SQL)
						end if 
						if (UCase(TABLE_NAME) = basetable) and Trim(Session("order_by" & dbkey & formgroup)) <> "" then
							addReportSQL dbkey, formgroup, REPORT_DISPLAY_SQL, "FG_FIELDS_WITH_SORT", display_view, order_by
						else
							addReportSQL dbkey, formgroup, REPORT_DISPLAY_SQL, "FG_FIELDS", display_view, order_by
						end if
						addQueryNames dbkey, formgroup,TABLE_NAME,"FG_FIELDS", display_view
					end if
				end if
			end if
		Next
		'doBaseTable
		if NOT Application("FIELD_DEFS" & BaseTable & display_view & dbkey & formgroup) = "NULL" then ' if there are not fields for display bypass all this
				
					if  Trim(Session("order_by" & dbkey & formgroup)) <> "" then
						addReportSQL dbkey, formgroup, BASETABLE_SQL, "FG_FIELDS_WITH_SORT", display_view, base_order_by
					else
						addReportSQL dbkey, formgroup, BASETABLE_SQL, "FG_FIELDS", display_view, base_order_by
					end if
					addQueryNames dbkey, formgroup,BaseTable,"FG_FIELDS", display_view
		end if
End Sub


Sub GenerateReportVariables(dbkey, formgroup, table_list)

	if bCanMakeReport = true then
		GenerateReportVarsByDisplayType dbkey, formgroup,  table_list, "LIST"
		GenerateReportVarsByDisplayType dbkey, formgroup,  table_list, "DETAIL"
		if bDebugReportSQL = true then
			WriteOutVars dbkey, formgroup
		end if
	end if
End Sub

Sub GenerateReportVarsByDisplayType_orig(dbkey, formgroup, table_list, display_view)
	on error resume next
	
	clearReportVariables dbkey, formgroup, display_view
	myItems = Split(Application("RS_DEFS" & display_view & dbkey & formgroup), ":CS_ITEM:", -1)
	
		for i = 0 to  UBound(myItems)
			temp = split(myItems(i), ":CS_SUB_ITEM:", -1)
			TABLE_NAME =temp(0)
			
			
			if table_list <> "" then
			table_array = split(table_list, ",", -1)
			bShowTable = false
				for q = 0 to UBound(table_array)
				
						if UCase(table_array(q)) = UCase(TABLE_NAME)  then
							bShowTable = true
						end if
						
				next
			else
				bShowTable  = true
			end if
			
			on error resume next
			if bShowTable = true then
				if NOT Application("FIELD_DEFS" & TABLE_NAME & display_view & dbkey & formgroup) = "NULL" then ' if there are not fields for display bypass all this
					DISPLAY_SQL_INF0 = temp(1)
					
					display_array = Split(DISPLAY_SQL_INF0, ":::", -1)
					'add sql to report session variable only for the first time an full record for the list is generated
					
					REPORT_DISPLAY_SQL = getRSReportDisplaySQL(display_array(2),display_view)
					basetable = getbasetable(dbkey, formgroup, "basetable")
					
					if (UCase(TABLE_NAME) = basetable) and Trim(Session("order_by" & dbkey & formgroup)) <> "" then
						addReportSQL dbkey, formgroup, REPORT_DISPLAY_SQL, "FG_FIELDS_WITH_SORT", display_view
					else
						addReportSQL dbkey, formgroup, REPORT_DISPLAY_SQL, "FG_FIELDS", display_view
					end if
					addQueryNames dbkey, formgroup,TABLE_NAME,"FG_FIELDS", display_view
				end if
			end if
		Next
End Sub

Sub AddQueryNames(dbkey, formgroup,table_name, reportType, display_view)
	full_formgroup_name = Application("formgroup_full_name" & dbkey & formgroup) & "_" & display_view &  "_" & formgroup
	trimmed_name = "_" & display_view &  "_" & formgroup
	baseTable = getbasetable(dbkey, formgroup, "basetable")
	if UCase(table_name) = UCase(basetable) then
		queryname =  full_formgroup_name
	else
		queryname = replace(table_name, ".", "_") & trimmed_name
	end if

	Select Case UCase(reportType)
			Case "FG_FIELDS"
					if Session("fg_fields_QueryNames" & dbkey & formgroup & display_view) <> "" then
						Session("fg_fields_QueryNames" & dbkey & formgroup & display_view) = Session("fg_fields_QueryNames" & dbkey & formgroup & display_view) & "~" & queryname
					else
						Session("fg_fields_QueryNames" & dbkey & formgroup & display_view) = queryname
					end if
			Case "ALL_FIELDS"
					if Session("all_fields_QueryNames" & dbkey & formgroup & display_view) <> "" then
						Session("all_fields_QueryNames" & dbkey & formgroup & display_view) = Session("all_fields_QueryNames" & dbkey & formgroup & display_view) & "~" & queryname
					else
						Session("all_fields_QueryNames" & dbkey & formgroup & display_view) = queryname
					end if
	End Select
End Sub

'JHS 12/11/2007 - adding this function
function RemoveURLText(sql_statement)
	concatCheck = instr(1,sql_statement,"CONCAT(")
	endhrefCheck = instr(1,sql_statement,"</a>'")
	targetCheck = instr(1,sql_statement,"target=""_blank"">")
	'stop
	if  concatCheck > 1 and endhrefCheck > 1 and targetCheck > 1 then	
		
		'this works if a text is specified
		replacethis = mid(sql_statement, concatCheck, endhrefCheck-concatCheck+6)
		
		'first check for if there is a value or a specified text to display
		'in this case the link is going to have the ') because it will be concatanating a value
		typecheck = instr(1,replacethis, "target=""_blank"">')")
		if typecheck > 0 then
			
									     'The + 3 takes into account the extra '),
														   'The +3+3 handles the extra ),' and the +3 above
			withthis = mid(sql_statement,targetCheck+16+3,  endhrefCheck-(targetCheck+16+3+3))
			sql_statement = Replace(sql_statement,replacethis,withthis)
	
		'In this case it will be using text to append
		else
			withthis = "'" & mid(sql_statement,targetCheck+16,endhrefCheck-(targetCheck+16)) & "'"
			sql_statement = Replace(sql_statement,replacethis,withthis)
		end if
		
		RemoveURLText = RemoveURLText(sql_statement)
	else
		RemoveURLText = sql_statement
	end if
end function

Sub addReportSQL(dbkey, formgroup, select_statement_input, reportType, display_view, order_by)
	
	'JHS 12/11/2007 - Show URLs as text instead of the full URL
	select_statement_input = RemoveURLText(select_statement_input)
	
	temp_array= split(select_statement_input, ";;;", -1)
	select_statement = temp_array(5)
	'strip where clause
		if bCanMakeReport = true then
		
			Select Case UCase(reportType)
			Case "FG_FIELDS"
				'select_statement_array = Split(select_statement, " WHERE ", -1)
				'select_and_from_only =   select_statement_array(0) & " WHERE "
				'full_sql = AddCSDOHitListToSelectTopN(dbkey, formgroup, select_and_from_only,Application("ReportMaxHits"))
				if Application("ReportMaxHits") <> "" then
					on error resume next
					if CLng(Session("hitlistRecordCount" & dbkey & formgroup) + 1) > CLng(Application("ReportMaxHits")) then
						bAboveMax = true
					else
						bAboveMax = false
					end if
					on error goto 0
					
					if bAboveMax = true then
							if UCase(Application("PreventReportAboveMax")) = "TRUE" then
								Session("ReportHitListMessage" & dbkey & formgroup) =Application("PreventReportAboveMaxMessage")  
								csdo_select = " IN(select BIOSARDB.csdohitlist.ID from BIOSARDB.csdohitlist where BIOSARDB.csdohitlist.hitlistid =" & Session("hitlistid" & dbkey & formgroup) & " AND  ROWNUM < " & Application("ReportMaxHits") + 1 & ")"
								full_sql = Replace(select_statement, "#=ROWID#", csdo_select)
								full_sql = Replace(full_sql, "#=ROWID#", csdo_select)
								full_sql = full_sql  & order_by
							else
								Session("ReportHitListMessage" & dbkey & formgroup) = Application("ReportAboveMaxWarningMessage")
								csdo_select = " IN(Select BIOSARDB.csdohitlist.ID from BIOSARDB.csdohitlist where BIOSARDB.csdohitlist.hitlistid =" & Session("hitlistid" & dbkey & formgroup) & ")"
								full_sql = Replace(select_statement, "#=ROWID#", csdo_select)
								full_sql = Replace(full_sql, "#=ROWID#", csdo_select)
								full_sql = full_sql  & order_by
								

							end if
						
					else
							Session("ReportHitListMessage" & dbkey & formgroup) = ""
							csdo_select = " IN(Select BIOSARDB.csdohitlist.ID from BIOSARDB.csdohitlist where BIOSARDB.csdohitlist.hitlistid =" & Session("hitlistid" & dbkey & formgroup) & ")"
							full_sql = Replace(select_statement, "#=ROWID#", csdo_select)
							full_sql = Replace(full_sql, "#=ROWID#", csdo_select)
							full_sql = full_sql & order_by
					
					end if
				else
					Session("ReportHitListMessage" & dbkey & formgroup) = ""
					csdo_select = " IN(Select BIOSARDB.csdohitlist.ID from BIOSARDB.csdohitlist where BIOSARDB.csdohitlist.hitlistid =" & Session("hitlistid" & dbkey & formgroup) & ")"
					full_sql = Replace(select_statement, "#=ROWID#", csdo_select)
					full_sql = Replace(full_sql, "#=ROWID#", csdo_select)
					full_sql = full_sql  & order_by
				end if
				csdo_select_new = " IN(select BIOSARDB.csdohitlist.ID from BIOSARDB.csdohitlist where BIOSARDB.csdohitlist.hitlistid =" & Session("hitlistid" & dbkey & formgroup) & " AND  ROWNUM < 2)"
				full_sql_new = Replace(select_statement, "#=ROWID#", csdo_select_new)
				full_sql_new = Replace(full_sql_new, "#=ROWID#", csdo_select_new)
				full_sql_new = full_sql_new  & order_by			
				'end if
					if Session("fg_fields_reportSQL" & dbkey & formgroup & display_view) <> "" then
						Session("fg_fields_reportSQL" & dbkey & formgroup & display_view)  = Session("fg_fields_reportSQL" & dbkey & formgroup& display_view)  & "~" & full_sql
					else
						Session("fg_fields_reportSQL" & dbkey & formgroup & display_view)  = full_sql
					end if
					if Session("fg_fields_reportSQL_NEW" & dbkey & formgroup & display_view) <> "" then
						Session("fg_fields_reportSQL_NEW" & dbkey & formgroup & display_view)  = Session("fg_fields_reportSQL_NEW" & dbkey & formgroup & display_view)  & ":::" & replace(temp_array(0), ".", "_") & ";;;" & temp_array(1) & ";;;" & temp_array(2) & ";;;" &  temp_array(3) & ";;;" &   temp_array(4) & ";;;" & full_sql_new
					else
						Session("fg_fields_reportSQL_NEW" & dbkey & formgroup & display_view)  = replace(temp_array(0), ".", "_") & ";;;" & temp_array(1) & ";;;" & temp_array(2) & ";;;" &  temp_array(3) & ";;;" &   temp_array(4) & ";;;" & full_sql_new
					end if
			Case "FG_FIELDS_WITH_SORT"
				basetable = getbasetable(dbkey, formgroup, "basetable")
				If  instr(UCase(Session("order_by" & dbkey & formgroup)), UCase(basetable)) > 0 then
					if Session("AllOuterSorts") <> "" then
						orderbyAdd=""
					else
						'select_statement = Replace(select_statement," FROM ", Session("order_by" & dbkey & formgroup) & " FROM ")
						if Session("sort_direction" & dbkey & formgroup) <> "" then
							orderbyAdd=  " ORDER BY " & Session("order_by" & dbkey & formgroup) & " " &  Trim(Session("sort_direction" & dbkey & formgroup))
						end if
					end if
					
				else
					table_array = split(Session("order_by" & dbkey & formgroup),".", -1)
					sort_table = table_array(0) & "." & table_array(1)
					TempJoin=GetTableVal(dbkey, sort_table, kSelectJoin)
					if instr(TempJoin, "|")> 0 then
						SelectJoin = ExpandAndAddBrackets(TempJoin)
					else
						SelectJoin = AddBrackets(TempJoin)		
					end if
					replaceValue = "," & Session("order_by" & dbkey & formgroup) & " FROM " & sort_table & ","
					select_statement = Replace(select_statement," FROM ", replaceValue)
					sortValue = " WHERE " & "(" & selectJoin & ") AND "
					select_statement = Replace(select_statement," WHERE ", sortValue)
					if Session("sort_direction" & dbkey & formgroup) <> "" then
						orderbyAdd=  " ORDER BY " & Session("order_by" & dbkey & formgroup) & " " &  Trim(Session("sort_direction" & dbkey & formgroup))
					end if
				end if
				
				if Application("ReportMaxHits") <> "" then
					on error resume next
					if CLng(Session("hitlistRecordCount" & dbkey & formgroup) + 1) > CLng(Application("ReportMaxHits")) then
						bAboveMax = true
					else
						bAboveMax = false
					end if
					on error goto 0
					if bAboveMax = true then
							if UCase(Application("PreventReportAboveMax")) = "TRUE" then
								Session("ReportHitListMessage" & dbkey & formgroup) =Application("PreventReportAboveMaxMessage")  
								csdo_select = " IN(select BIOSARDB.csdohitlist.ID from BIOSARDB.csdohitlist where BIOSARDB.csdohitlist.hitlistid =" & Session("hitlistid" & dbkey & formgroup) & " AND  ROWNUM < " & Application("ReportMaxHits") + 1 & ")"
								full_sql = Replace(select_statement, "#=ROWID#", csdo_select)
								full_sql = Replace(full_sql, "#=ROWID#", csdo_select)
								
							else
								Session("ReportHitListMessage" & dbkey & formgroup) = Application("ReportAboveMaxWarningMessage")
								csdo_select = " IN(Select BIOSARDB.csdohitlist.ID from BIOSARDB.csdohitlist where BIOSARDB.csdohitlist.hitlistid =" & Session("hitlistid" & dbkey & formgroup) & ")"
								full_sql = Replace(select_statement, "#=ROWID#", csdo_select)
								full_sql = Replace(full_sql, "#=ROWID#", csdo_select)
								
							end if
						
					else
							Session("ReportHitListMessage" & dbkey & formgroup) = ""
							csdo_select = " IN(Select BIOSARDB.csdohitlist.ID from BIOSARDB.csdohitlist where BIOSARDB.csdohitlist.hitlistid =" & Session("hitlistid" & dbkey & formgroup) & ")"
							full_sql = Replace(select_statement, "#=ROWID#", csdo_select)
							full_sql = Replace(full_sql, "#=ROWID#", csdo_select)
							
					end if
					if orderbyAdd <> "" then
						full_sql = full_sql & orderbyAdd & "," & order_by
					else
						full_sql = full_sql &  order_by
					end if
					
					full_sql = modifysql(full_sql)
				else
					Session("ReportHitListMessage" & dbkey & formgroup) = ""
					csdo_select = " IN(Select BIOSARDB.csdohitlist.ID from BIOSARDB.csdohitlist where BIOSARDB.csdohitlist.hitlistid =" & Session("hitlistid" & dbkey & formgroup) & ")"
					full_sql = Replace(select_statement, "#=ROWID#", csdo_select)
					full_sql = Replace(full_sql, "#=ROWID#", csdo_select)
					if orderbyAdd <> "" then
						full_sql = full_sql & orderbyAdd & "," & order_by
					else
						full_sql = full_sql &  order_by
					end if	
					
					full_sql = modifysql(full_sql)
				end if
				csdo_select_new = " IN(select BIOSARDB.csdohitlist.ID from BIOSARDB.csdohitlist where BIOSARDB.csdohitlist.hitlistid =" & Session("hitlistid" & dbkey & formgroup) & " AND  ROWNUM < 2)"
				full_sql_new = Replace(select_statement, "#=ROWID#", csdo_select_new)
				full_sql_new = Replace(full_sql_new, "#=ROWID#", csdo_select_new)	
				if orderbyAdd <> "" then
					full_sql_new = full_sql_new & orderbyAdd & "," & order_by
					full_sql_new = modifysql(full_sql_new)
				else
					full_sql_new = full_sql_new & order_by
					full_sql_new = modifysql(full_sql_new)
				end if	
				'end if
					if Session("fg_fields_reportSQL" & dbkey & formgroup & display_view) <> "" then
						Session("fg_fields_reportSQL" & dbkey & formgroup & display_view)  = Session("fg_fields_reportSQL" & dbkey & formgroup& display_view)  & "~" & full_sql
					else
						Session("fg_fields_reportSQL" & dbkey & formgroup & display_view)  = full_sql
					end if
					if Session("fg_fields_reportSQL_NEW" & dbkey & formgroup & display_view) <> "" then
						Session("fg_fields_reportSQL_NEW" & dbkey & formgroup & display_view)  = Session("fg_fields_reportSQL_NEW" & dbkey & formgroup & display_view)  & ":::" & replace(temp_array(0), ".", "_") & ";;;" & temp_array(1) & ";;;" & temp_array(2) & ";;;" &  temp_array(3) & ";;;" &   temp_array(4) & ";;;" & full_sql_new
					else
						Session("fg_fields_reportSQL_NEW" & dbkey & formgroup & display_view)  = replace(temp_array(0), ".", "_") & ";;;" & temp_array(1) & ";;;" & temp_array(2) & ";;;" &  temp_array(3) & ";;;" &   temp_array(4) & ";;;" & full_sql_new
					end if
				
			Case "ALL_FIELDS"
				select_statement_array = Split(select_statement, " WHERE ", -1)
				select_and_from_only =   select_statement_array(0) & " WHERE "
				full_sql = AddCSDOHitListToSelectTopN(dbkey, formgroup, select_and_from_only, Application("ReportMaxHits") +1)
				full_sql = full_sql & order_by
					if Session("all_fields_reportSQL" & dbkey & formgroup & display_view) <> "" then
						Session("all_fields_reportSQL" & dbkey & formgroup & display_view) = Session("all_fields_reportSQL" & dbkey & formgroup & display_view) & "~" & full_sql
					else
						Session("all_fields_reportSQL" & dbkey & formgroup & display_view) = full_sql
					end if
				
			end select
		end if
		if logReportInfo = true then
			logaction(Session("fg_fields_reportSQL_NEW" & dbkey & formgroup & display_view))
		end if
End Sub



Sub WriteOutVars(dbkey,formgroup)
	response.Write "fg_fields_reportSQL_LIST" & "<br>" & Session("fg_fields_reportSQL" & dbkey & formgroup & "LIST")& "<br>"
	response.Write "fg_fields_reportSQL_DETAIL" & "<br>" &  Session("fg_fields_reportSQL" & dbkey & formgroup & "DETAIL")& "<br>"
	response.Write "fg_fields_reportSQL_NEW_LIST" & "<br>" &  Session("fg_fields_reportSQL_NEW" & dbkey & formgroup & "LIST")& "<br>"
	response.Write "fg_fields_reportSQL_NEW_DETAIL" & "<br>" &  Session("fg_fields_reportSQL_NEW" & dbkey & formgroup & "DETAIL")& "<br>"
	
	response.Write "fg_fields_QueryNames_LIST" & "<br>" &  Session("fg_fields_QueryNames" & dbkey & formgroup & "LIST") & "<br>"
	response.Write "fg_fields_QueryNames_DETAIL" & "<br>" &  Session("fg_fields_QueryNames" & dbkey & formgroup & "DETAIL")& "<br>"


End Sub

Function AddCSDOHitListToSelectTopNTopN(dbkey, formgroup, select_statement, TopN)
	Trace "In:AddCSDOHitListToSelectTopNTopN" & showErrorIfAny, 25
	
	basetable = getBaseTable(dbkey, formgroup, "basetable")
	fullCDSOName = getCSDOQualifiedName(dbkey, formgroup, basetable)
	temp = Split(select_statement, "FROM", -1)
	baseid = GetTableVal(dbkey, basetable, kPrimaryKey)
	TranlateRelKey=baseid
	if TopN <> "" then
		ModifiedSQLWithCSDO =  temp(0) & " FROM " & fullCDSOName & "," & temp(1) &_
		" " & fullCDSOName & ".ID=" &  UCase(basetable) & "." & UCase(TranlateRelKey) &_
		" AND " & fullCDSOName & ".hitlistID=" & Session("hitlistID" & dbkey & formgroup) &_
		" AND ROWNUM < " & topN + 1 
	else
		ModifiedSQLWithCSDO =  temp(0) & " FROM " & fullCDSOName & "," & temp(1) &_
		" " & fullCDSOName & ".ID=" &  UCase(basetable) & "." & UCase(TranlateRelKey) &_
		" AND " & fullCDSOName & ".hitlistID=" & Session("hitlistID" & dbkey & formgroup) 
		 
	end if
	AddCSDOHitListToSelectTopN= ModifiedSQLWithCSDO
	Trace "Out:AddCSDOHitListToSelectTopN" & showErrorIfAny, 25
End Function 


Function getRSReportDisplaySQL(unparsed_sql, display_type)
	Trace "In:getRSReportDisplaySQL" & showErrorIfAny, 25
	
	display_sql_array = Split(unparsed_sql, "|:|", -1)
	Select Case UCase(display_type)
		CASE "ALL"
			returnSQL = display_sql_array(0)
		Case "LIST"
			
			returnSQL = display_sql_array(1)
			
			
		Case  "DETAIL"
			
			returnSQL = display_sql_array(2)
	End Select
	getRSReportDisplaySQL = returnSQL
	Trace "Out:getRSReportDisplaySQL" & showErrorIfAny, 25
End Function
'**********************************************
'END ACCESS REPORT CODE
'**********************************************


'**********************************************
'START CONNECTION UTILITIES
'*********************************************
Function GetUserConn ()
	Trace "In:GetUserConn" & showErrorIfAny, 25
	
	if Not isObject(userConn) then
		Set userConn = GetNewConnection( _
					"biosar_browser", _
					"base_form_group", _
					"base_connection")
	else
		if userConn.State = 0 then
			Set userConn = GetNewConnection( _
					"biosar_browser", _
					"base_form_group", _
					"base_connection")
		end if
	end if
	Set GetUserConn = userConn
	Trace "Out:GetUserConn" & showErrorIfAny, 25
End Function


Function getShapeConn()
	Trace "In:getShapeConn" & showErrorIfAny, 25
	if Not isObject(shapeConn) then
		Set shapeConn = GetNewDataShapeConnection(dbkey, formgroup, "base_connection")
	else
		if shapeConn.state = 0 then
			Set shapeConn = GetNewDataShapeConnection(dbkey, formgroup, "base_connection")
		end if
	end if
	Set getShapeConn = shapeConn
end  function

Function slideScript()
	Trace "In:slideScript" & showErrorIfAny, 25
	slideScript = "<script FOR=""window"" EVENT=""onscroll"" LANGUAGE=""JScript""> MainWindow.slideVertical(); MainWindow.slideHorizontal();</script>" 
	Trace "Out:slideScript" & showErrorIfAny, 25
end function

Function getSizedGifDisplay(base64,uniqueid,width, height, tablename, fieldname)
		Trace "In:getSizedGifDisplay" & showErrorIfAny, 25
		
		b64 = replace(base64, "###", "")
		myDir = Application("TempFileDirectory" & dbkey)  & tablename & fieldname  & "_" & uniqueid & "." & "cdx"	
		decodebase64 b64, myDir
		displaytype="SIZEDGIF"
		embed_tag_string = "<IMG SRC="
		embed_tag_string = embed_tag_string &  """"  
		embed_tag_string = embed_tag_string &  Application("ActionForm" & dbkey) & "?dbname=" & dbkey & "&formgroup=" & formgroup & "&dataaction=get_structure&Table=" & tablename & "&Field=" & fieldname & "&DisplayType=" & displaytype  & "&StrucID=" & uniqueid & "&width=" & width & "&height=" & height
		embed_tag_string = embed_tag_string  &  """ border=0>"
		getSizedGifDisplay=embed_tag_string
		Trace "Out:getSizedGifDisplay" & showErrorIfAny, 25
End Function






sub resetAtEnd(dbkey, formgroup,hits_count_restriction)
	Trace "In:resetAtEnd" & showErrorIfAny, 25
	
	Session("Base_RSRecordCount" & dbkey & formgroup)=hits_count_restriction
	totalRecords = hits_count_restriction
	trial_index_reset = Clng(current_index) + Clng(tPageSize) - 1
	
	on error resume next
	if  Clng(trial_index_reset) < Clng(hits_count_restriction) then 
		end_index_reset = trial_index_reset
	else
		end_index_reset = hits_count_restriction
	End if
	if tPageSize > 1 then
		if end_index_reset = hits_count_restriction then
			Session("AtEnd" & dbkey & formgroup) = "True"
		else
			if Clng(hits_count_restriction - end_index_reset) < Clng(tPageSize) then
				remainder_reset = hits_count_restriction Mod tPageSize
				if Clng(hits_count_restriction - remainder_reset) > Clng(end_index_reset) then
					Session("AtEnd" & dbkey & formgroup) = "True"	
				end if
			end if
		end if
	else
		if end_index_reset = hits_count_restriction then
			Session("AtEnd" & dbkey & formgroup) = "True"
		end if
	end if

End sub

Function removeStrucFromSelect(input_sql, struc_field_array)
	Trace "In:removeStrucFromSelect" & showErrorIfAny, 25
	
	dim output_sql
	output_sql = input_sql
	for i = 0 to UBound(struc_field_array)
		 removeItem = struc_field_array(0) & " as STRUCTURE"
		 'if it is at the beginning or middle of the list
		 output_sql = replace(output_sql, removeItem & ",", "")
		 'if it is at the end of the list
		 output_sql = replace(output_sql, "," & removeItem , "")
		 'if it is the only item in the list
		 output_sql = replace(output_sql, removeItem , "")
	next
	removeStrucFromSelect = output_sql
	Trace "Out:removeStrucFromSelect" & showErrorIfAny, 25
End function

function getStrucFieldList(dbkey, formgroup)
	Trace "In:getStrucFieldList" & showErrorIfAny, 25
	
	struc_fields = GetFormGroupVal(dbkey, formgroup, kStructureFields)
	temp = split(struc_fields, ",", -1)
	for i = 0 to UBound(temp)
		temp2 = split(temp(i), ".", -1)
		tablename = temp2(0) & "." & temp2(1)
		if realNameList <> "" then
			realNameList = realNameList & "," &  GetTableVal(dbkey, tablename, kTableRealName) & "." & temp2(2)
		else
			realNameList =  GetTableVal(dbkey, tablename, kTableRealName) & "." & temp2(2)
		end if
	next
	getStrucFieldList = realNameList
	Trace "Out:getStrucFieldList" & showErrorIfAny, 25
End function

function replaceBaseTablePlaceholders(dbkey,formgroup,order_by,sql)
	Trace "In:replaceBaseTablePlaceholders" & showErrorIfAny, 25
	Dim F_PLACEHOLDER
	dim S_PLACEHOLDER
	dim J_PLACEHOLDER
	F_PLACEHOLDER =""
	S_PLACEHOLDER =""
	F_PLACEHOLDER =""
	basetable = getbasetable(dbkey, formgroup, "basetable")
	order_by_temp = split(order_by, ",", -1)
	for i = 0 to UBound(order_by_temp)
		temp = split(order_by_temp(i), ".", -1)
		if UBound(temp)=2 then
			table_temp = temp(0) & "." & temp(1)
			full_field_name = table_temp & "." & temp(2)
		else
			table_temp = temp(0)
			full_field_name =temp(0) & "." & temp(1)
		end if
		
		
		if Not Trim(UCase(table_temp)) = Trim(Ucase(basetable)) then
			'we only support one sort so I know that if subforms <> "" there is only one. 
				F_PLACEHOLDER= "," & table_temp
				S_PLACEHOLDER = "," & full_field_name
				J_PLACEHOLDER  = " AND " & GetTableVal(dbkey,table_temp,kSelectJoin)
		else
			if not inStr(sql, temp(2)) > 0 then
				S_PLACEHOLDER = "," & full_field_name
			end if
		end if
	next
	'The order by clause shouldn't be added since the widget does the initial sort.	'for now just remove them
	sql = replace(sql, "#S_PLACEHOLDER#", S_PLACEHOLDER)
	sql = replace(sql, "#F_PLACEHOLDER#", F_PLACEHOLDER)
	sql = replace(sql, "#J_PLACEHOLDER#", J_PLACEHOLDER)
	if order_by <> "" then
'-- CSBR ID: 127416
'-- Change Done by : Manoj Unnikrishnan
'-- Purpose: Deliberate check not to use base table order by if sort all fields is set
'-- Date: 25/10/2010
		if Application("ALLOW_SORT_ALL_FIELDS") <> 1 then
    		sql= sql & " order by " & order_by
    	end if
'-- End of Change #127416#
	end if
	replaceBaseTablePlaceholders=sql
	Trace "Out:replaceBaseTablePlaceholders" & showErrorIfAny, 25
End function

function showErrorIfAny()

	handdebugging = true
	
	if handdebugging = true then
		sessionmsg = "<br>sessionid=" & Session.SessionID & "<br>"
		hitlistmsg = "<br>hitlistid=" & Session("hitlistid" & dbkey & formgroup) & "<br>"
	else
		hitlistmsg = ""
		sessionmsg = ""
	end if
	if err.number <> "" and err.number<> "0" and err.number <> 0 then
		msg = "<br>Error Number=" & err.number & "<br>Error Description=" & err.Description
	else
		msg = ""
	end if
	
	showErrorIfAny = sessionmsg & hitlistmsg & msg

End function


%>
