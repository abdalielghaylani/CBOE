<%' Copyright 1999-2003 CambridgeSoft Corporation. All rights reserved
'DO NOT EDIT THIS FILE%>
<%Function exportRDFile(ByVal dbkey, ByVal formgroup, ByVal fieldstoexport_input, ByVal ExportType, ByVal MaxExportNumber)
	Response.Write "This Feature is In progress"
	Response.end
	fieldstoexport=TrimItemsInString(dbkey, formgroup, fieldstoexport_input)
	subFormsString = getTablesString(dbkey, formgroup, fieldstoexport)
	Select case UCase(ExportType)
		Case "VIEW"
			Session("error" & dbkey & formgroup)= False
			true_basetable = GetBaseTable(dbkey, formgroup, "basetable")
			basetable = true_basetable
			true_baseid = GetTableVal(dbkey, basetable, kPrimaryKey)
			ViewInfo = GetFormGroupVal(dbkey, formgroup,kSDFileFields)
			ViewInfoArray = Split(ViewInfo,";", -1)
			ViewInfoArray2 = Split(ViewInfoArray(0), ":", -1)
			view_basetable = ViewInfoArray2(1)
			view_baseid =  true_baseid
			StrucUniqueID = "MOL_ID"
			if maxexportNumber <> "" then
				maxhits = maxexportNumber
			else
				maxhits = ""
			end if
		
			fieldstoexport_final = checkForMolid(dbkey, formgroup, fieldstoexport,basetable & "." & "mol_id")
			strGetFields = replace(fieldstoexport_final, view_basetable, UCase(true_basetable))
			
			'strGetFields = true_basetable & ".*"
			baseSQL = BuildSelectStatement(dbkey, formgroup, true_basetable, "",strGetFields,maxhits)
			sql = AddCSDOHitListToSelect(dbkey, formgroup, baseSQL)
			
			sql = RemoveDistinct(dbkey, fromgroup, sql)
			sql=replace(sql, UCase(true_basetable), view_basetable)
			sql = FinalizeSQl(dbkey, formgroup, sql, basetable)
			if maxhits <> "" then
				sql = SetMaxHitsSQL(dbkey, formgroup, sql,basetable, maxhits)
			end if
		Case Else
			Session("error" & dbkey & formgroup)= False
			basetable = GetBaseTable(dbkey, formgroup, "basetable")
			StrucUniqueID = GetTableVal(dbkey, basetable,kStrucFieldID)
			if maxexportNumber <> "" then
				maxhits = maxexportNumber
			else
				maxhits = ""
			end if
			fieldstoexport_final = checkForMolid(dbkey, formgroup, fieldstoexport,basetable & "." & StrucUniqueID )
			strGetFields = fieldstoexport_final
			'strGetFields = BuildAllStrFields(dbkey, formgroup,  subFormsString) & "," & basetable & ".*"
			baseSQL = BuildSelectStatement(dbkey, formgroup, basetable, subFormsString,strGetFields,maxhits)
			sql = AddCSDOHitListToSelect(dbkey, formgroup, baseSQL)
			sql = RemoveDistinct(dbkey, fromgroup, sql)
			sql = FinalizeSQl(dbkey, formgroup, sql, basetable)
			if maxhits <> "" then
				sql = SetMaxHitsSQL(dbkey, formgroup, sql, basetable, maxhits)
			end if
			
	End Select
	
	rsname = "SD_File"
	on error resume next
	
	Set RS = CreateRecordset(rsname, dbkey, formgroup, sql, maxhits, adOpenKeySet, adLockReadOnly)
	
	recordcount = getRecordcount(dbkey, formgroup, RS)
	
	if maxexportNumber<> "" then
		FlushMessageToClient("export is limited to a maximum of " & maxexportNumber & " records.")
		FlushMessageToClient("exporting " & recordcount & " records...")
	else
		FlushMessageToClient("exporting " & recordcount & " records...")
	end if
	'FlushMessageToClient("exporting " & recordcount & " records")
	if err.number <> 0 or Not recordcount <> "" then
		Session("fEmptyRecordset" & dbkey & formgroup) = True
		FlushMessageToClient("The recordset was not succesfully created: <br>" & sql)
		FlushMessageToClient("Error : <br>" &  err.description)
		Response.end
	else
			molfilepath = Application("TempFileDirectory" & dbkey) & "Sessiondir\" & Session.sessionid & "\"
			molfilepathhttp =Application("TempFileDirectoryHTTP" & dbkey) & "Sessiondir/" & Session.sessionid & "/"
	
			sdfilename=  GetTimeStamp()
	
			'Set Fields = Session("SD_File" & dbkey & formgroup).Fields
			Set fs = Server.CreateObject("Scripting.FileSystemObject")
			Set a = fs.CreateTextFile(molfilepath & sdfilename & ".sdf")  
			storeTimeout = server.ScriptTimeout
			server.ScriptTimeout = 10000000
			If not (RS.EOF and RS.BOF) = true then
				Set myConnection = CSDOGetCSDOConnection(dbkey, formgroup)
				RS.MoveFirst
				counter = 1
				'DisplayProcessingCount "OpenWindow", counter-1 
				InitializeProgressBar true, ""
				Do While Not RS.EOF
					FlushMessageToClient(" ")
					Tablename = GetBaseTable(dbkey, formgroup, "moltable")
					if Not UCase(ExportType) = "VIEW" then
						Fieldname = "Structure"
					else
						Fieldname = "View_Structure"
					end if
					
					UniqueID = RS(StrucUniqueID)
					
					if (Not UniqueID = "") AND (Not isEmpty(UniqueID)) then
						if Not UCase(ExportType) = "VIEW" then
							UniqueID = RS(basetable & "." & StrucUniqueID)
						else
							UniqueID = RS(view_basetable & "." & StrucUniqueID)
						end if
					end if
					
					if (Not UniqueID = "") AND (Not isEmpty(UniqueID)) then
						If CLng(UniqueID) > 0 then
							FileType = "sdout.mol"
							myTime = Timer()
							' return molweight
							'check to see if there is a structure
							CSDOGetChemData dbkey, formgroup, TableName, Fieldname, UniqueID, "MOLWEIGHT", myConnection
							If Not Session("MW" & dbkey & formgroup & TableName & Fieldname & UniqueID)="" then
								CSDOGetChemData dbkey, formgroup, TableName, Fieldname, UniqueID, FileType, myConnection
								myDir = molfilepath & "sdout.mol"
								Set b = fs.OpenTextFile(myDir)
								do while b.AtEndOfStream <> True
									myvar = b.ReadLine
									a.WriteLine myvar
								loop
								b.close
							end if
							'fs.DeleteFile myDir, True
							a.WriteLine ">  <" & StrucUniqueID & "> " & "(" & counter & ")"
							a.WriteLine UniqueID
							a.WriteLine " "
						end if
					end if
					on error resume next
					Dim i
					For i = 0 to RS.Fields.Count-1
						fieldname = RS.Fields.Item(i).Name
						fieldvalue = RS.Fields.Item(i).Value
						err.Clear()
						a.WriteLine ">  <" & fieldname & "> " & "(" & counter & ")"
						a.WriteLine fieldvalue
						
						a.WriteLine ""
					Next 'i

					a.WriteLine "$$$$"
					RS.MoveNext
					counter = counter + 1
					'DisplayProcessingCount "UpdateWindow", counter-1
					 Progressbar counter, recordcount,5
					if err.number <> 0 then
						response.write err.number
					end if
				loop 'j
			'DisplayProcessingCount "CloseWindow", ""
			Set myConnection = Nothing	
			a.close
			RS.Close
			server.ScriptTimeout = storeTimeout
		end if
		
	end if
	Set RS= Nothing
	exportRDFile = molfilepathhttp & sdfilename & ".sdf"
End Function

%>