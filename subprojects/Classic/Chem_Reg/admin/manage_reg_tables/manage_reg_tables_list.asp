<%@ LANGUAGE=VBScript %>
<%	Response.expires=0
'Copyright 1999-2003 CambridgeSoft Corporation. All rights reserved
'DO NOT EDIT THIS FILE
dbkey="reg"
if Not Session("UserValidated" & dbkey) = 1 then  response.redirect "/" & Application("Appkey") & "/logged_out.asp"
Session("reload_list")=false
%>


<html>

<head>
<!--#INCLUDE VIRTUAL = "/cfserverasp/source/cows_func_js.asp"-->
<!--#INCLUDE FILE = "../../source/app_vbs.asp"-->
<!--#INCLUDE FILE = "../../source/secure_nav.asp"-->
<script language = "javascript">
var limit_access = ""	
</script>
<%
table_name = request("table_name")
access_override = Request.QueryString("limit_access")
table_name = Request("table_name")
if table_name <> "" then
Session("table_name") = table_name
else
table_name = Session("table_name")
end if
if (bMANAGE_PEOPLE_PROJECT = true and UCase(table_name) = "PROJECTS") then
		'rebuild rs with full regdb access so no projects are hidden form the admin
		storeSessionUser = Session("UserName" & dbkey)
		storeSessionPWD = Session("UserID" & dbkey)
		Session("UserName" & dbkey) = Application("REG_USERNAME")
		Session("UserID" & dbkey) =  Application("REG_PWD")
		Set DataConn = GetNewConnection(dbkey, formgroup, "base_connection")
		Session("UserName" & dbkey) = storeSessionUser
		Session("UserID" & dbkey) = storeSessionPWD
	else
		Set DataConn = GetNewConnection(dbkey, formgroup, "base_connection")
	end if
	if DataConn.State=0 then ' assume user has been logged out
		DoLoggedOutMsg()
	end if	

if not Session("access_override" & table_name) <> "" then
 Session("access_override" & table_name) = Request.QueryString("limit_access")
end if
%>

<%
formmode = UCase(request("formmode"))
bRLS = CBool(Application("PROJECT_LEVEL_ROW_SECURITY"))
if bRLS = true then
	if (bMANAGE_PEOPLE_PROJECT = true and UCase(table_name) = "PROJECTS") then
		Session("fEmptyRecordset" & dbkey & formgroup) = false
		Session("error" & dbkey & formgroup)= false
		sql = "Select project_internal_id from projects where project_internal_id>0"
		RequeryDBRebuildRS dbkey, formgroup, sql, "", "", DataConn
	end if
end if
	Select case UCase(table_name)
		Case "COMPOUND_TYPE"
			sql = "select compound_type from compound_type where compound_type >0"
		Case "PROJECTS"
			sql = "select project_internal_id from projects  where project_internal_id >0"
		Case "NOTEBOOKS"
			sql = "select notebook_number from notebooks  where notebook_number >0"
		Case "SEQUENCE"
			sql = "select sequence_id from sequence  where sequence_id >0"
		Case "SALTS"
			sql = "select salt_code from salts  where salt_code >0"
		Case "SOLVATES"
			sql = "select solvate_id from solvates  where solvate_id >0"
		Case "BATCH_PROJECTS"
			sql = "select batch_project_id from batch_projects  where batch_project_id >0"
		Case "UTILIZATIONS"
			sql = "select utilization_id from utilizations  where utilization_id >0"
		Case "PEOPLE"
			sql = "select person_id from people  where person_id >0"
		Case "SITES"
			sql = "select site_id from sites  where site_id >0"
	end Select

	
	RequeryDBRebuildRS dbkey, formgroup, sql, "", "",DataConn
	if  Session("hitlistrecordcount" & dbkey & formgroup) > 0 then
		Session("fEmptyRecordset" & dbkey & formgroup) = true
		
	else
		Session("fEmptyRecordset" & dbkey & formgroup) = false
		Session("error" & dbkey & formgroup)= false
	end if
%>


<script language = "javascript">
var table_name = "<%=table_name%>"	
limit_access="<%=access_override%>"
</script>
<title>Manage Registry Tables</title>

</head>

<body >
<table border="1" cellpadding="0" cellspacing="0"><TR>

<!--#INCLUDE VIRTUAL = "/cfserverasp/source/header_vbs.asp"-->
<%Session("PreAddReturnLocation" & dbkey & formgroup) = Session("CurrentLocation"& dbkey & formgroup)
Session("ListLocation" & dbkey & formgroup)=Session("CurrentLocation"& dbkey & formgroup)%>
<input type = "hidden" name = "table_name" value = "<%=table_name%>">
<%project_level_SECURITY=CBool(Application("PROJECT_LEVEL_ROW_SECURITY"))%>

<script language="javascript">
	table_name = "<%=table_name%>"
	var project_level_SECURITY= "<%=project_level_SECURITY%>"
	var bProjectDone = false
	if (project_level_SECURITY == true){
		if ((table_name.toLowerCase() == "projects")&& (bMANAGE_PEOPLE_PROJECT.toLowerCase()=="true")&& (project_level_SECURITY.toLowerCase()== "true")){
			bProjectDone = true
			getFormViewLink('new', "/<%=Application("AppKey")%>/admin/manage_reg_tables/manage_people_project.asp",0,'add_record', "&table_name=" + "projects")
		}
		if (bProjectDone == false){
			if ((table_name.toLowerCase() == "projects")&& (bADD_PROJECTS_TABLE.toLowerCase()=="true")&& (bMANAGE_PEOPLE_PROJECT.toLowerCase()!="true")){
				getFormViewLink('new', "/<%=Application("AppKey")%>/admin/manage_reg_tables/manage_reg_tables_result_form.asp",0,'add_record', "&table_name=" + "projects")
			}
		}
	}else{
		if ((table_name.toLowerCase() == "projects")&& (bADD_PROJECTS_TABLE.toLowerCase()=="true")){
				getFormViewLink('new', "/<%=Application("AppKey")%>/admin/manage_reg_tables/manage_reg_tables_result_form.asp",0,'add_record', "&table_name=" + "projects")
		}

	}

	if ((table_name.toLowerCase() == "notebooks")&& (bADD_NOTEBOOKS_TABLE.toLowerCase()=="true")){
		getFormViewLink('new', "/<%=Application("AppKey")%>/admin/manage_reg_tables/manage_reg_tables_result_form.asp",0,'add_record', "&table_name=" + "notebooks")
	}
	if ((table_name.toLowerCase() == "sequence")&& (bADD_SEQUENCES_TABLE.toLowerCase()=="true")){
		getFormViewLink('new', "/<%=Application("AppKey")%>/admin/manage_reg_tables/manage_reg_tables_result_form.asp",0,'add_record', "&table_name=" + "sequence")
	}
	
	if ((table_name.toLowerCase() == "compound_type")&& (bADD_COMPOUND_TYPE_TABLE.toLowerCase()=="true")){
		getFormViewLink('new', "/<%=Application("AppKey")%>/admin/manage_reg_tables/manage_reg_tables_result_form.asp",0,'add_record', "&table_name=" + "compound_type")
	}
	
	if ((table_name.toLowerCase() == "salts")&& (bADD_SALT_TABLE.toLowerCase()=="true")){
		getFormViewLink('new', "/<%=Application("AppKey")%>/admin/manage_reg_tables/manage_reg_tables_result_form.asp",0,'add_record', "&table_name=" + "salts")
	}
	
	if ((table_name.toLowerCase() == "sites")&& (bADD_SITES_TABLE.toLowerCase()=="true")){
		getFormViewLink('new', "/<%=Application("AppKey")%>/admin/manage_reg_tables/manage_reg_tables_result_form.asp",0,'add_record', "&table_name=" + "sites")
	}
	if ((table_name.toLowerCase() == "solvates")&& (bADD_SOLVATES_TABLE.toLowerCase()=="true")){
		getFormViewLink('new', "/<%=Application("AppKey")%>/admin/manage_reg_tables/manage_reg_tables_result_form.asp",0,'add_record', "&table_name=" + "solvates")
	}
	if ((table_name.toLowerCase() == "batch_projects")&& (bADD_BATCH_PROJECTS_TABLE.toLowerCase()=="true")){
		getFormViewLink('new', "/<%=Application("AppKey")%>/admin/manage_reg_tables/manage_reg_tables_result_form.asp",0,'add_record', "&table_name=" + "batch_projects")
	}
	if ((table_name.toLowerCase() == "utilizations")&& (bADD_UTILIZATIONS_TABLE.toLowerCase()=="true")){
		getFormViewLink('new', "/<%=Application("AppKey")%>/admin/manage_reg_tables/manage_reg_tables_result_form.asp",0,'add_record', "&table_name=" + "utilizations")
	}
	if (limit_access.toLowerCase() != "workgroup"){
		//SYAN modified on 12/3/2004 to fix CSBR-49961
		//if ((table_name.toLowerCase() == "people")&& (bADD_PEOPLE_TABLE.toLowerCase()=="true")){
		//	getFormViewLink('new', "/<%=Application("AppKey")%>/admin/manage_reg_tables/manage_reg_tables_result_form.asp",0,'add_record', "&table_name=" + "people")
		//}
		//End of SYAN modification
	}
	</script>

<%


if Not Session("fEmptyRecordset" & dbkey & formgroup) = True  then


	Select case UCase(table_name)
		Case "NOTEBOOKS"
			relfields = "Notebooks.Notebook_Number;2,Notebooks.Notebook_Name;0, Notebooks.Location;0, Notebooks.Microfiche;0, People.Last_Name;0, Notebooks.Active;2"
		Case "PROJECTS"
		if CBOOL(Application("PROJECTS_NAMED_OWNER")) = True  then
			relfields = "ID;2,Owner Name;0,Active;2"
		else
			relfields = "ID;2,Project Name;0,Active;2"
		end if
		Case "PEOPLE"
			relfields = "People.Person_ID;2,People.User_ID;0,People.Supervisor_Internal_ID;2,People.User_Code;0,People.First_Name;0,People.Last_Name;0,People.Middle_Name;0,People.Telephone;0,People.Email;0,People.Active;2"

		Case "SEQUENCE"
			relfields = "ID;2,Prefix;0,Next In Sequence;0,Salt Delimiter;0,Prefix Delimiter;0,Root Number Length;1,Active;2"
		Case "COMPOUND_TYPE"
			relfields = "ID;2,Structure Comment;0,Active;2"
		Case Else
			relfields = GetTableVal(dbkey, table_name, kTableRelFields)
		
	end select
	relfields_array = split(relfields, ",", -1)%>

	<%Dim i
	for i = 0 to UBound(relfields_array)
	temp_array = split(relfields_array(i), ";", -1)
	if instr(temp_array(0), ".")> 0 then
		new_array = split(temp_array(0), ".", -1)
		fieldname = new_array(1)
	else
		fieldname =temp_array(0)
	end if 
	if UCase(fieldname) = "SUPERVISOR_INTERNAL_ID" then
		fieldname = "Supervisor"
	end if
	if err.number > 0 then response.write "<strong>" & fieldname & "</strong>" %>
    <td><%="<strong>" & fieldname &  "</strong>"%></td>
   <%next%>
   
   <%Select case UCase(table_name)
		Case "NOTEBOOKS"
			relfields = "Notebooks.Notebook_Number;2,Notebooks.Notebook_Name;0, Notebooks.Location;0, Notebooks.Microfiche;0, People.Last_Name;0, Notebooks.Active;2"
		Case "PEOPLE"
			relfields = "People.Person_ID;2,People.User_ID;0,People.Supervisor_Internal_ID;2,People.User_Code;0,People.First_Name;0,People.Last_Name;0,People.Middle_Name;0,People.Telephone;0,People.Email;0,People.Active;2"
		Case Else
			relfields = GetTableVal(dbkey, table_name, kTableRelFields)
		
	end select
	relfields_array = split(relfields, ",", -1)
	%>
  </tr>
 

<%end if
Session("ListLocation" & dbkey & formgroup) = Session("CurrentLocation" & dbkey & formgroup)
if Instr(Session("Message" & dbkey & formgroup),"Sorry")> 0 then
Session("Message" & dbkey & formgroup)="</td></tr></table>" & table_name & " table is empty. Click new to add records"
end if

'Session("LastStartingIndex" & dbkey & formgroup) = 1

%>
<!--#INCLUDE VIRTUAL ="/cfserverasp/source/recordset_vbs.asp"-->

<%
'BaseID represents the primary key for the recordset from the base array for the current row
'BaseActualIndex is the actual id for the index the record is at in the array
'BaseRunningIndex if the id based on the number shown in list view
'BastTotalRecords is the recordcount for the array
'BaseRS (below is the recordset that is pulled for each record generated
'on error resume next

	
	
	uniqueid = BaseID
	commit_type = "full_commit_ns"
	
	baseid_name = GetTableVal(dbkey, table_name, kPrimaryKey)
	
	Select Case UCase(table_Name)
		Case "NOTEBOOKS"
			sql = "Select Notebooks.Notebook_Number,Notebooks.Notebook_Name,Notebooks.Location,Notebooks.Microfiche,People.Last_Name,Notebooks.Active from " & "Notebooks, People where Notebooks.User_Code = People.Person_id AND Notebooks.Notebook_Number=" & BaseID
		
		Case Else
			sql = "Select * from " & table_name & " where " & baseid_name& "= " & BaseID
	End select
	if (bMANAGE_PEOPLE_PROJECT = true and UCase(table_name) = "PROJECTS") then
		'rebuild rs with full regdb access so no projects are hidden form the admin
		storeSessionUser = Session("UserName" & dbkey)
		storeSessionPWD = Session("UserID" & dbkey)
		Session("UserName" & dbkey) = Application("REG_USERNAME")
		Session("UserID" & dbkey) =  Application("REG_PWD")
		Set DataConn = GetNewConnection(dbkey, formgroup, "base_connection")
		Session("UserName" & dbkey) = storeSessionUser
		Session("UserID" & dbkey) = storeSessionPWD
	else
		Set DataConn = GetNewConnection(dbkey, formgroup, "base_connection")
	end if
	
	
	Set BaseRS = DataConn.Execute(sql)

	
%>
	<script language ="javascript">
		function getLink(field_val,force_formmode){
		var  commit_type = "full_commit_ns"
		//var table_name = "<%=table_name%>"
		var uniqueid = "<%=baseid%>"
		var test ="<%=request("limit_access")%>"
		
			if ((table_name.toLowerCase() == "projects")&& (bMANAGE_PEOPLE_PROJECT.toLowerCase()=="true")&& (project_level_SECURITY.toLowerCase()== "true")){
				getFormViewLink(field_val, "/<%=Application("AppKey")%>/admin/manage_reg_tables/manage_people_project.asp", <%=BaseActualIndex%>,force_formmode,uniqueid, "&table_name=" + table_name)
			}else
			{
				if ((table_name.toLowerCase() == "people")&& (test.toLowerCase()=="workgroup")){
			
					getFormViewLink(field_val, "/<%=Application("AppKey")%>/admin/manage_reg_tables/manage_reg_tables_result_form.asp", <%=BaseActualIndex%>,force_formmode,uniqueid, "&limit_access=workgroup&table_name=" + table_name)
				}else
				{
					getFormViewLink(field_val, "/<%=Application("AppKey")%>/admin/manage_reg_tables/manage_reg_tables_result_form.asp", <%=BaseActualIndex%>,force_formmode,uniqueid, "&table_name=" + table_name)
				}
			}
		
		}
</script>

<tr>


<%
for i = 0 to UBound(relfields_array)
	value = ""
	link_value = ""
	temp_array = split(relfields_array(i), ";", -1)
	if instr(temp_array(0), ".")> 0 then
		new_array = split(temp_array(0), ".", -1)
		fieldname = new_array(1)
	else
		fieldname =temp_array(0)
	end if 
	
	if Not (BaseRS.BOF AND BaseRS.EOF)then
			value = BaseRS(fieldname)
			
			if UCase(fieldname) = "SOLVATE_MF" or  UCase(fieldname) = "SALT_MF" then
				if CBool(Application("Format_Formula")) = True then
					value = GetHTMLStringForFormula(value)
				end if
			end if
			if UCase(fieldname) = "SUPERVISOR_INTERNAL_ID" then
				
				newvalue=""
				sql = "select user_id as theUser from cs_security.people where person_id=" & value
			on error resume next
				set rs2 = Server.CreateObject("ADODB.RECORDSET")
				RS2.Open sql, dataconn
			
				sql = "select user_id as theUser from cs_security.people where person_id=" & value
				newvalue=RS2("theUser")
				RS2.Close
				value = newvalue
			end if
			if trim(value) = "" or isNull(value) then
				value = " &nbsp;"
			end if
		else
		
			value = " &nbsp;"
	end if
%>
	<td>
	<%
	if i = 0 then
	Select Case UCase(table_name)
		
		Case "NOTEBOOKS"
			if bEDIT_NOTEBOOKS_TABLE= True or bDELETE_NOTEBOOKS_TABLE = True then
				bEdit = True
			end if
		Case "PEOPLE"
			if bEDIT_PEOPLE_TABLE= True or bDELETE_PEOPLE_TABLE = True then
				bEdit = True
			end if
		Case "PROJECTS"
			if bEDIT_PROJECTS_TABLE= True or bDELETE_PROJECTS_TABLE = True then
				bEdit = True
			end if
		Case "SEQUENCE"
			if bEDIT_SEQUENCES_TABLE= True or bDELETE_SEQUENCES_TABLE = True then
				bEdit = True
			end if
		Case "SITES"
			if bEDIT_SITES_TABLE= True or bDELETE_SITES_TABLE = True then
				bEdit = True
			end if
		
		Case "COMPOUND_TYPE"
			if bEDIT_COMPOUND_TYPE_TABLE= True or bDELETE_COMPOUND_TYPE_TABLE = True then
				bEdit = True
			end if
		Case "SALTS"
			if bEDIT_SALT_TABLE= True or bDELETE_SALT_TABLE = True then
				bEdit = True
			end if
		Case "SOLVATES"
			if bEDIT_SOLVATES_TABLE= True or bDELETE_SOLVATES_TABLE = True then
				bEdit = True
			end if
		Case "BATCH_PROJECTS"
			if bEDIT_BATCH_PROJECTS_TABLE= True or bDELETE_BATCH_PROJECTS_TABLE = True then
				bEdit = True
			end if
		Case "UTILIZATIONS"
			if bEDIT_UTILIZATIONS_TABLE= True or bDELETE_UTILIZATIONS_TABLE = True then
				bEdit = True
			end if
		end Select

		if bEdit = True then 
			bEditTable = True 
		else 
			bEditTable = False
		end if
		
		if bEditTable = True then%>
		<script language="javascript">
			link_value = "<%=value%>"
			if(link_value.length > 0 ){
				getLink(link_value, "edit_record")
			}
			else{
				document.write('')
			}
		</script>
		<%else
		Response.write value
		end if
	else

		if Not value <> "" then
			value = "&nbsp;"
		end if

		if UCase(fieldname) = "ACTIVE" then
		if not isNull(value) then
			value = CBool(value)
			end if
		end if
		
		'SYAN added on 5/27/2005 to fix CSBR-50860
		'if UCase(fieldname) = "DUP_CHECK_LOCAL" then
		'if not isNull(value) then
		'	value = CBool(value)
		'	end if
		'end if
		'End of SYAN modification
		
		Response.Write value
   end if%>
</td>

<%next%>

</TR>

<%'if err.number > 0 then Response.Write err.description
CloseRS(BaseRS)
CloseConn(DataConn)
%>   

<!--#INCLUDE VIRTUAL ="/cfserverasp/source/recordset_footer_vbs.asp"-->
</table>



</body>
</html>























