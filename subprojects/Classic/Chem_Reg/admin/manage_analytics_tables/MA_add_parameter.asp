<%@ LANGUAGE="VBScript"%>
<%'Copyright 1999-2003 CambridgeSoft Corporation. All rights reserved

'DO NOT EDIT THIS FILE%>

<%
Response.Expires = 0
dbkey="reg"
formgroup = request("formgroup")
if Not Session("UserValidated" & dbkey) = 1 then  response.redirect "/" & Application("Appkey") & "/logged_out.asp"
'Response.Write Session("MA_return_to") 
%>

<HTML>
<HEAD>
<META NAME="GENERATOR" Content="Microsoft Visual Studio 6.0">
<!--#INCLUDE VIRTUAL = "/cfserverasp/source/cows_func_js.asp"-->
<!--#INCLUDE FILE = "../../source/secure_nav.asp"-->
<%
'Response.write "currentrecord = " & Session("CurrentRecord" & dbkey)
Dim DataConn, oRS, sql, oCmd
dim eType, tStep, pType
' Collect data
if Request.QueryString("etype") <> "" Then eType = Request.QueryString("etype")
if Request.Form("STEP") <> "" Then tStep=Request.Form("STEP")
if Request.QueryString("unique_id") <> "" and eType = "" then eType=Request.QueryString("unique_id")
%>
</HEAD>
<BODY>
<!--#INCLUDE FILE = "../../source/app_vbs.asp"-->

<!--#INCLUDE VIRTUAL = "/cfserverasp/source/header_vbs.asp"-->
<% if tStep="" and eType <> "" Then %>
	<!-- Set up the available parameters and get the user to add one -->
	<%
	' Store the etype...
	Session("MA_etype") = eType

	' Response.Write "dbkey: " & dbkey & "<br>formgroup: " & formgroup & "<br>"

	Set DataConn = GetConnection(dbkey, formgroup, "experimenttype")
	If DataConn.State=0 then ' assume this means user has been timed out.
		DoLoggedOutMsg()
	end if
	sql = "SELECT parameter_type_name, parameter_type_id " & _
			"from parametertype " & _
			"where parameter_type_id NOT IN(select parameter_type_id " & _
			                              "from experimenttypeparameters " & _
			                              "where experiment_type_ID = " & eType & ")"
	Set oRS=DataConn.Execute(sql)
	%>
	<P>
	<FONT face="Arial" size="2" color="Navy"><STRONG>Step 1 of 2</STRONG> - Choose Parameter for ExperimentTypeID: <%=eType%></FONT></P>
	<FORM METHOD="Post" ACTION="\chem_reg\reg\analytics\manage_analytics_tables\MA_add_parameter.asp" ID="FormStep1" NAME="FormStep1">
	<FONT face="Arial" size="2" color="Navy">Parameter Type : </FONT>
	<SELECT NAME="ParameterType" SIZE="1">
	<%
	if Not (oRS.EOF and oRS.BOF)then
		do while not oRS.EOF=True
			Response.Write "<OPTION VALUE=""" & oRS("parameter_type_id").Value & """>" & oRS("parameter_type_name").Value & "</OPTION>"
			oRS.MoveNext
		loop
	else
		showmessagedialog("All possible parameters have been added.")
		redirectpath=MakeQueryStringBeDifferent(Session("MA_return_to"))
		doredirect dbkey,redirectpath
	end if
	%>
	<!--OPTION SELECTED VALUE="-1">New...</OPTION-->
	</SELECT>
	<INPUT TYPE="Hidden" NAME="STEP" VALUE="1">
	<INPUT TYPE="Submit" ID="Submit" NAME="Submit" VALUE="Add Parameter">
	</FORM>
	<%
	CloseRS(oRS)
	CloseConn(DataConn)
	'Set oRS=Nothing NOTE: this is uncessary as closers does this
	%>
<% elseif tStep="1" then

	pType = Request.Form("ParameterType")
	eType = Session("MA_etype")

	if CInt(pType) < 0 then
		Response.Write "Add new parameter type here...<br>"
	else
		Set DataConn = GetConnection(dbkey, formgroup, "experimenttype")
		If DataConn.State=0 then ' assume this means user has been timed out.
			DoLoggedOutMsg()
		end if
		' Extract the requested parameter_id - link it with the stored experiment_type_id
		' and create a new record in the table
		' then try to tell the main window to refresh :-)
		' Response.Write "eType: " & eType & "<br>pType: " & pType & "<br>"
		
		Set oCmd = Server.CreateObject("ADODB.Command")
		oCmd.ActiveConnection = DataConn
		oCmd.CommandType = adCmdText
		on error resume next
		sql = "INSERT INTO experimenttypeparameters(experiment_type_id,parameter_type_id) VALUES ('" & eType & "','" & pType & "')"
		'Response.Write sql
		'Response.end
		oCmd.CommandText = sql
		on error resume next
		oCmd.Execute

		if DataConn.Errors.Count <> 0 then
			for each lError in DataConn.Errors
				Response.Write "<br>"
				Response.Write "Connection Error: " & lError.Number & "<br>"
				Response.Write "          Source: " & lError.Source & "<br>"
				Response.Write "     Description: " & lError.Description & "<br>"
			next
		end if

		Set oCmd=Nothing
		CloseConn(DataConn)
	end if
	%>

	<%
	showmessagedialog("Finished adding Parameter to experiment")
	redirectpath=MakeQueryStringBeDifferent(Session("MA_return_to"))
	doredirect dbkey,redirectpath%>
<% else %>
	Should not come here...<br>
	The request.querystring was: <%=Request.QueryString%>
	The step is: "<%=tStep%>", the eType is: "<%=eType%>"<br>
<% end if %>
<!-- <a href="#" OnClick="window.close()">Close</a> -->
<%storeIndex = Session("CurrentRecord" & dbkey & formgroup)%>
<!--#INCLUDE VIRTUAL = "/cfserverasp/source/input_form_footer_vbs.asp"-->
<%Session("CurrentRecord" & dbkey & formgroup) = storeIndex%>
</BODY>
</HTML>
