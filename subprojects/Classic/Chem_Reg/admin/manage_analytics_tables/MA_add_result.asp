<%@ LANGUAGE="VBScript" %>
<%'Copyright 1999-2003 CambridgeSoft Corporation. All rights reserved

'DO NOT EDIT THIS FILE%>

<%Response.Expires = 0
'Copyright 1988-2001 CambridgeSoft Corporation, all rights reserved.
dbkey="reg"
formgroup = request("formgroup")
if Not Session("UserValidated" & dbkey) = 1 then  response.redirect "/" & Application("Appkey") & "/logged_out.asp"
%>

<HTML>
<HEAD>
<META NAME="GENERATOR" Content="Microsoft Visual Studio 6.0">
<!--#INCLUDE VIRTUAL = "/cfserverasp/source/cows_func_js.asp"-->
<!--#INCLUDE FILE = "../../source/secure_nav.asp"-->
<%
Dim DataConn, oRS, sql, oCmd
dim eType, tStep, pType
' Collect data
if Request.QueryString("etype") <> "" Then eType = Request.QueryString("etype")
if Request.Form("STEP") <> "" Then tStep=Request.Form("STEP")
if Request.QueryString("indexvalue") <> "" and eType = "" then eType=Request.QueryString("indexvalue")
%>
</HEAD>
<BODY>
<!--#INCLUDE FILE = "../../source/app_vbs.asp"-->
<!--#INCLUDE VIRTUAL = "/cfserverasp/source/header_vbs.asp"-->
<% if tStep="" and eType <> "" Then %>
<!-- Set up the available Results and get the user to add one -->
<%

' Store the etype...
Session("MA_etype") = eType

' Response.Write "dbkey: " & dbkey & "<br>formgroup: " & formgroup & "<br>"

Set DataConn = GetConnection(dbkey, formgroup, "experimenttype")
if DataConn.State=0 then ' assume user has been logged out
		DoLoggedOutMsg()
end if
sql = "SELECT result_type_name, result_type_id from resulttype"
Set oRS=DataConn.Execute(sql)
%>
<P>
<FONT face="Arial" size="2" color="Navy"><STRONG>Step 1 of 2</STRONG> - Choose Result for ExperimentTypeID: <%=eType%></FONT></P>
<FORM METHOD="Post" ACTION="\chem_reg\analytics\manage_analytics_tables\MA_add_result.asp" ID="FormStep1" NAME="FormStep1">
<FONT face="Arial" size="2" color="Navy">Result Type : </FONT>
<SELECT NAME="ResultType" SIZE="1">
<%
if Not (oRS.EOF and oRS.BOF)then
	do while not oRS.EOF=True
		Response.Write "<OPTION VALUE=""" & oRS("result_type_id").Value & """>" & oRS("result_type_name").Value & "</OPTION>"
		oRS.MoveNext
	loop

else
	showmessagedialog("No results available.")
	redirectpath=MakeQueryStringBeDifferent(Session("MA_return_to"))
	doredirect dbkey,redirectpath
end if
%>
<!--OPTION SELECTED VALUE="-1">New...</OPTION-->
</SELECT>
<INPUT TYPE="Hidden" NAME="STEP" VALUE="1">
<INPUT TYPE="Submit" ID="Submit" NAME="Submit" VALUE="Add Result">
</FORM>
<%
CloseRS(oRS)
CloseConn(DataConn)
Set oRS=Nothing
%>
<% elseif tStep="1" then
pType = Request.Form("ResultType")
eType = Session("MA_etype")

if CInt(pType) < 0 then
	Response.Write "Add new result type here...<br>"
else

	Set DataConn = GetConnection(dbkey, formgroup, "experimenttype")

	' Extract the requested result_id - link it with the stored experiment_type_id
	' and create a new record in the table
	' then try to tell the main window to refresh :-)

	Set oCmd = Server.CreateObject("ADODB.Command")
	oCmd.ActiveConnection = DataConn
	oCmd.CommandType = adCmdText

	sql = "INSERT INTO experimenttyperesults(experiment_type_id,result_type_id) VALUES ('" & eType & "','" & pType & "')"
	
	oCmd.CommandText = sql
	oCmd.Execute

	if DataConn.Errors.Count <> 0 then
		for each lError in DataConn.Errors
			Response.Write "<br>Connection Error: " & lError.Number & "<br>"
			Response.Write "         Source : " & lError.Source & "<br>"
			Response.Write "    Description : " & lError.Description & "<br>"
		next
	end if

	Set oCmd=Nothing
	CloseConn(DataConn)
end if

showmessagedialog("Finished adding Result to the experiment")
redirectpath=MakeQueryStringBeDifferent(Session("MA_return_to"))
doredirect dbkey,redirectpath
else%>
Should not come here...<br>
The request.querystring was: <%=Request.QueryString%>
The step is: "<%=tStep%>", the eType is: "<%=eType%>"<br>
<% end if %>
<!-- <a href="#" OnClick="window.close()">Close</a> -->
<!--#INCLUDE VIRTUAL = "/cfserverasp/source/input_form_footer_vbs.asp"-->
</BODY>
</HTML>
