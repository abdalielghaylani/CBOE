<%@ LANGUAGE=VBScript%>  
<%'Copyright 1999-2003 CambridgeSoft Corporation. All rights reserved
'DO NOT EDIT THIS FILE

Response.Expires=0
dbkey = Request("dbname")
formgroup = request("formgroup")
if dbkey="" Then dbkey="reg"

if Not Session("UserValidated" & dbkey)=1 then Response.Redirect "/" & Application("appkey") & "/logged_out.asp"
Dim ST_debug
ST_debug=False
%>
<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<html>

<head>
<!--#INCLUDE VIRTUAL = "/cfserverasp/source/cows_func_js.asp"-->
<!--#INCLUDE FILE = "../source/secure_nav.asp"-->

<script language="javascript">
</script>

<title>SAR Table - Main Results viewing page.</title>
</head>

<body background="/CFServerAsp/Source/graphics/Fine_Speckled.gif" bgProperties="fixed">
<!--#INCLUDE FILE = "../source/app_vbs.asp"-->
<!--#INCLUDE VIRTUAL = "/cfserverasp/source/header_vbs.asp"-->
<%
	' Variables declared here for the whole of the form
	Dim sSQL
	Dim i, lsColNum, liRow, j
	Dim sCmd, oRS, oCmd, rRS, MolRS

	Set oCmd = Server.CreateObject("ADODB.Command")
	Set oRS = Server.CreateObject("ADODB.Recordset")
	Set rRS = Server.CreateObject("ADODB.Recordset")
	Set MolRS = Server.CreateObject("ADODB.Recordset")
	
	' Use the COWS functions to retrieve the active connection to the database...
	Set DataConn=GetConnection(dbkey, formgroup, "Compound_Molecule")
	if DataConn.State=0 then ' assume user has been logged out
		DoLoggedOutMsg()
	end if
	' Use the COWS connection for our command object
	oCmd.ActiveConnection = DataConn
	oCmd.CommandType = adCmdText

	' There are two phases to this page - Phase 1 displays just the ExperimentType selector
	' Phase 2 displays a spreadsheet of results for that type of experiment...
	
	' Pick up whether this is called from the results of a search or not...
	if LCase(Request.QueryString("is_search")) = "true" Then
		' Get a list of the ID's to use from the Session variable in the 2nd part of the form.
		lbIsSearch = True
	end if

	if Request.Form("AssayName") = "" then
		' This is the start of Phase 1 - just display the request form
%>
<p><font face="Arial" size="2" color="Navy"><strong>Select BioReg Assay</strong></font></p>
<p><form METHOD="Post" ACTION="<%=Session("CurrentLocation" & dbkey & formgroup)%>" ID="frmAssayName" NAME="frmAssayName">
<font face="Arial" size="2" color="Navy">Select BioReg Assay : </font><select NAME="AssayName" SIZE="1">
<%on error resume next
		oCmd.CommandText = "SELECT KEY,NAME from CSBR_DB.ASSAY"

		Set oRS = oCmd.Execute
	'if Not err.number <> 0 then  ' don't do anything if bioassy query fails this likely measns it is not installed
		if oRS.EOF=True and oRS.BOF=True then
			Response.Write "<FONT FACE=""Arial"" COLOR=""Red"" SIZE=""3"">No Assays found.</FONT><BR>"
		else
			' Set up the SELECT choices...
			i=0
			do while not oRS.EOF
				if i=0 then
					Response.Write "<OPTION SELECTED VALUE=" & oRS("key").Value & ">" & oRS("name").Value & "</OPTION>"
				else
					Response.Write "<OPTION VALUE=" & oRS("key").Value & ">" & oRS("name").Value & "</OPTION>"
				end if
				i=i+1
				oRS.MoveNext
			loop
		end if
		oRS.Close
		Set oRS = Nothing
		Set oCmd = Nothing
%>
</select>
<input TYPE="Checkbox" ID="ShowStruct" NAME="ShowStruct" CHECKED="ON" Value="True"><font face="Arial" size="2" color="Navy">Show Structures?</font>
</p>
<p>
<input TYPE="Image" BORDER="0" ID="Submit" NAME="Submit" VALUE="Show SAR Table" SRC="/<%=Application("AppKey")%>/graphics/show_sartable_btn.gif">
</form></p>
<%
	else
%>
<script language="JScript" runat="server">
    function CountDims(arrVBArray) {
        return arrVBArray.dimensions();
    }
</script>
<%
		' This is Phase 2 - display the SAR Table for the selected assay
		
		' For now keep a list of the Corporate IDs locally - if this list is "" the we want all!!
		' lsIDList = "'CS-000001','CS-000002','CS-000003','CS-000005','CS-000006'"
		lsIDList = ""

		if lbIsSearch = True then
			Response.Write "<FONT FACE=""Arial"" COLOR=""Navy"" SIZE=""3"">Results filtered by previous search domain.</FONT><BR>"
			' Pick up the list of ID's from the Session variable
			loArray = Session("Base_RS" & dbkey & formgroup)
			if isArray(loArray) then
				liNumRecords   = UBound(loArray,2) + 1
				liStartRecords = LBound(loArray,2)
				liEndRecords   = UBound(loArray,2)
				
				' Now build the ID list from the Array in the Session variable
				lsIDs = ""
				for i = liStartRecords to liEndRecords
					if i=liStartRecords then
						lsIDs = loArray(0,i)
					else
						lsIDs = lsIDS & "," & loArray(0,i) 
					end if
				next
				
				if ST_debug=True then Response.Write "ID List is: " & lsIDs & "<BR>"
					
				' Convert this list of ID's to a set of Reg_Numbers
				sCmd = "SELECT ROOT_NUMBER from RegDB.Compound_Molecule WHERE cpd_database_counter IN (" & lsIDs & ")"
				oCmd.CommandText = sCmd
				Set oRS = oCmd.Execute
				if oRS.EOF=True and oRS.BOF=True then
					Response.Write "<FONT FACE=""Arial"" COLOR=""Red"" SIZE=""3"">Error retrieving Reg_Numbers from IDs</FONT><BR>"
				else
					i=0
					lsIDList=""
					do while not oRS.EOF=True
						' Build the list of Reg_Numbers
						if i=0 Then
							lsIDList = "'" & oRS.Fields("ROOT_NUMBER").Value & "'"
						else
							lsIDList = lsIDList & ",'" & oRS.Fields("ROOT_NUMBER").Value & "'"
						end if
						
						i=i+1
						oRS.MoveNext
					loop
						
					if ST_debug=True Then Response.Write "The Reg_Number list is: " & lsIDList & "<BR>"
				end if
				if oRS.State = adStateOpen then oRS.Close
				Set oRS = Nothing
			end if
		else
			Response.Write "<FONT FACE=""Arial"" COLOR=""Navy"" SIZE=""2"">Results for all compounds.</FONT><BR>"
		end if
		
		' Put in the link to get the next set of results.
		Response.Write "<A HREF=""" & Session("CurrentLocation" & dbkey & formgroup) & """>Show Another Set of Results</A><BR>"
		
		' Check if we requested structures to be shown or not
		lbShowStruct = Request.Form("ShowStruct")
		lbShowStruct = CBool(lbShowStruct)
		
		' Pick off the Assay name from the input form
		lsAssayKey = Request.Form("AssayName")

		' Turn this into Assay Name and Assay Root Values
		' Get the ROOT name of the view for this assay
		sCmd = "SELECT ROOT,NAME from CSBR_DB.ASSAY WHERE KEY=" & lsAssayKey

		if ST_debug = True Then
			Response.Write "Get Assay Root Name using: """ & sCmd & """<BR>"
		end if
		
		oCmd.CommandText = sCmd
		Set oRS = oCmd.Execute
		if oRS.EOF=True and oRS.BOF=True then
			Response.Write "<FONT FACE=""Arial"" COLOR=""Red"" SIZE=""3"">Error retrieving Assay View Name</FONT><BR>"
		else
			lsRootName = oRS("ROOT").Value
			lsAssayName = oRS("NAME").Value
			Response.Write "<FONT FACE=""Arial"" COLOR=""Navy"" SIZE=""3"">Results from assay " & lsAssayName & "</FONT><BR>"
		end if
		if oRS.State = adStateOpen then oRS.Close
		Set oRS = Nothing

		' Get the number of results for this assay - only need to carry on if this is > 0!
		' Now get the results from this particular assay and display as a spreadsheet.
		if lsIDList = "" Then
			sCmd = "SELECT COUNT(Corporate_ID) AS nResults"
			sCmd = sCmd & " FROM CSBR_DB." & lsRootName
		else
			sCmd = "SELECT COUNT(Corporate_ID) AS nResults"
			sCmd = sCmd & " FROM CSBR_DB." & lsRootName
			sCmd = sCmd & " WHERE Corporate_ID IN (" & lsIDList & ")"
		end if
			
		oCmd.CommandText = sCmd
		
		if ST_debug = True Then
			Response.Write "Count records using: """ & sCmd & """<BR>"
		end if
		
		Set oRS = oCmd.Execute
		
		if oRS.BOF = True and oRS.EOF = True Then
			Response.Write "<FONT FACE=""Arial"" COLOR=""Navy"" SIZE=""2"">Error counting Results for Assay: " & lsAssayName & "</FONT><BR>"
			nResults=0
		else
			nResults = oRS("nResults").Value
			nResults = CInt(nResults)
		end if
		if oRS.State = adStateOpen then oRS.Close
		Set oRS = Nothing

		' Only carry on if we have Results for this Assay...
		if nResults > 0 then
		
			' Now get the results from this particular assay and display as a spreadsheet.
			if lsIDList = "" Then
				sCmd = "SELECT * FROM CSBR_DB." & lsRootName
			else
				sCmd = "SELECT * FROM CSBR_DB." & lsRootName & " WHERE Corporate_ID IN (" & lsIDList & ")"
			end if
			
			if ST_debug = True Then
				Response.Write "Select data for assay using: """ & sCmd & """<BR>"
			end if
		
			oCmd.CommandText = sCmd
			Set oRS = oCmd.Execute
			if oRS.EOF=True and oRS.BOF=True then
				Response.Write "<FONT FACE=""Arial"" COLOR=""Red"" SIZE=""3"">Error retrieving results for assay " & lsAssayName & ".</FONT><BR>"
			else
				oRS.MoveFirst
				nFields = oRS.Fields.Count
				
				' Now we can write the table from the display array
				Response.Write "<BR><TABLE WIDTH=""600"" BORDER=""1"" CELLPADDING=""2"" CELLSPACING=""1"" BGCOLOR=""Navy"">"
				nResults = CInt(nResults)
				for i=0 to nResults
					Response.Write "<TR>"
					for j=0 to nFields-1 ' This is all of the data from the ASSAY
						if i=0 then ' Write the headers
							if j=0 and lbShowStruct=True then ' Showing Structures and in first column...
								Response.Write "<TH nowrap BGCOLOR=""Silver""><FONT FACE=""Arial"" COLOR=""Black"" SIZE=""2""><STRONG>Structure</STRONG></FONT></TH>"
								
								' Skip the internal fields in the display...
								if Not (UCase(oRS.Fields(j).Name) = "SUMMARY_ID" OR UCase(oRS.Fields(j).Name) = "SEQNUM") Then
									Response.Write "<TH nowrap BGCOLOR=""Silver""><FONT FACE=""Arial"" COLOR=""Black"" SIZE=""2""><STRONG>" & oRS.Fields(j).Name & "&nbsp;</STRONG></FONT></TH>"
								end if
							else
								if Not (UCase(oRS.Fields(j).Name) = "SUMMARY_ID" OR UCase(oRS.Fields(j).Name) = "SEQNUM") Then
									Response.Write "<TH nowrap BGCOLOR=""Silver""><FONT FACE=""Arial"" COLOR=""Black"" SIZE=""2""><STRONG>" & oRS.Fields(j).Name & "&nbsp;</STRONG></FONT></TH>"
								end if
							end if
						else ' Write the data
							if j=0 and lbShowStruct=True then ' Showing Structures and in first column...
								lsIntID = oRS("Corporate_ID").Value
								
								sCmd = "SELECT S.* FROM Structures S, Compound_Molecule C"
								sCmd = sCmd & " WHERE C.root_number='" & lsIntID & "'"
								sCmd = sCmd & " AND S.cpd_internal_id=C.cpd_database_counter"
								oCmd.CommandText = sCmd
								Set MolRS = oCmd.Execute
								Response.Write "<TD VALIGN=""center"" ALIGN=""center"" BGCOLOR=""White"">"
								ShowResult dbkey, formgroup, MolRS, "Structures.BASE64_CDX", "Base64CDX", 100, 100
								Response.Write "</TD>"
								
								if Not (UCase(oRS.Fields(j).Name) = "SUMMARY_ID" OR UCase(oRS.Fields(j).Name) = "SEQNUM") Then
									Response.Write "<TD nowrap BGCOLOR=""Silver""><FONT FACE=""Arial"" COLOR=""Black"" SIZE=""2"">" & oRS.Fields(j).Value & "&nbsp;</FONT></TD>"
								end if

								if MolRS.State = adStateOpen then MolRS.Close
								Set MolRS=Nothing
							else
								if Not (UCase(oRS.Fields(j).Name) = "SUMMARY_ID" OR UCase(oRS.Fields(j).Name) = "SEQNUM") Then
									Response.Write "<TD nowrap BGCOLOR=""Silver""><FONT FACE=""Arial"" COLOR=""Black"" SIZE=""2"">" & oRS.Fields(j).Value & "&nbsp;</FONT></TD>"
								end if
							end if
						end if
					next ' j loop over fields
					Response.Write "</TR>"
					
					' Only move onto the next record if we are NOT printing headers...
					if i>0 then oRS.MoveNext
				next ' i loop over records
				Response.Write "</TABLE>"
			end if
			if oRS.State = adStateOpen then oRS.Close
			Set oRS = Nothing
		else
			Response.Write "<FONT FACE=""Arial"" COLOR=""Navy"" SIZE=""2"">No results found for Assay " & lsAssayName & "</FONT><BR>"
		end if ' end of if nResults>0...
		' End of Phase 2...
		Response.Write "<BR><A HREF=""" & Session("CurrentLocation" & dbkey & formgroup) & """>Show Another Set of Results</A><BR>"
	end if ' End of if Request.Form()...
'end if ' don't do anything if bioassy query fails
%>
</body>
<%
	Set oRS=Nothing
	Set rRS=Nothing
	Set oCmd = Nothing
	CloseConn(DataConn)
%>
<!--#INCLUDE VIRTUAL = "/cfserverasp/source/input_form_footer_vbs.asp"-->
</html>
